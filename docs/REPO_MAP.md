# MuscleMap Repository Map

Generated by automated codebase analysis. This document maps the key components and their relationships.

## Project Structure

```
musclemap.me/
├── apps/
│   ├── api/              # Fastify API server (TypeScript)
│   │   ├── src/
│   │   │   ├── db/       # Database layer (PostgreSQL + Knex-style migrations)
│   │   │   │   ├── client.ts           # Database connection wrapper
│   │   │   │   ├── schema.ts           # Initial schema (base tables)
│   │   │   │   ├── migrations/         # 137+ incremental migrations
│   │   │   │   └── seeds/              # Data seeding
│   │   │   ├── graphql/  # GraphQL layer
│   │   │   │   ├── schema.ts           # Complete type definitions (3500+ lines)
│   │   │   │   ├── resolvers.ts        # All resolvers (~6000+ lines)
│   │   │   │   ├── loaders.ts          # DataLoaders for N+1 prevention
│   │   │   │   ├── cache.ts            # Response caching
│   │   │   │   └── complexity.ts       # Query complexity limits
│   │   │   ├── modules/  # Feature modules (39 total)
│   │   │   │   ├── economy/            # Credits, earning, payments
│   │   │   │   ├── prescription/       # AI workout prescription engine
│   │   │   │   ├── recovery/           # Sleep, HRV, recovery scores
│   │   │   │   ├── programs/           # Training programs
│   │   │   │   ├── mascot/             # Gamification mascot
│   │   │   │   └── ...
│   │   │   ├── http/     # HTTP routes (health, webhooks)
│   │   │   └── lib/      # Shared utilities
│   │   └── package.json
│   └── mobile/           # React Native + Expo app
├── packages/
│   ├── shared/           # Shared types and utilities
│   ├── core/             # Domain types, business logic
│   ├── client/           # API client SDK
│   ├── plugin-sdk/       # Plugin development kit
│   ├── ui/               # Cross-platform UI components
│   └── contracts/        # GraphQL schema types
├── src/                  # React web frontend (Vite)
├── scripts/              # Automation scripts (66 files)
└── docs/                 # Documentation (78 files)
```

## Database Architecture

### ORM/Migration Tool
- **Custom migration runner** in `apps/api/src/db/migrate.ts`
- Uses raw SQL via `pg` driver (not Knex, not Prisma)
- Migrations are TypeScript files with `migrate()` export

### Key Tables (Ground Truth)

#### Core User/Auth
- `users` - User accounts with archetypes, levels, roles
- `refresh_tokens` - JWT refresh tokens
- `credit_balances` - User credit balances
- `credit_ledger` - Transaction history

#### Exercise/Workout System
- `exercises` - 65+ exercises with difficulty, equipment, muscle targets
- `exercise_activations` - Muscle activation percentages per exercise
- `muscles` - Muscle definitions with recovery times
- `workouts` - Completed workout records (JSONB exercise_data)
- `workout_sets` - **Individual set tracking** (Migration 070)
- `active_workout_sessions` - In-progress workout state (Migration 119)

#### Programs & Prescriptions
- `prescriptions` - Generated workout prescriptions
- `training_programs` - Multi-week program templates
- `program_enrollments` - User's active programs

#### Economy
- `credit_balances` - Balance with optimistic locking
- `credit_ledger` - Complete transaction history
- `credit_actions` - Predefined credit costs
- `purchases` - Stripe payment records

### Migration Numbering
Latest: 137 (`137_exercise_image_contributions.ts`)

Key workout-related migrations:
- `070_enhanced_workout_tracking.ts` - Creates `workout_sets` table, progress photos, body measurements
- `092_rpe_rir_tracking.ts` - Adds RPE/RIR views and indexes
- `097_exercise_groups.ts` - Supersets, circuits, drop sets
- `119_active_workout_sessions.ts` - Server-side workout session persistence

## GraphQL API

### Endpoint
Single endpoint: `/api/graphql`

### Key Queries (Workout-Related)
```graphql
myWorkouts(limit, offset) → [Workout!]!
myWorkoutStats → WorkoutStats
myMuscleStats → MuscleStats
workout(id) → Workout
exerciseHistory(exerciseIds) → [ExerciseHistoryEntry!]!
```

### Key Mutations (Workout-Related)
```graphql
createWorkout(input) → WorkoutResult!
previewWorkout(input) → WorkoutPreview!
```

### Current Workout Type
```graphql
type Workout {
  id: ID!
  userId: ID!
  exercises: [WorkoutExercise!]!  # Stored as JSONB
  duration: Int
  notes: String
  totalTU: Int!
  characterStats: CharacterStats
  createdAt: DateTime!
}
```

## What Already Exists

| Component | Status | Location |
|-----------|--------|----------|
| 65+ exercises with muscle activation % | ✅ Live | `exercises`, `exercise_activations` tables |
| Prescription API | ✅ Live | `apps/api/src/modules/prescription/` |
| Credits system | ✅ Live | `apps/api/src/modules/economy/` |
| 3D muscle visualization | ✅ Live | `src/components/MuscleViewer/` |
| Equipment/location constraints | ✅ Live | Part of prescription engine |
| Archetypes (Judoka, Spartan, etc.) | ✅ Live | `archetypes` table + configs |
| Individual workout sets | ✅ Exists | `workout_sets` table (Migration 070) |
| Active workout sessions | ✅ Exists | `active_workout_sessions` table (Migration 119) |
| RPE/RIR tracking | ✅ Exists | Columns in `workout_sets`, views |

## What Needs Work

### Phase 1: Workout Logging (GraphQL Layer)
The database tables exist (`workout_sets`, `active_workout_sessions`) but the GraphQL mutations for real-time set logging don't exist:
- `startWorkoutSession` - Begin a workout
- `logSet` - Log individual sets in real-time
- `completeWorkoutSession` - Finish and persist workout

Current `createWorkout` mutation:
- Takes entire workout as batch (all exercises at once)
- Stores exercises as JSONB blob in `workouts.exercise_data`
- Doesn't use the normalized `workout_sets` table

### Phase 2: TU Calculation
The `calculateTU` function exists in resolvers but needs enhancement:
- Currently calculates workout-level TU
- Needs per-set, per-muscle TU tracking
- Needs to populate `session_muscle_tu` type views

### Phase 3: Exercise Substitution
Prescription engine has similarity scoring but no direct substitution API:
- Need `exerciseSubstitutions(exerciseId, constraints)` query
- Should leverage existing `exercise_activations` for muscle similarity

## Key Files

| Purpose | File |
|---------|------|
| Database client | `apps/api/src/db/client.ts` |
| GraphQL schema | `apps/api/src/graphql/schema.ts` |
| GraphQL resolvers | `apps/api/src/graphql/resolvers.ts` |
| Prescription engine | `apps/api/src/modules/prescription/index.ts` |
| Economy service | `apps/api/src/modules/economy/credit.service.ts` |
| Workout sets migration | `apps/api/src/db/migrations/070_enhanced_workout_tracking.ts` |
| Active sessions migration | `apps/api/src/db/migrations/119_active_workout_sessions.ts` |

## Development Commands

```bash
# Start development
pnpm dev

# Build all (use intelligent cache)
pnpm build:intelligent

# Run migrations
pnpm -C apps/api db:migrate

# Type check
pnpm typecheck

# Deploy to production
ssh -p 2222 root@musclemap.me "cd /var/www/musclemap.me && git pull && pnpm install && pnpm build:intelligent && pm2 restart musclemap"
```

## Production Server

- **SSH**: `ssh -p 2222 root@musclemap.me`
- **App Path**: `/var/www/musclemap.me`
- **PM2 Process**: `musclemap`
- **PostgreSQL**: `localhost:5432`
- **Redis**: `localhost:6379`
