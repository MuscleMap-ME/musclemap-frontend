#!/usr/bin/env bash
# ============================================
# MuscleMap CLI (mm) - Master Control Script
# ============================================
#
# Unified interactive command-line tool for all
# MuscleMap system administration tasks.
#
# Usage:
#   mm                    # Interactive menu mode
#   mm start              # Quick: start services
#   mm stop               # Quick: stop services
#   mm deploy             # Quick: deploy to production
#   mm status             # Quick: show system status
#   mm test               # Quick: run tests
#   mm <category>         # Category submenu
#
# Categories:
#   services, deploy, test, qa, docs, db, git
#
# Version: 2.0.0

set -euo pipefail

# ============================================
# CONFIGURATION
# ============================================

VERSION="2.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Source utilities
source "$SCRIPT_DIR/lib/ui-utils.sh"
# perf-utils requires bash 4+ for associative arrays; skip on older bash
if [[ "${BASH_VERSINFO[0]}" -ge 4 ]]; then
    source "$SCRIPT_DIR/lib/perf-utils.sh" 2>/dev/null || true
fi

# ============================================
# QUICK COMMANDS
# ============================================

cmd_start() {
    echo ""
    msg_step "Starting MuscleMap Services"
    "$SCRIPT_DIR/musclemap-start.sh" "$@"
}

cmd_stop() {
    echo ""
    msg_step "Stopping MuscleMap Services"
    "$SCRIPT_DIR/musclemap-stop.sh" --quiet "$@"
}

cmd_status() {
    echo ""
    msg_step "System Status"
    "$SCRIPT_DIR/musclemap-start.sh" --status

    echo ""
    msg_info "Git Status:"
    cd "$PROJECT_ROOT"
    git status --short 2>/dev/null || echo "  Not a git repository"

    echo ""
    msg_info "Last Commit:"
    git log -1 --oneline 2>/dev/null || echo "  No commits"
}

cmd_deploy() {
    echo ""
    msg_step "Deploying to Production"

    # Run pre-deploy checks first
    msg_info "Running pre-deploy checks..."
    if ! "$SCRIPT_DIR/pre-deploy-check.sh" --fast; then
        msg_error "Pre-deploy checks failed. Fix issues before deploying."
        return 1
    fi

    # Run deployment
    "$SCRIPT_DIR/deploy-branch.sh" --deploy "$@"
}

cmd_test() {
    echo ""
    msg_step "Running Tests"
    cd "$PROJECT_ROOT"

    if [[ "${1:-}" == "--e2e" ]]; then
        msg_info "Running E2E user journey test..."
        npx tsx scripts/e2e-user-journey.ts "${@:2}"
    elif [[ "${1:-}" == "--harness" ]]; then
        msg_info "Running test harness..."
        pnpm test:harness "${@:2}"
    else
        msg_info "Running unit tests..."
        pnpm test "$@"
    fi
}

cmd_build() {
    echo ""
    msg_step "Building Project"
    cd "$PROJECT_ROOT"
    pnpm build:intelligent
    msg_success "Build complete"
}

cmd_typecheck() {
    echo ""
    msg_step "Running TypeScript Checks"
    cd "$PROJECT_ROOT"
    pnpm typecheck
    msg_success "Typecheck passed"
}

# ============================================
# INTERACTIVE MENUS
# ============================================

menu_main() {
    while true; do
        clear_screen
        print_banner
        print_version "$VERSION"

        echo -e "  ${BOLD}Main Menu${NC}"
        echo ""
        menu_item "1" "Services" "Start, stop, manage local services"
        menu_item "2" "Deploy" "Deploy to production"
        menu_item "3" "Testing" "Run tests, E2E, harness"
        menu_item "4" "Quality" "Pre-deploy checks, warnings, cleanup"
        menu_item "5" "Docs" "Generate and manage documentation"
        menu_item "6" "Database" "Migrations, backups, queries"
        menu_item "7" "Git" "Merge worktrees, sync branches"
        menu_item "8" "Status" "Full system status report"
        echo ""
        menu_item "0" "Quick Actions" "Common task combinations"
        menu_item "h" "Help" "Show detailed help"
        menu_item "q" "Quit" "Exit MuscleMap CLI"
        echo ""

        echo -en "  ${CYAN}▸${NC} Select option: "
        read -rsn1 choice
        echo ""

        case "$choice" in
            1) menu_services ;;
            2) menu_deploy ;;
            3) menu_testing ;;
            4) menu_quality ;;
            5) menu_docs ;;
            6) menu_database ;;
            7) menu_git ;;
            8) cmd_status; press_continue ;;
            0) menu_quick_actions ;;
            h|H) show_help; press_continue ;;
            q|Q)
                echo ""
                msg_info "Goodbye!"
                exit 0
                ;;
            *)
                msg_warning "Invalid option: $choice"
                sleep 0.5
                ;;
        esac
    done
}

menu_services() {
    while true; do
        clear_screen
        echo ""
        echo -e "  ${BOLD}${BLUE}Services Management${NC}"
        echo ""
        menu_item "1" "Start All" "PostgreSQL, Redis, API, Vite"
        menu_item "2" "Start Core" "PostgreSQL + Redis only"
        menu_item "3" "Start + API" "Core services + API server"
        menu_item "4" "Start + Dev" "Core services + Vite dev server"
        menu_item "5" "Stop All" "Stop all MuscleMap services"
        menu_item "6" "Status" "Check which services are running"
        echo ""
        menu_item "b" "Back" "Return to main menu"
        echo ""

        echo -en "  ${CYAN}▸${NC} Select: "
        read -rsn1 choice
        echo ""

        case "$choice" in
            1) "$SCRIPT_DIR/musclemap-start.sh" --all; press_continue ;;
            2) "$SCRIPT_DIR/musclemap-start.sh"; press_continue ;;
            3) "$SCRIPT_DIR/musclemap-start.sh" --api; press_continue ;;
            4) "$SCRIPT_DIR/musclemap-start.sh" --dev; press_continue ;;
            5) "$SCRIPT_DIR/musclemap-stop.sh"; press_continue ;;
            6) "$SCRIPT_DIR/musclemap-start.sh" --status; press_continue ;;
            b|B|q) return ;;
            *) msg_warning "Invalid option"; sleep 0.5 ;;
        esac
    done
}

menu_deploy() {
    while true; do
        clear_screen
        echo ""
        echo -e "  ${BOLD}${BLUE}Deployment${NC}"
        echo ""
        menu_item "1" "Full Deploy" "Check → Build → Push → Deploy → Verify"
        menu_item "2" "Quick Deploy" "Skip checks, fast deploy"
        menu_item "3" "API Only" "Deploy API server changes only"
        menu_item "4" "Pre-Deploy Check" "Run all validation checks"
        menu_item "5" "Dry Run" "See what would happen"
        echo ""
        menu_item "6" "Create PR" "Push changes and create pull request"
        menu_item "7" "Merge PR" "Merge existing PR to main"
        echo ""
        menu_item "b" "Back" "Return to main menu"
        echo ""

        echo -en "  ${CYAN}▸${NC} Select: "
        read -rsn1 choice
        echo ""

        case "$choice" in
            1)
                msg_step "Full Deployment"
                "$SCRIPT_DIR/pre-deploy-check.sh"
                "$SCRIPT_DIR/deploy-branch.sh" --deploy
                press_continue
                ;;
            2)
                "$SCRIPT_DIR/deploy-branch.sh" --deploy --skip-tests
                press_continue
                ;;
            3)
                "$SCRIPT_DIR/deploy.sh"
                press_continue
                ;;
            4)
                "$SCRIPT_DIR/pre-deploy-check.sh"
                press_continue
                ;;
            5)
                "$SCRIPT_DIR/deploy-branch.sh" --dry-run
                press_continue
                ;;
            6)
                "$SCRIPT_DIR/deploy-branch.sh"
                press_continue
                ;;
            7)
                "$SCRIPT_DIR/deploy-branch.sh" --merge-now
                press_continue
                ;;
            b|B|q) return ;;
            *) msg_warning "Invalid option"; sleep 0.5 ;;
        esac
    done
}

menu_testing() {
    while true; do
        clear_screen
        echo ""
        echo -e "  ${BOLD}${BLUE}Testing${NC}"
        echo ""
        menu_item "1" "Unit Tests" "pnpm test"
        menu_item "2" "API Tests" "pnpm test:api"
        menu_item "3" "E2E Journey" "Full user journey test"
        menu_item "4" "E2E (Prod)" "E2E against production"
        menu_item "5" "Test Harness" "Full 230+ test suite"
        menu_item "6" "Typecheck" "TypeScript type checking"
        menu_item "7" "Lint" "Run linting"
        echo ""
        menu_item "b" "Back" "Return to main menu"
        echo ""

        echo -en "  ${CYAN}▸${NC} Select: "
        read -rsn1 choice
        echo ""

        cd "$PROJECT_ROOT"
        case "$choice" in
            1) pnpm test; press_continue ;;
            2) pnpm test:api; press_continue ;;
            3) npx tsx scripts/e2e-user-journey.ts; press_continue ;;
            4) npx tsx scripts/e2e-user-journey.ts --production; press_continue ;;
            5) pnpm test:harness; press_continue ;;
            6) pnpm typecheck; press_continue ;;
            7) pnpm lint; press_continue ;;
            b|B|q) return ;;
            *) msg_warning "Invalid option"; sleep 0.5 ;;
        esac
    done
}

menu_quality() {
    while true; do
        clear_screen
        echo ""
        echo -e "  ${BOLD}${BLUE}Quality Assurance${NC}"
        echo ""
        menu_item "1" "Pre-Deploy Check" "Full validation suite"
        menu_item "2" "Fast Check" "Quick validation (cached)"
        menu_item "3" "Warning Tracker" "Scan for code warnings"
        menu_item "4" "Cleanup" "Auto-fix code issues"
        menu_item "5" "Typecheck" "TypeScript validation"
        menu_item "6" "Lint Fix" "Run linter with auto-fix"
        echo ""
        menu_item "b" "Back" "Return to main menu"
        echo ""

        echo -en "  ${CYAN}▸${NC} Select: "
        read -rsn1 choice
        echo ""

        case "$choice" in
            1) "$SCRIPT_DIR/pre-deploy-check.sh"; press_continue ;;
            2) "$SCRIPT_DIR/pre-deploy-check.sh" --fast; press_continue ;;
            3) "$SCRIPT_DIR/warning-tracker.sh" scan; press_continue ;;
            4) "$SCRIPT_DIR/warning-tracker.sh" fix; press_continue ;;
            5) cd "$PROJECT_ROOT" && pnpm typecheck; press_continue ;;
            6) cd "$PROJECT_ROOT" && pnpm lint --fix; press_continue ;;
            b|B|q) return ;;
            *) msg_warning "Invalid option"; sleep 0.5 ;;
        esac
    done
}

menu_docs() {
    while true; do
        clear_screen
        echo ""
        echo -e "  ${BOLD}${BLUE}Documentation${NC}"
        echo ""
        menu_item "1" "Generate All" "Regenerate all documentation"
        menu_item "2" "Fast Generate" "Incremental doc generation"
        menu_item "3" "View Docs" "Open docs in browser"
        menu_item "4" "Competitive" "Run competitive analysis"
        echo ""
        menu_item "b" "Back" "Return to main menu"
        echo ""

        echo -en "  ${CYAN}▸${NC} Select: "
        read -rsn1 choice
        echo ""

        case "$choice" in
            1) node "$SCRIPT_DIR/generate-docs.cjs"; press_continue ;;
            2) node "$SCRIPT_DIR/generate-docs.cjs" --fast; press_continue ;;
            3)
                msg_info "Opening docs..."
                open "$PROJECT_ROOT/docs/" 2>/dev/null || xdg-open "$PROJECT_ROOT/docs/" 2>/dev/null || msg_warning "Could not open docs"
                press_continue
                ;;
            4) "$SCRIPT_DIR/competitive-analysis.sh" 2>/dev/null || msg_warning "Competitive analysis not available"; press_continue ;;
            b|B|q) return ;;
            *) msg_warning "Invalid option"; sleep 0.5 ;;
        esac
    done
}

menu_database() {
    while true; do
        clear_screen
        echo ""
        echo -e "  ${BOLD}${BLUE}Database Operations${NC}"
        echo ""
        menu_item "1" "Run Migrations" "Apply pending migrations"
        menu_item "2" "Migration Status" "Show migration status"
        menu_item "3" "Seed Database" "Populate with test data"
        menu_item "4" "Reset Database" "Drop and recreate (DANGER)"
        menu_item "5" "Backup" "Create database backup"
        menu_item "6" "Connect" "Open psql console"
        echo ""
        menu_item "b" "Back" "Return to main menu"
        echo ""

        echo -en "  ${CYAN}▸${NC} Select: "
        read -rsn1 choice
        echo ""

        cd "$PROJECT_ROOT"
        case "$choice" in
            1) pnpm -C apps/api db:migrate; press_continue ;;
            2) pnpm -C apps/api db:migrate:status 2>/dev/null || msg_warning "Status command not available"; press_continue ;;
            3) pnpm -C apps/api db:seed; press_continue ;;
            4)
                if confirm "This will DELETE all data. Are you sure?" "n"; then
                    pnpm -C apps/api db:reset 2>/dev/null || msg_warning "Reset command not available"
                fi
                press_continue
                ;;
            5)
                local backup_file="$PROJECT_ROOT/backups/db-$(date +%Y%m%d-%H%M%S).sql"
                mkdir -p "$PROJECT_ROOT/backups"
                pg_dump musclemap > "$backup_file" 2>/dev/null && msg_success "Backup saved to $backup_file" || msg_warning "Backup failed"
                press_continue
                ;;
            6) psql musclemap; press_continue ;;
            b|B|q) return ;;
            *) msg_warning "Invalid option"; sleep 0.5 ;;
        esac
    done
}

menu_git() {
    while true; do
        clear_screen
        echo ""
        echo -e "  ${BOLD}${BLUE}Git Operations${NC}"
        echo ""
        menu_item "1" "Merge All" "Merge all worktree branches"
        menu_item "2" "Status" "Show git status"
        menu_item "3" "Pull" "Pull latest from remote"
        menu_item "4" "Push" "Push to remote"
        menu_item "5" "Branches" "List all branches"
        menu_item "6" "Worktrees" "List all worktrees"
        echo ""
        menu_item "b" "Back" "Return to main menu"
        echo ""

        echo -en "  ${CYAN}▸${NC} Select: "
        read -rsn1 choice
        echo ""

        cd "$PROJECT_ROOT"
        case "$choice" in
            1) "$SCRIPT_DIR/merge-all.sh"; press_continue ;;
            2) git status; press_continue ;;
            3) git pull; press_continue ;;
            4) git push; press_continue ;;
            5) git branch -a; press_continue ;;
            6) git worktree list; press_continue ;;
            b|B|q) return ;;
            *) msg_warning "Invalid option"; sleep 0.5 ;;
        esac
    done
}

menu_quick_actions() {
    while true; do
        clear_screen
        echo ""
        echo -e "  ${BOLD}${YELLOW}Quick Actions${NC}"
        echo -e "  ${DIM}Common task combinations${NC}"
        echo ""
        menu_item "1" "Full Deploy Cycle" "check → build → deploy → verify"
        menu_item "2" "Dev Environment" "start services → run dev server"
        menu_item "3" "Pre-Commit" "typecheck → lint → test"
        menu_item "4" "Morning Startup" "pull → start → status"
        menu_item "5" "End of Day" "stop services"
        menu_item "6" "Fresh Start" "stop → clean → start"
        echo ""
        menu_item "b" "Back" "Return to main menu"
        echo ""

        echo -en "  ${CYAN}▸${NC} Select: "
        read -rsn1 choice
        echo ""

        cd "$PROJECT_ROOT"
        case "$choice" in
            1)
                msg_step "Full Deploy Cycle"
                msg_info "[1/4] Running pre-deploy checks..."
                "$SCRIPT_DIR/pre-deploy-check.sh" --fast || { msg_error "Checks failed"; press_continue; continue; }
                msg_info "[2/4] Building..."
                pnpm build:intelligent || { msg_error "Build failed"; press_continue; continue; }
                msg_info "[3/4] Deploying..."
                "$SCRIPT_DIR/deploy-branch.sh" --deploy || { msg_error "Deploy failed"; press_continue; continue; }
                msg_info "[4/4] Verifying..."
                curl -sf https://musclemap.me/health && msg_success "Site is live!" || msg_warning "Health check failed"
                press_continue
                ;;
            2)
                msg_step "Dev Environment Setup"
                msg_info "[1/2] Starting services..."
                "$SCRIPT_DIR/musclemap-start.sh" --all
                msg_info "[2/2] Services ready!"
                msg_success "Frontend: http://localhost:5173"
                msg_success "API: http://localhost:3001"
                press_continue
                ;;
            3)
                msg_step "Pre-Commit Checks"
                msg_info "[1/3] TypeScript..."
                pnpm typecheck || { msg_error "Typecheck failed"; press_continue; continue; }
                msg_info "[2/3] Linting..."
                pnpm lint || msg_warning "Lint warnings found"
                msg_info "[3/3] Tests..."
                pnpm test || { msg_error "Tests failed"; press_continue; continue; }
                msg_success "All checks passed!"
                press_continue
                ;;
            4)
                msg_step "Morning Startup"
                msg_info "[1/3] Pulling latest..."
                git pull || msg_warning "Pull failed"
                msg_info "[2/3] Starting services..."
                "$SCRIPT_DIR/musclemap-start.sh" --all
                msg_info "[3/3] Status check..."
                "$SCRIPT_DIR/musclemap-start.sh" --status
                press_continue
                ;;
            5)
                msg_step "End of Day"
                "$SCRIPT_DIR/musclemap-stop.sh" --quiet
                msg_success "All services stopped. Have a great evening!"
                press_continue
                ;;
            6)
                msg_step "Fresh Start"
                msg_info "[1/3] Stopping services..."
                "$SCRIPT_DIR/musclemap-stop.sh" --quiet
                msg_info "[2/3] Cleaning cache..."
                rm -rf node_modules/.cache .cache 2>/dev/null || true
                msg_info "[3/3] Starting fresh..."
                "$SCRIPT_DIR/musclemap-start.sh" --all
                msg_success "Fresh start complete!"
                press_continue
                ;;
            b|B|q) return ;;
            *) msg_warning "Invalid option"; sleep 0.5 ;;
        esac
    done
}

# ============================================
# HELP
# ============================================

show_help() {
    clear_screen
    print_banner

    echo -e "  ${BOLD}MuscleMap CLI - Help${NC}"
    echo ""
    echo -e "  ${CYAN}Quick Commands:${NC}"
    echo "    mm start              Start all services"
    echo "    mm stop               Stop all services"
    echo "    mm status             Show system status"
    echo "    mm deploy             Deploy to production"
    echo "    mm test               Run tests"
    echo "    mm build              Build all packages"
    echo "    mm typecheck          Run TypeScript checks"
    echo ""
    echo -e "  ${CYAN}Interactive Mode:${NC}"
    echo "    mm                    Launch interactive menu"
    echo "    mm services           Services submenu"
    echo "    mm qa                 Quality assurance submenu"
    echo "    mm docs               Documentation submenu"
    echo ""
    echo -e "  ${CYAN}Options:${NC}"
    echo "    --help, -h            Show this help"
    echo "    --version, -v         Show version"
    echo ""
    echo -e "  ${CYAN}Documentation:${NC}"
    echo "    Full docs: $PROJECT_ROOT/docs/SCRIPT-RESTRUCTURE-PLAN.md"
    echo "    CLAUDE.md: $PROJECT_ROOT/CLAUDE.md"
    echo ""
}

# ============================================
# UTILITIES
# ============================================

press_continue() {
    echo ""
    echo -en "  ${DIM}Press any key to continue...${NC}"
    read -rsn1
}

# ============================================
# MAIN ENTRY POINT
# ============================================

main() {
    # Handle command line arguments
    case "${1:-}" in
        "")
            # No args - interactive mode
            menu_main
            ;;
        start)
            shift
            cmd_start "$@"
            ;;
        stop)
            shift
            cmd_stop "$@"
            ;;
        status)
            shift
            cmd_status "$@"
            ;;
        deploy)
            shift
            cmd_deploy "$@"
            ;;
        test)
            shift
            cmd_test "$@"
            ;;
        build)
            shift
            cmd_build "$@"
            ;;
        typecheck)
            shift
            cmd_typecheck "$@"
            ;;
        services)
            menu_services
            ;;
        qa|quality)
            menu_quality
            ;;
        docs)
            menu_docs
            ;;
        db|database)
            menu_database
            ;;
        git)
            menu_git
            ;;
        quick|0)
            menu_quick_actions
            ;;
        -h|--help|help)
            show_help
            ;;
        -v|--version|version)
            echo "MuscleMap CLI v$VERSION"
            ;;
        *)
            msg_error "Unknown command: $1"
            echo ""
            echo "Run 'mm --help' for usage information."
            exit 1
            ;;
    esac
}

# Run main
main "$@"
