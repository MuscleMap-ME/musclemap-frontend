<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BuildNet Master Control Panel</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a25;
      --bg-quaternary: #22222f;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --accent: #0066ff;
      --accent-light: #3388ff;
      --accent-glow: rgba(0, 102, 255, 0.3);
      --success: #00cc66;
      --success-light: #00ff88;
      --warning: #ffaa00;
      --warning-light: #ffcc44;
      --error: #ff4444;
      --error-light: #ff6666;
      --purple: #8855ff;
      --cyan: #00cccc;
      --border: rgba(255, 255, 255, 0.1);
      --border-hover: rgba(255, 255, 255, 0.2);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--accent), #0044cc);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 0 30px var(--accent-glow);
    }

    .logo h1 {
      font-size: 26px;
      font-weight: 700;
      background: linear-gradient(135deg, #fff, #aaa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .logo h1 span {
      font-size: 12px;
      background: var(--accent);
      -webkit-background-clip: unset;
      -webkit-text-fill-color: unset;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 8px;
      vertical-align: middle;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: var(--bg-secondary);
      border-radius: 25px;
      border: 1px solid var(--border);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    .status-dot.error { background: var(--error); }
    .status-dot.warning { background: var(--warning); }

    @keyframes pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(0, 204, 102, 0.4); }
      50% { opacity: 0.8; box-shadow: 0 0 10px 3px rgba(0, 204, 102, 0.2); }
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      gap: 5px;
      background: var(--bg-secondary);
      padding: 5px;
      border-radius: 10px;
      border: 1px solid var(--border);
      margin-bottom: 25px;
      overflow-x: auto;
    }

    .nav-tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .nav-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-tab.active {
      background: var(--accent);
      color: white;
    }

    /* Time Period Selector */
    .time-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg-secondary);
      padding: 8px 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .time-selector label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .time-selector select {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      padding: 6px 10px;
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
    }

    /* Section Headers */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 30px 0 15px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title .icon {
      font-size: 20px;
    }

    /* Grid Layouts */
    .grid-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 25px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 25px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 25px;
    }

    .grid-2-1 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 25px;
    }

    /* Cards */
    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .card:hover {
      border-color: var(--border-hover);
    }

    .card.interactive:hover {
      border-color: var(--accent);
      box-shadow: 0 0 30px var(--accent-glow);
      transform: translateY(-2px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .card-title {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .card-value {
      font-size: 32px;
      font-weight: 700;
    }

    .card-value.small {
      font-size: 20px;
    }

    .card-value.success { color: var(--success); }
    .card-value.warning { color: var(--warning); }
    .card-value.error { color: var(--error); }
    .card-value.accent { color: var(--accent); }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 5px;
    }

    .card-change {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
    }

    .card-change.up {
      background: rgba(0, 204, 102, 0.2);
      color: var(--success);
    }

    .card-change.down {
      background: rgba(255, 68, 68, 0.2);
      color: var(--error);
    }

    /* Chart Containers */
    .chart-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 14px;
      font-weight: 600;
    }

    .chart-controls {
      display: flex;
      gap: 8px;
    }

    .chart-btn {
      padding: 5px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chart-btn:hover, .chart-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .chart-container {
      position: relative;
      height: 250px;
    }

    .chart-container.tall {
      height: 350px;
    }

    /* API Endpoints Widget */
    .endpoints-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .endpoint-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .endpoint-card:hover {
      border-color: var(--accent);
      background: var(--bg-quaternary);
    }

    .endpoint-method {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      min-width: 50px;
      text-align: center;
    }

    .endpoint-method.get { background: rgba(0, 204, 102, 0.2); color: var(--success); }
    .endpoint-method.post { background: rgba(0, 102, 255, 0.2); color: var(--accent); }
    .endpoint-method.delete { background: rgba(255, 68, 68, 0.2); color: var(--error); }

    .endpoint-info {
      flex: 1;
      min-width: 0;
    }

    .endpoint-path {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      word-break: break-all;
    }

    .endpoint-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .endpoint-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .endpoint-status.error { background: var(--error); }

    /* Packages Grid */
    .packages-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .package-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .package-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .package-card.building {
      border-color: var(--warning);
      animation: building-pulse 1.5s infinite;
    }

    @keyframes building-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255, 170, 0, 0.4); }
      50% { box-shadow: 0 0 25px 8px rgba(255, 170, 0, 0.15); }
    }

    .package-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .package-name {
      font-weight: 600;
      font-size: 15px;
    }

    .package-tier {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .tier-0 { background: rgba(0, 204, 102, 0.2); color: var(--success); }
    .tier-1 { background: rgba(0, 204, 102, 0.15); color: #00aa55; }
    .tier-2 { background: rgba(0, 102, 255, 0.2); color: var(--accent); }
    .tier-3 { background: rgba(255, 170, 0, 0.2); color: var(--warning); }
    .tier-4 { background: rgba(255, 68, 68, 0.2); color: var(--error); }

    .package-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 11px;
    }

    .package-stat {
      display: flex;
      flex-direction: column;
    }

    .package-stat-label {
      color: var(--text-muted);
      font-size: 10px;
    }

    .package-stat-value {
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Build History Table */
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }

    .history-table th {
      text-align: left;
      padding: 12px 15px;
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid var(--border);
    }

    .history-table td {
      padding: 12px 15px;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }

    .history-table tr:hover td {
      background: var(--bg-tertiary);
    }

    .history-table .status-badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .history-table .status-badge.success {
      background: rgba(0, 204, 102, 0.2);
      color: var(--success);
    }

    .history-table .status-badge.cached {
      background: rgba(0, 204, 102, 0.15);
      color: #00aa55;
    }

    .history-table .status-badge.failed {
      background: rgba(255, 68, 68, 0.2);
      color: var(--error);
    }

    /* Actions Bar */
    .actions-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
    }

    .btn-primary:hover {
      background: var(--accent-light);
      box-shadow: 0 0 25px var(--accent-glow);
    }

    .btn-danger {
      border-color: var(--error);
      color: var(--error);
    }

    .btn-danger:hover {
      background: var(--error);
      color: white;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 12px;
    }

    /* Console */
    .console {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .console-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
    }

    .console-title {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .console-title .live-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 1s infinite;
    }

    .console-body {
      height: 300px;
      overflow-y: auto;
      padding: 15px 20px;
      font-size: 12px;
      line-height: 1.8;
    }

    .console-line {
      white-space: pre-wrap;
      word-break: break-all;
    }

    .console-line.info { color: var(--text-secondary); }
    .console-line.success { color: var(--success); }
    .console-line.warning { color: var(--warning); }
    .console-line.error { color: var(--error); }

    .console-line .timestamp {
      color: var(--text-muted);
      margin-right: 10px;
    }

    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Config Panel */
    .config-panel {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .config-row {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .config-row:last-child {
      margin-bottom: 0;
    }

    .config-label {
      font-size: 13px;
      color: var(--text-secondary);
      min-width: 120px;
    }

    .config-input {
      flex: 1;
      max-width: 200px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 13px;
    }

    .checkbox-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .checkbox-item input {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      .grid-3 { grid-template-columns: repeat(2, 1fr); }
      .grid-2-1 { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .container { padding: 15px; }
      header { flex-direction: column; text-align: center; }
      .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
      .nav-tabs { flex-wrap: nowrap; justify-content: flex-start; }
      .actions-bar { justify-content: center; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-hover);
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <div class="logo">
        <div class="logo-icon">‚ö°</div>
        <h1>BuildNet Master<span>v0.1.0</span></h1>
      </div>
      <div class="header-controls">
        <div class="time-selector">
          <label>Period:</label>
          <select id="time-period" onchange="updateCharts()">
            <option value="1h">Last Hour</option>
            <option value="6h">Last 6 Hours</option>
            <option value="24h" selected>Last 24 Hours</option>
            <option value="7d">Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
            <option value="all">All Time</option>
          </select>
        </div>
        <div class="status-badge">
          <div class="status-dot" id="status-dot"></div>
          <span id="status-text">Connecting...</span>
        </div>
      </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="dashboard" onclick="switchTab('dashboard')">üìä Dashboard</button>
      <button class="nav-tab" data-tab="builds" onclick="switchTab('builds')">üî® Builds</button>
      <button class="nav-tab" data-tab="history" onclick="switchTab('history')">üìú History</button>
      <button class="nav-tab" data-tab="analytics" onclick="switchTab('analytics')">üìà Analytics</button>
      <button class="nav-tab" data-tab="endpoints" onclick="switchTab('endpoints')">üîå API Endpoints</button>
      <button class="nav-tab" data-tab="config" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="tab-dashboard" class="tab-content active">
      <!-- Stats Cards -->
      <div class="grid-4">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Total Builds</span>
            <span class="card-change up" id="builds-change">+0</span>
          </div>
          <div class="card-value accent" id="total-builds">-</div>
          <div class="card-subtitle">All time</div>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="card-title">Success Rate</span>
          </div>
          <div class="card-value success" id="success-rate">-</div>
          <div class="card-subtitle">Last 24 hours</div>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="card-title">Cache Size</span>
          </div>
          <div class="card-value" id="cache-size">-</div>
          <div class="card-subtitle"><span id="artifacts">-</span> artifacts</div>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="card-title">Avg Build Time</span>
          </div>
          <div class="card-value warning" id="avg-build-time">-</div>
          <div class="card-subtitle">Per package</div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid-2">
        <div class="chart-card">
          <div class="chart-header">
            <span class="chart-title">Build Timeline</span>
            <div class="chart-controls">
              <button class="chart-btn active" onclick="setTimelineView('line')">Line</button>
              <button class="chart-btn" onclick="setTimelineView('bar')">Bar</button>
            </div>
          </div>
          <div class="chart-container tall">
            <canvas id="timeline-chart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <span class="chart-title">Build Tier Distribution</span>
            <div class="chart-controls">
              <button class="chart-btn active" onclick="setTierView('pie')">Pie</button>
              <button class="chart-btn" onclick="setTierView('doughnut')">Doughnut</button>
            </div>
          </div>
          <div class="chart-container tall">
            <canvas id="tier-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- Build Times Bar Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <span class="chart-title">Build Times by Package</span>
          <div class="chart-controls">
            <button class="chart-btn active" onclick="setBuildTimeView('avg')">Average</button>
            <button class="chart-btn" onclick="setBuildTimeView('max')">Max</button>
            <button class="chart-btn" onclick="setBuildTimeView('min')">Min</button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="build-times-chart"></canvas>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="section-header">
        <span class="section-title"><span class="icon">üìã</span> Recent Builds</span>
        <button class="btn btn-sm" onclick="refreshHistory()">Refresh</button>
      </div>
      <div class="card">
        <table class="history-table" id="recent-builds-table">
          <thead>
            <tr>
              <th>Package</th>
              <th>Tier</th>
              <th>Status</th>
              <th>Duration</th>
              <th>Source Hash</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="recent-builds-body">
            <tr><td colspan="6" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Builds Tab -->
    <div id="tab-builds" class="tab-content">
      <div class="actions-bar">
        <button class="btn btn-primary" id="btn-build-all" onclick="buildAll()">
          <span>üî®</span> Build All Packages
        </button>
        <button class="btn" onclick="buildAll(true)">
          <span>üîÑ</span> Force Rebuild All
        </button>
        <button class="btn" onclick="refresh()">
          <span>üîÑ</span> Refresh Status
        </button>
        <button class="btn btn-danger" onclick="clearCache()">
          <span>üóëÔ∏è</span> Clear Cache
        </button>
      </div>

      <div class="section-header">
        <span class="section-title"><span class="icon">üì¶</span> Packages</span>
      </div>
      <div class="packages-grid" id="packages-grid">
        <!-- Packages will be inserted here -->
      </div>

      <div class="section-header">
        <span class="section-title"><span class="icon">üì∫</span> Live Build Output</span>
      </div>
      <div class="console">
        <div class="console-header">
          <span class="console-title">
            <span class="live-indicator"></span>
            Live Output
          </span>
          <button class="btn btn-sm" onclick="clearConsole()">Clear</button>
        </div>
        <div class="console-body" id="console-body">
          <div class="console-line info">Waiting for build events...</div>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div id="tab-history" class="tab-content">
      <div class="actions-bar">
        <button class="btn" onclick="refreshHistory()">
          <span>üîÑ</span> Refresh History
        </button>
        <button class="btn" onclick="exportHistory()">
          <span>üì•</span> Export CSV
        </button>
      </div>

      <div class="grid-3">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Total Builds</span>
          </div>
          <div class="card-value" id="history-total">-</div>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="card-title">Successful</span>
          </div>
          <div class="card-value success" id="history-success">-</div>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="card-title">Failed</span>
          </div>
          <div class="card-value error" id="history-failed">-</div>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <span class="chart-title">Build History Over Time</span>
        </div>
        <div class="chart-container tall">
          <canvas id="history-chart"></canvas>
        </div>
      </div>

      <div class="section-header">
        <span class="section-title"><span class="icon">üìú</span> Full Build History</span>
      </div>
      <div class="card">
        <table class="history-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Package</th>
              <th>Tier</th>
              <th>Status</th>
              <th>Duration</th>
              <th>Source Hash</th>
              <th>Output Hash</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody id="full-history-body">
            <tr><td colspan="8" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="tab-analytics" class="tab-content">
      <div class="grid-4">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Cache Hit Rate</span>
          </div>
          <div class="card-value success" id="cache-hit-rate">-</div>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="card-title">Instant Skips</span>
          </div>
          <div class="card-value" id="instant-skips">-</div>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="card-title">Full Rebuilds</span>
          </div>
          <div class="card-value warning" id="full-rebuilds">-</div>
        </div>
        <div class="card">
          <div class="card-header">
            <span class="card-title">Time Saved</span>
          </div>
          <div class="card-value accent" id="time-saved">-</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="chart-card">
          <div class="chart-header">
            <span class="chart-title">Build Status Distribution</span>
          </div>
          <div class="chart-container tall">
            <canvas id="status-pie-chart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <span class="chart-title">Package Build Frequency</span>
          </div>
          <div class="chart-container tall">
            <canvas id="frequency-chart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <span class="chart-title">Build Duration Trends</span>
        </div>
        <div class="chart-container tall">
          <canvas id="duration-trend-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- API Endpoints Tab -->
    <div id="tab-endpoints" class="tab-content">
      <div class="section-header">
        <span class="section-title"><span class="icon">üîå</span> Available API Endpoints</span>
        <button class="btn btn-sm" onclick="testAllEndpoints()">Test All</button>
      </div>

      <div class="endpoints-grid" id="endpoints-grid">
        <!-- Endpoints will be inserted here -->
      </div>

      <div class="section-header">
        <span class="section-title"><span class="icon">üìù</span> API Response</span>
      </div>
      <div class="console">
        <div class="console-header">
          <span class="console-title" id="api-response-title">Select an endpoint to test</span>
          <button class="btn btn-sm" onclick="clearApiResponse()">Clear</button>
        </div>
        <div class="console-body" id="api-response-body">
          <div class="console-line info">Click on an endpoint above to see its response</div>
        </div>
      </div>
    </div>

    <!-- Configuration Tab -->
    <div id="tab-config" class="tab-content">
      <div class="section-header">
        <span class="section-title"><span class="icon">‚öôÔ∏è</span> Dashboard Configuration</span>
      </div>

      <div class="config-panel">
        <div class="config-row">
          <span class="config-label">Auto-refresh:</span>
          <select class="config-input" id="config-refresh" onchange="updateConfig()">
            <option value="10">Every 10 seconds</option>
            <option value="30" selected>Every 30 seconds</option>
            <option value="60">Every minute</option>
            <option value="0">Disabled</option>
          </select>
        </div>
        <div class="config-row">
          <span class="config-label">Chart animations:</span>
          <input type="checkbox" id="config-animations" checked onchange="updateConfig()">
        </div>
        <div class="config-row">
          <span class="config-label">Show widgets:</span>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="checkbox" checked data-widget="timeline"> Timeline
            </label>
            <label class="checkbox-item">
              <input type="checkbox" checked data-widget="tier"> Tier Distribution
            </label>
            <label class="checkbox-item">
              <input type="checkbox" checked data-widget="build-times"> Build Times
            </label>
            <label class="checkbox-item">
              <input type="checkbox" checked data-widget="recent"> Recent Builds
            </label>
          </div>
        </div>
      </div>

      <div class="section-header">
        <span class="section-title"><span class="icon">üìä</span> Server Configuration</span>
      </div>

      <div class="card">
        <pre id="server-config" style="font-size: 12px; color: var(--text-secondary); overflow-x: auto;">Loading...</pre>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // Configuration
    // ============================================================================
    const pathMatch = window.location.pathname.match(/^(\/[^\/]+)/);
    const API_BASE = pathMatch && pathMatch[1] !== '/' ? pathMatch[1] : '';
    console.log('[BuildNet] API_BASE:', API_BASE, 'pathname:', window.location.pathname);

    let eventSource = null;
    let isBuilding = false;
    let charts = {};
    let buildHistory = [];
    let refreshInterval = null;

    const TIER_COLORS = {
      'InstantSkip': '#00cc66',
      'CacheRestore': '#00aa55',
      'MicroIncremental': '#0066ff',
      'SmartIncremental': '#ffaa00',
      'FullBuild': '#ff4444'
    };

    const TIER_NAMES = {
      'InstantSkip': 'Instant Skip',
      'CacheRestore': 'Cache Restore',
      'MicroIncremental': 'Micro Incremental',
      'SmartIncremental': 'Smart Incremental',
      'FullBuild': 'Full Build'
    };

    const API_ENDPOINTS = [
      { method: 'GET', path: '/health', desc: 'Health check' },
      { method: 'GET', path: '/status', desc: 'Daemon status' },
      { method: 'GET', path: '/stats', desc: 'State statistics' },
      { method: 'POST', path: '/build', desc: 'Build all packages' },
      { method: 'POST', path: '/build/{package}', desc: 'Build single package' },
      { method: 'GET', path: '/builds', desc: 'List build history' },
      { method: 'GET', path: '/builds/{id}', desc: 'Get build details' },
      { method: 'GET', path: '/cache/stats', desc: 'Cache statistics' },
      { method: 'POST', path: '/cache/clear', desc: 'Clear cache' },
      { method: 'GET', path: '/config', desc: 'Get configuration' },
      { method: 'GET', path: '/events', desc: 'SSE event stream' },
      { method: 'POST', path: '/shutdown', desc: 'Shutdown daemon' }
    ];

    // ============================================================================
    // Utility Functions
    // ============================================================================
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function formatDuration(ms) {
      if (ms === null || ms === undefined) return '-';
      if (ms < 1000) return ms + 'ms';
      if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
      return (ms / 60000).toFixed(1) + 'm';
    }

    function formatTime(timestamp) {
      if (!timestamp) return '-';
      const date = new Date(timestamp);
      return date.toLocaleTimeString();
    }

    function formatDateTime(timestamp) {
      if (!timestamp) return '-';
      const date = new Date(timestamp);
      return date.toLocaleString();
    }

    function getTierClass(tier) {
      const tiers = {
        'InstantSkip': 'tier-0',
        'CacheRestore': 'tier-1',
        'MicroIncremental': 'tier-2',
        'SmartIncremental': 'tier-3',
        'FullBuild': 'tier-4'
      };
      return tiers[tier] || 'tier-3';
    }

    function getStatusClass(status) {
      if (status === 'completed' || status === 'Completed') return 'success';
      if (status === 'cached' || status === 'Cached') return 'cached';
      if (status === 'failed' || status === 'Failed') return 'failed';
      return '';
    }

    // ============================================================================
    // Tab Navigation
    // ============================================================================
    function switchTab(tabId) {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(`tab-${tabId}`).classList.add('active');

      // Load tab-specific data
      if (tabId === 'history') refreshHistory();
      if (tabId === 'analytics') refreshAnalytics();
      if (tabId === 'endpoints') renderEndpoints();
      if (tabId === 'config') loadConfig();
    }

    // ============================================================================
    // Console Logging
    // ============================================================================
    function log(message, type = 'info') {
      const consoleBody = document.getElementById('console-body');
      const line = document.createElement('div');
      line.className = 'console-line ' + type;
      const time = new Date().toLocaleTimeString();
      line.innerHTML = '<span class="timestamp">[' + time + ']</span>' + message;
      consoleBody.appendChild(line);
      consoleBody.scrollTop = consoleBody.scrollHeight;
    }

    function clearConsole() {
      document.getElementById('console-body').innerHTML = '';
    }

    // ============================================================================
    // Data Fetching
    // ============================================================================
    async function fetchStatus() {
      try {
        const res = await fetch(API_BASE + '/status');
        const data = await res.json();

        document.getElementById('status-dot').className = 'status-dot';
        document.getElementById('status-text').textContent = 'Running';
        document.getElementById('total-builds').textContent = data.state_stats.total_builds;

        const successRate = data.state_stats.total_builds > 0
          ? Math.round(((data.state_stats.total_builds - data.state_stats.failed_builds) / data.state_stats.total_builds) * 100)
          : 100;
        document.getElementById('success-rate').textContent = successRate + '%';

        // Update packages grid
        updatePackagesGrid(data.packages);

        return data;
      } catch (err) {
        document.getElementById('status-dot').className = 'status-dot error';
        document.getElementById('status-text').textContent = 'Disconnected';
        throw err;
      }
    }

    async function fetchCacheStats() {
      try {
        const res = await fetch(API_BASE + '/cache/stats');
        const data = await res.json();
        document.getElementById('cache-size').textContent = formatBytes(data.total_size);
        document.getElementById('artifacts').textContent = data.artifact_count;
        return data;
      } catch (err) {
        console.error('Failed to fetch cache stats:', err);
      }
    }

    async function fetchBuildHistory() {
      try {
        const res = await fetch(API_BASE + '/builds');
        const data = await res.json();
        buildHistory = Array.isArray(data) ? data : [];
        return buildHistory;
      } catch (err) {
        console.error('Failed to fetch build history:', err);
        buildHistory = [];
        return [];
      }
    }

    async function fetchStats() {
      try {
        const res = await fetch(API_BASE + '/stats');
        return await res.json();
      } catch (err) {
        console.error('Failed to fetch stats:', err);
        return null;
      }
    }

    // ============================================================================
    // UI Updates
    // ============================================================================
    function updatePackagesGrid(packages) {
      const grid = document.getElementById('packages-grid');
      if (!packages || packages.length === 0) {
        grid.innerHTML = '<div style="color: var(--text-muted);">No packages found</div>';
        return;
      }

      grid.innerHTML = packages.map(pkg => `
        <div class="package-card" onclick="buildPackage('${pkg}')">
          <div class="package-header">
            <span class="package-name">${pkg}</span>
            <span class="package-tier tier-0">Ready</span>
          </div>
          <div class="package-stats">
            <div class="package-stat">
              <span class="package-stat-label">Last Build</span>
              <span class="package-stat-value">-</span>
            </div>
            <div class="package-stat">
              <span class="package-stat-label">Duration</span>
              <span class="package-stat-value">-</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateRecentBuilds(builds) {
      const tbody = document.getElementById('recent-builds-body');
      if (!builds || builds.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No builds yet</td></tr>';
        return;
      }

      const recentBuilds = builds.slice(-10).reverse();
      tbody.innerHTML = recentBuilds.map(b => `
        <tr>
          <td>${b.package_name || '-'}</td>
          <td><span class="package-tier ${getTierClass(b.tier)}">${b.tier || '-'}</span></td>
          <td><span class="status-badge ${getStatusClass(b.status)}">${b.status || '-'}</span></td>
          <td>${formatDuration(b.duration_ms)}</td>
          <td style="font-family: monospace; font-size: 11px;">${b.source_hash ? b.source_hash.substring(0, 8) : '-'}</td>
          <td>${formatTime(b.started_at)}</td>
        </tr>
      `).join('');
    }

    function updateFullHistory(builds) {
      const tbody = document.getElementById('full-history-body');
      if (!builds || builds.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted);">No builds yet</td></tr>';
        return;
      }

      tbody.innerHTML = builds.slice().reverse().map((b, i) => `
        <tr>
          <td>${builds.length - i}</td>
          <td>${b.package_name || '-'}</td>
          <td><span class="package-tier ${getTierClass(b.tier)}">${b.tier || '-'}</span></td>
          <td><span class="status-badge ${getStatusClass(b.status)}">${b.status || '-'}</span></td>
          <td>${formatDuration(b.duration_ms)}</td>
          <td style="font-family: monospace; font-size: 11px;">${b.source_hash ? b.source_hash.substring(0, 8) : '-'}</td>
          <td style="font-family: monospace; font-size: 11px;">${b.output_hash ? b.output_hash.substring(0, 8) : '-'}</td>
          <td>${formatDateTime(b.started_at)}</td>
        </tr>
      `).join('');
    }

    // ============================================================================
    // Charts
    // ============================================================================
    function initCharts() {
      // Timeline Chart
      const timelineCtx = document.getElementById('timeline-chart').getContext('2d');
      charts.timeline = new Chart(timelineCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Build Duration (ms)',
            data: [],
            borderColor: '#0066ff',
            backgroundColor: 'rgba(0, 102, 255, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#606070' }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#606070' }
            }
          }
        }
      });

      // Tier Distribution Chart
      const tierCtx = document.getElementById('tier-chart').getContext('2d');
      charts.tier = new Chart(tierCtx, {
        type: 'pie',
        data: {
          labels: Object.values(TIER_NAMES),
          datasets: [{
            data: [0, 0, 0, 0, 0],
            backgroundColor: Object.values(TIER_COLORS),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#a0a0b0', padding: 15 }
            }
          }
        }
      });

      // Build Times Chart
      const buildTimesCtx = document.getElementById('build-times-chart').getContext('2d');
      charts.buildTimes = new Chart(buildTimesCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Average Build Time (ms)',
            data: [],
            backgroundColor: [
              'rgba(0, 102, 255, 0.7)',
              'rgba(0, 204, 102, 0.7)',
              'rgba(255, 170, 0, 0.7)',
              'rgba(136, 85, 255, 0.7)',
              'rgba(0, 204, 204, 0.7)',
              'rgba(255, 68, 68, 0.7)'
            ],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: '#606070' }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#606070' }
            }
          }
        }
      });

      // History Chart
      const historyCtx = document.getElementById('history-chart').getContext('2d');
      charts.history = new Chart(historyCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Successful',
              data: [],
              borderColor: '#00cc66',
              backgroundColor: 'rgba(0, 204, 102, 0.1)',
              fill: true
            },
            {
              label: 'Failed',
              data: [],
              borderColor: '#ff4444',
              backgroundColor: 'rgba(255, 68, 68, 0.1)',
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#a0a0b0' }
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#606070' }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#606070' }
            }
          }
        }
      });

      // Status Pie Chart
      const statusPieCtx = document.getElementById('status-pie-chart').getContext('2d');
      charts.statusPie = new Chart(statusPieCtx, {
        type: 'doughnut',
        data: {
          labels: ['Completed', 'Cached', 'Failed'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#00cc66', '#00aa55', '#ff4444'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#a0a0b0', padding: 15 }
            }
          }
        }
      });

      // Frequency Chart
      const frequencyCtx = document.getElementById('frequency-chart').getContext('2d');
      charts.frequency = new Chart(frequencyCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Build Count',
            data: [],
            backgroundColor: 'rgba(136, 85, 255, 0.7)',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#606070' }
            },
            y: {
              grid: { display: false },
              ticks: { color: '#606070' }
            }
          }
        }
      });

      // Duration Trend Chart
      const durationTrendCtx = document.getElementById('duration-trend-chart').getContext('2d');
      charts.durationTrend = new Chart(durationTrendCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Avg Duration (ms)',
            data: [],
            borderColor: '#ffaa00',
            backgroundColor: 'rgba(255, 170, 0, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#606070' }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#606070' }
            }
          }
        }
      });
    }

    function updateCharts() {
      if (!buildHistory || buildHistory.length === 0) return;

      const period = document.getElementById('time-period').value;
      const filteredBuilds = filterBuildsByPeriod(buildHistory, period);

      // Timeline Chart
      const timelineData = filteredBuilds.slice(-50).map(b => ({
        x: b.started_at,
        y: b.duration_ms || 0
      }));
      charts.timeline.data.labels = timelineData.map(d => formatTime(d.x));
      charts.timeline.data.datasets[0].data = timelineData.map(d => d.y);
      charts.timeline.update();

      // Tier Distribution
      const tierCounts = {
        'InstantSkip': 0,
        'CacheRestore': 0,
        'MicroIncremental': 0,
        'SmartIncremental': 0,
        'FullBuild': 0
      };
      filteredBuilds.forEach(b => {
        if (tierCounts.hasOwnProperty(b.tier)) {
          tierCounts[b.tier]++;
        }
      });
      charts.tier.data.datasets[0].data = Object.values(tierCounts);
      charts.tier.update();

      // Build Times by Package
      const packageTimes = {};
      filteredBuilds.forEach(b => {
        if (!packageTimes[b.package_name]) {
          packageTimes[b.package_name] = [];
        }
        packageTimes[b.package_name].push(b.duration_ms || 0);
      });
      const avgTimes = Object.entries(packageTimes).map(([pkg, times]) => ({
        package: pkg,
        avg: times.reduce((a, b) => a + b, 0) / times.length
      }));
      charts.buildTimes.data.labels = avgTimes.map(p => p.package);
      charts.buildTimes.data.datasets[0].data = avgTimes.map(p => Math.round(p.avg));
      charts.buildTimes.update();

      // Calculate avg build time
      const totalDuration = filteredBuilds.reduce((sum, b) => sum + (b.duration_ms || 0), 0);
      const avgBuildTime = filteredBuilds.length > 0 ? totalDuration / filteredBuilds.length : 0;
      document.getElementById('avg-build-time').textContent = formatDuration(Math.round(avgBuildTime));

      // Update recent builds table
      updateRecentBuilds(filteredBuilds);
    }

    function filterBuildsByPeriod(builds, period) {
      if (period === 'all') return builds;

      const now = Date.now();
      const periodMs = {
        '1h': 60 * 60 * 1000,
        '6h': 6 * 60 * 60 * 1000,
        '24h': 24 * 60 * 60 * 1000,
        '7d': 7 * 24 * 60 * 60 * 1000,
        '30d': 30 * 24 * 60 * 60 * 1000
      };

      const cutoff = now - (periodMs[period] || periodMs['24h']);
      return builds.filter(b => {
        const buildTime = new Date(b.started_at).getTime();
        return buildTime >= cutoff;
      });
    }

    function setTimelineView(type) {
      document.querySelectorAll('.chart-card:first-child .chart-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      charts.timeline.config.type = type;
      charts.timeline.update();
    }

    function setTierView(type) {
      charts.tier.config.type = type;
      charts.tier.update();
    }

    function setBuildTimeView(type) {
      // Recalculate based on type (avg, max, min)
      const period = document.getElementById('time-period').value;
      const filteredBuilds = filterBuildsByPeriod(buildHistory, period);

      const packageTimes = {};
      filteredBuilds.forEach(b => {
        if (!packageTimes[b.package_name]) {
          packageTimes[b.package_name] = [];
        }
        packageTimes[b.package_name].push(b.duration_ms || 0);
      });

      const calcTimes = Object.entries(packageTimes).map(([pkg, times]) => {
        let value;
        if (type === 'avg') value = times.reduce((a, b) => a + b, 0) / times.length;
        else if (type === 'max') value = Math.max(...times);
        else value = Math.min(...times);
        return { package: pkg, value };
      });

      charts.buildTimes.data.datasets[0].data = calcTimes.map(p => Math.round(p.value));
      charts.buildTimes.data.datasets[0].label = `${type.charAt(0).toUpperCase() + type.slice(1)} Build Time (ms)`;
      charts.buildTimes.update();
    }

    // ============================================================================
    // History & Analytics
    // ============================================================================
    async function refreshHistory() {
      await fetchBuildHistory();
      updateFullHistory(buildHistory);

      // Update history stats
      const successful = buildHistory.filter(b => b.status === 'Completed' || b.status === 'completed' || b.status === 'Cached' || b.status === 'cached').length;
      const failed = buildHistory.filter(b => b.status === 'Failed' || b.status === 'failed').length;

      document.getElementById('history-total').textContent = buildHistory.length;
      document.getElementById('history-success').textContent = successful;
      document.getElementById('history-failed').textContent = failed;

      // Update history chart
      updateHistoryChart();
    }

    function updateHistoryChart() {
      if (!buildHistory || buildHistory.length === 0) return;

      // Group builds by hour
      const grouped = {};
      buildHistory.forEach(b => {
        const date = new Date(b.started_at);
        const hour = new Date(date.getFullYear(), date.getMonth(), date.getDate(), date.getHours()).toISOString();
        if (!grouped[hour]) {
          grouped[hour] = { success: 0, failed: 0 };
        }
        if (b.status === 'Completed' || b.status === 'completed' || b.status === 'Cached' || b.status === 'cached') {
          grouped[hour].success++;
        } else if (b.status === 'Failed' || b.status === 'failed') {
          grouped[hour].failed++;
        }
      });

      const sortedHours = Object.keys(grouped).sort();
      charts.history.data.labels = sortedHours.map(h => formatTime(h));
      charts.history.data.datasets[0].data = sortedHours.map(h => grouped[h].success);
      charts.history.data.datasets[1].data = sortedHours.map(h => grouped[h].failed);
      charts.history.update();
    }

    async function refreshAnalytics() {
      await fetchBuildHistory();
      const period = document.getElementById('time-period').value;
      const filteredBuilds = filterBuildsByPeriod(buildHistory, period);

      // Cache hit rate (InstantSkip + CacheRestore)
      const cacheHits = filteredBuilds.filter(b => b.tier === 'InstantSkip' || b.tier === 'CacheRestore').length;
      const cacheHitRate = filteredBuilds.length > 0 ? Math.round((cacheHits / filteredBuilds.length) * 100) : 0;
      document.getElementById('cache-hit-rate').textContent = cacheHitRate + '%';

      // Instant skips
      const instantSkips = filteredBuilds.filter(b => b.tier === 'InstantSkip').length;
      document.getElementById('instant-skips').textContent = instantSkips;

      // Full rebuilds
      const fullRebuilds = filteredBuilds.filter(b => b.tier === 'FullBuild').length;
      document.getElementById('full-rebuilds').textContent = fullRebuilds;

      // Time saved (estimate: full build ~60s, instant skip ~0s)
      const timeSaved = instantSkips * 60000 + filteredBuilds.filter(b => b.tier === 'CacheRestore').length * 50000;
      document.getElementById('time-saved').textContent = formatDuration(timeSaved);

      // Status pie chart
      const completed = filteredBuilds.filter(b => b.status === 'Completed' || b.status === 'completed').length;
      const cached = filteredBuilds.filter(b => b.status === 'Cached' || b.status === 'cached').length;
      const failed = filteredBuilds.filter(b => b.status === 'Failed' || b.status === 'failed').length;
      charts.statusPie.data.datasets[0].data = [completed, cached, failed];
      charts.statusPie.update();

      // Frequency chart
      const packageCounts = {};
      filteredBuilds.forEach(b => {
        packageCounts[b.package_name] = (packageCounts[b.package_name] || 0) + 1;
      });
      const sortedPackages = Object.entries(packageCounts).sort((a, b) => b[1] - a[1]);
      charts.frequency.data.labels = sortedPackages.map(p => p[0]);
      charts.frequency.data.datasets[0].data = sortedPackages.map(p => p[1]);
      charts.frequency.update();

      // Duration trend
      const durationByTime = filteredBuilds.slice(-30).map(b => ({
        time: formatTime(b.started_at),
        duration: b.duration_ms || 0
      }));
      charts.durationTrend.data.labels = durationByTime.map(d => d.time);
      charts.durationTrend.data.datasets[0].data = durationByTime.map(d => d.duration);
      charts.durationTrend.update();
    }

    function exportHistory() {
      const csv = [
        'ID,Package,Tier,Status,Duration (ms),Source Hash,Output Hash,Timestamp',
        ...buildHistory.map((b, i) =>
          `${i + 1},"${b.package_name}","${b.tier}","${b.status}",${b.duration_ms || 0},"${b.source_hash || ''}","${b.output_hash || ''}","${b.started_at}"`
        )
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `buildnet-history-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ============================================================================
    // API Endpoints
    // ============================================================================
    function renderEndpoints() {
      const grid = document.getElementById('endpoints-grid');
      grid.innerHTML = API_ENDPOINTS.map(ep => `
        <div class="endpoint-card" onclick="testEndpoint('${ep.method}', '${ep.path}')">
          <span class="endpoint-method ${ep.method.toLowerCase()}">${ep.method}</span>
          <div class="endpoint-info">
            <div class="endpoint-path">${ep.path}</div>
            <div class="endpoint-desc">${ep.desc}</div>
          </div>
          <div class="endpoint-status" id="endpoint-status-${ep.path.replace(/[^a-z]/gi, '')}"></div>
        </div>
      `).join('');
    }

    async function testEndpoint(method, path) {
      const responseTitle = document.getElementById('api-response-title');
      const responseBody = document.getElementById('api-response-body');

      responseTitle.textContent = `${method} ${API_BASE}${path}`;
      responseBody.innerHTML = '<div class="console-line info">Loading...</div>';

      try {
        const actualPath = path.replace('{package}', 'shared').replace('{id}', '1');
        const options = { method };

        if (method === 'POST') {
          options.headers = { 'Content-Type': 'application/json' };
          options.body = JSON.stringify({});
        }

        const start = performance.now();
        const res = await fetch(API_BASE + actualPath, options);
        const elapsed = Math.round(performance.now() - start);

        let data;
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          data = await res.json();
        } else {
          data = await res.text();
        }

        const statusClass = res.ok ? 'success' : 'error';
        responseBody.innerHTML = `
          <div class="console-line ${statusClass}">Status: ${res.status} ${res.statusText} (${elapsed}ms)</div>
          <div class="console-line info">Headers: ${[...res.headers.entries()].map(([k, v]) => `${k}: ${v}`).join(', ')}</div>
          <div class="console-line" style="margin-top: 10px;">Response:</div>
          <pre style="color: var(--text-secondary); margin-top: 5px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>
        `;

        // Update endpoint status indicator
        const statusEl = document.getElementById(`endpoint-status-${path.replace(/[^a-z]/gi, '')}`);
        if (statusEl) {
          statusEl.className = res.ok ? 'endpoint-status' : 'endpoint-status error';
        }
      } catch (err) {
        responseBody.innerHTML = `<div class="console-line error">Error: ${err.message}</div>`;
      }
    }

    async function testAllEndpoints() {
      for (const ep of API_ENDPOINTS.filter(e => e.method === 'GET' && !e.path.includes('{') && e.path !== '/events')) {
        await testEndpoint(ep.method, ep.path);
        await new Promise(r => setTimeout(r, 100));
      }
    }

    function clearApiResponse() {
      document.getElementById('api-response-title').textContent = 'Select an endpoint to test';
      document.getElementById('api-response-body').innerHTML = '<div class="console-line info">Click on an endpoint above to see its response</div>';
    }

    // ============================================================================
    // Configuration
    // ============================================================================
    async function loadConfig() {
      try {
        const res = await fetch(API_BASE + '/config');
        const data = await res.json();
        document.getElementById('server-config').textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        document.getElementById('server-config').textContent = 'Failed to load config: ' + err.message;
      }
    }

    function updateConfig() {
      const refreshSecs = parseInt(document.getElementById('config-refresh').value);

      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }

      if (refreshSecs > 0) {
        refreshInterval = setInterval(refresh, refreshSecs * 1000);
      }

      // Chart animations
      const animations = document.getElementById('config-animations').checked;
      Object.values(charts).forEach(chart => {
        chart.options.animation = animations ? {} : false;
        chart.update();
      });
    }

    // ============================================================================
    // Build Operations
    // ============================================================================
    async function buildAll(force = false) {
      if (isBuilding) return;

      isBuilding = true;
      const btn = document.getElementById('btn-build-all');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Building...';

      log('Starting build all' + (force ? ' (forced)' : '') + '...', 'info');

      try {
        const res = await fetch(API_BASE + '/build', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ force })
        });

        const data = await res.json();

        if (data.success) {
          log('Build completed successfully in ' + formatDuration(data.total_duration_ms), 'success');
        } else {
          log('Build completed with errors', 'error');
        }

        data.results.forEach(r => {
          const type = r.status === 'completed' || r.status === 'cached' ? 'success' : 'error';
          log(`  ${r.package}: ${r.tier} - ${r.status} (${formatDuration(r.duration_ms)})`, type);
          if (r.error) {
            log('    Error: ' + r.error, 'error');
          }
        });

        await refresh();

      } catch (err) {
        log('Build failed: ' + err.message, 'error');
      } finally {
        isBuilding = false;
        btn.disabled = false;
        btn.innerHTML = '<span>üî®</span> Build All Packages';
      }
    }

    async function buildPackage(name) {
      if (isBuilding) return;

      isBuilding = true;
      log('Building package: ' + name, 'info');

      const cards = document.querySelectorAll('.package-card');
      cards.forEach(card => {
        if (card.querySelector('.package-name').textContent === name) {
          card.classList.add('building');
        }
      });

      try {
        const res = await fetch(API_BASE + '/build/' + name, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ force: false })
        });

        const data = await res.json();

        const type = data.status === 'completed' || data.status === 'cached' ? 'success' : 'error';
        log(`${name}: ${data.tier} - ${data.status} (${formatDuration(data.duration_ms)})`, type);

        if (data.error) {
          log('Error: ' + data.error, 'error');
        }

        await refresh();

      } catch (err) {
        log('Build failed: ' + err.message, 'error');
      } finally {
        isBuilding = false;
        cards.forEach(card => card.classList.remove('building'));
      }
    }

    async function clearCache() {
      if (!confirm('Are you sure you want to clear the build cache?')) return;

      log('Clearing cache...', 'warning');

      try {
        const res = await fetch(API_BASE + '/cache/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await res.json();
        log('Cache cleared: ' + data.removed + ' artifacts removed', 'success');
        await fetchCacheStats();

      } catch (err) {
        log('Failed to clear cache: ' + err.message, 'error');
      }
    }

    // ============================================================================
    // Refresh & Events
    // ============================================================================
    async function refresh() {
      try {
        await Promise.all([fetchStatus(), fetchCacheStats(), fetchBuildHistory()]);
        updateCharts();
        log('Refreshed status', 'info');
      } catch (err) {
        console.error('Refresh failed:', err);
      }
    }

    function connectEvents() {
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource(API_BASE + '/events');

      eventSource.addEventListener('build_start', (e) => {
        const data = JSON.parse(e.data);
        log(data.message, 'info');
      });

      eventSource.addEventListener('build_complete', (e) => {
        const data = JSON.parse(e.data);
        log(data.message, 'success');
        refresh();
      });

      eventSource.addEventListener('error', () => {
        log('Event stream disconnected, reconnecting...', 'warning');
        setTimeout(connectEvents, 5000);
      });
    }

    // ============================================================================
    // Initialization
    // ============================================================================
    document.addEventListener('DOMContentLoaded', () => {
      initCharts();
      refresh();
      connectEvents();
      renderEndpoints();

      // Start auto-refresh
      refreshInterval = setInterval(refresh, 30000);
    });
  </script>
</body>
</html>
