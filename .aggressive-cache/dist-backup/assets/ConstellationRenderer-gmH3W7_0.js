import{_ as v}from"./index-DJKXoZu6.js";import{p as S,g}from"./MapExplore-B5f75waQ.js";import"./react-vendor-D1NxaRNd.js";import"./leaflet-vendor-DZbo3Ov0.js";import"./apollo-vendor-BMQ75Ycx.js";import"./reactflow-vendor-Dz2P_-Qa.js";import"./d3-vendor-mcDw60ct.js";import"./recharts-vendor-BziRPEEi.js";import"./building-2-D_VagxZp.js";import"./gauge-Bi9mhCam.js";import"./arrow-left-Br1tJfXa.js";import"./minimize-2-DNGvp5Et.js";class z{THREE=null;container=null;scene=null;camera=null;renderer=null;data=null;nodeSprites=new Map;connectionLines=[];starParticles=null;nebulaSprites=[];animationId=null;fps=60;frameCount=0;lastFrameTime=0;time=0;raycaster=null;mouse=null;onClickCallback=null;onHoverCallback=null;hoveredSprite=null;activeNodeId=null;width=0;height=0;async initialize(t,e){const i=S.start("constellationRenderer.init");this.THREE=await v(()=>import("./three-vendor-y9bq9ss_.js").then(o=>o.ax),[]),this.container=t,this.data=e,this.width=t.clientWidth,this.height=t.clientHeight,this.scene=new this.THREE.Scene,this.scene.background=new this.THREE.Color(328976);const s=this.width/this.height,r=2;this.camera=new this.THREE.OrthographicCamera(-r*s,r*s,r,-r,.1,100),this.camera.position.z=10,this.renderer=new this.THREE.WebGLRenderer({antialias:!0,powerPreference:"high-performance"}),this.renderer.setSize(this.width,this.height),this.renderer.setPixelRatio(g("high")),t.appendChild(this.renderer.domElement),this.raycaster=new this.THREE.Raycaster,this.raycaster.params.Sprite={threshold:.2},this.mouse=new this.THREE.Vector2,this.createStarField(),this.createNebulae(),this.createConstellationLines(),this.createNodeStars(),this.renderer.domElement.addEventListener("mousemove",this.handleMouseMove),this.renderer.domElement.addEventListener("click",this.handleClick),this.startRenderLoop(),i()}createStarField(){if(!this.THREE||!this.scene)return;const t=500,e=new Float32Array(t*3),i=new Float32Array(t*3),s=new Float32Array(t);for(let n=0;n<t;n++){e[n*3]=(Math.random()-.5)*8,e[n*3+1]=(Math.random()-.5)*6,e[n*3+2]=-1-Math.random()*2;const a=.3+Math.random()*.7,h=Math.random();h<.1?(i[n*3]=a,i[n*3+1]=a*.8,i[n*3+2]=a*.6):h<.2?(i[n*3]=a*.8,i[n*3+1]=a*.9,i[n*3+2]=a):(i[n*3]=a,i[n*3+1]=a,i[n*3+2]=a),s[n]=Math.random()*3+1}const r=new this.THREE.BufferGeometry;r.setAttribute("position",new this.THREE.BufferAttribute(e,3)),r.setAttribute("color",new this.THREE.BufferAttribute(i,3)),r.setAttribute("size",new this.THREE.BufferAttribute(s,1));const o=new this.THREE.PointsMaterial({size:.02,vertexColors:!0,transparent:!0,opacity:.8,blending:this.THREE.AdditiveBlending});this.starParticles=new this.THREE.Points(r,o),this.scene.add(this.starParticles)}createNebulae(){if(!this.THREE||!this.scene)return;const t=[new this.THREE.Color(26367),new this.THREE.Color(16724838),new this.THREE.Color(10181046)];for(let e=0;e<5;e++){const i=document.createElement("canvas");i.width=256,i.height=256;const s=i.getContext("2d"),r=t[e%t.length],o=s.createRadialGradient(128,128,0,128,128,128);o.addColorStop(0,`rgba(${Math.floor(r.r*255)}, ${Math.floor(r.g*255)}, ${Math.floor(r.b*255)}, 0.15)`),o.addColorStop(.5,`rgba(${Math.floor(r.r*255)}, ${Math.floor(r.g*255)}, ${Math.floor(r.b*255)}, 0.05)`),o.addColorStop(1,"rgba(0, 0, 0, 0)"),s.fillStyle=o,s.fillRect(0,0,256,256);const n=new this.THREE.CanvasTexture(i),a=new this.THREE.SpriteMaterial({map:n,transparent:!0,blending:this.THREE.AdditiveBlending}),h=new this.THREE.Sprite(a);h.position.set((Math.random()-.5)*6,(Math.random()-.5)*4,-3),h.scale.set(3+Math.random()*2,3+Math.random()*2,1),this.scene.add(h),this.nebulaSprites.push(h)}}createConstellationLines(){if(!this.THREE||!this.scene||!this.data)return;const t=new this.THREE.LineBasicMaterial({color:16777215,transparent:!0,opacity:.15,blending:this.THREE.AdditiveBlending});this.data.nodes.forEach(e=>{e.connections&&e.connections.forEach(i=>{const s=this.data.nodes.find(m=>m.id===i);if(!s||e.id>i)return;const r=(e.position.x-.5)*4,o=(e.position.y-.5)*3,n=(s.position.x-.5)*4,a=(s.position.y-.5)*3,h=[new this.THREE.Vector3(r,o,0),new this.THREE.Vector3(n,a,0)],l=new this.THREE.BufferGeometry().setFromPoints(h),c=new this.THREE.Line(l,t.clone());this.scene.add(c),this.connectionLines.push(c)})})}createNodeStars(){!this.THREE||!this.scene||!this.data||this.data.nodes.forEach(t=>{const e=document.createElement("canvas");e.width=64,e.height=64;const i=e.getContext("2d"),s=t.metadata?.color||"#ffffff",r=i.createRadialGradient(32,32,0,32,32,32);r.addColorStop(0,s),r.addColorStop(.2,s),r.addColorStop(.5,this.adjustColorAlpha(s,.5)),r.addColorStop(1,"rgba(0, 0, 0, 0)"),i.fillStyle=r,i.fillRect(0,0,64,64),i.fillStyle="#ffffff",i.beginPath();const o=32,n=32;for(let d=0;d<4;d++){const u=d/4*Math.PI*2-Math.PI/2,p=o+Math.cos(u)*12,E=n+Math.sin(u)*12;d===0?i.moveTo(p,E):i.lineTo(p,E);const f=u+Math.PI/4,R=o+Math.cos(f)*4,C=n+Math.sin(f)*4;i.lineTo(R,C)}i.closePath(),i.fill();const a=new this.THREE.CanvasTexture(e),h=new this.THREE.SpriteMaterial({map:a,transparent:!0,blending:this.THREE.AdditiveBlending}),l=new this.THREE.Sprite(h),c=(t.position.x-.5)*4,m=(t.position.y-.5)*3;l.position.set(c,m,0),l.scale.set(.3,.3,1),l.userData={node:t},this.scene.add(l),this.nodeSprites.set(t.id,l)})}adjustColorAlpha(t,e){const i=parseInt(t.slice(1,3),16),s=parseInt(t.slice(3,5),16),r=parseInt(t.slice(5,7),16);return`rgba(${i}, ${s}, ${r}, ${e})`}startRenderLoop=()=>{const t=e=>{this.frameCount++,e-this.lastFrameTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFrameTime=e),this.time=e*.001,this.updateAnimations(),this.renderer?.render(this.scene,this.camera),this.animationId=requestAnimationFrame(t)};this.animationId=requestAnimationFrame(t)};updateAnimations(){if(this.starParticles){const t=this.starParticles.geometry.getAttribute("size");for(let e=0;e<t.count;e++){const i=1+e%3;t.setX(e,i*(.7+.3*Math.sin(this.time*2+e*.5)))}t.needsUpdate=!0}this.nebulaSprites.forEach((t,e)=>{const i=3+Math.sin(this.time*.5+e)*.2;t.scale.set(i,i,1),t.material.opacity=.1+Math.sin(this.time*.3+e*2)*.05}),this.nodeSprites.forEach((t,e)=>{const i=t===this.hoveredSprite,s=e===this.activeNodeId;let r=.3;s?r=.5:i&&(r=.4);const o=1+Math.sin(this.time*3+e.charCodeAt(0))*.1,n=t.scale.x,a=n+(r*o-n)*.1;t.scale.set(a,a,1)}),this.connectionLines.forEach((t,e)=>{const i=.1+Math.sin(this.time+e*.5)*.05;t.material.opacity=i})}handleMouseMove=t=>{if(!this.renderer||!this.THREE)return;const e=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(t.clientX-e.left)/e.width*2-1,this.mouse.y=-((t.clientY-e.top)/e.height)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const i=this.raycaster.intersectObjects(Array.from(this.nodeSprites.values()));if(i.length>0){const s=i[0].object;s!==this.hoveredSprite&&(this.hoveredSprite=s,this.renderer.domElement.style.cursor="pointer",this.onHoverCallback?.(s.userData.node))}else this.hoveredSprite&&(this.hoveredSprite=null,this.renderer.domElement.style.cursor="default",this.onHoverCallback?.(null))};handleClick=()=>{this.hoveredSprite&&this.onClickCallback?.(this.hoveredSprite.userData.node)};setActiveNode(t){this.activeNodeId=t}setHighlightedCategory(t){this.nodeSprites.forEach(e=>{const i=e.userData.node,s=!t||i.category===t;e.material.opacity=s?1:.2})}setSearchFilter(t){const e=t.toLowerCase();this.nodeSprites.forEach(i=>{const s=i.userData.node,r=`${s.label} ${s.shortLabel||""} ${s.metadata?.description||""}`.toLowerCase(),o=!e||r.includes(e);i.material.opacity=o?1:.2})}resize(t,e){if(this.width=t,this.height=e,this.camera&&this.renderer){const i=t/e,s=2;this.camera.left=-s*i,this.camera.right=s*i,this.camera.top=s,this.camera.bottom=-s,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e)}}setQualityLevel(t){this.renderer&&this.renderer.setPixelRatio(g(t))}dispose(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.renderer&&(this.renderer.domElement.removeEventListener("mousemove",this.handleMouseMove),this.renderer.domElement.removeEventListener("click",this.handleClick),this.renderer.dispose(),this.container?.removeChild(this.renderer.domElement)),this.nodeSprites.clear(),this.connectionLines=[],this.nebulaSprites=[],this.scene=null,this.camera=null,this.renderer=null}onNodeClick(t){this.onClickCallback=t}onNodeHover(t){this.onHoverCallback=t}getFPS(){return this.fps}}export{z as ConstellationRenderer};
