var T=Object.defineProperty;var H=(d,t,e)=>t in d?T(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var n=(d,t,e)=>H(d,typeof t!="symbol"?t+"":t,e);import{_ as w}from"./index-Bo12JAoa.js";import{p as b,g as C}from"./MapExplore-DHUwAliy.js";import"./react-vendor-D847gc3Q.js";import"./leaflet-vendor-DZbo3Ov0.js";import"./apollo-vendor-BNHFeEEc.js";import"./reactflow-vendor-5ig9bY2l.js";import"./d3-vendor-DkU_Wy0v.js";import"./recharts-vendor-d8oTApeF.js";import"./building-2-Ck-riQIA.js";import"./gauge-okefstbw.js";import"./arrow-left-eLIo_F92.js";import"./minimize-2-GuTDUm8f.js";class _{constructor(){n(this,"THREE",null);n(this,"container",null);n(this,"scene",null);n(this,"camera",null);n(this,"renderer",null);n(this,"data",null);n(this,"nodeSprites",new Map);n(this,"connectionLines",[]);n(this,"starParticles",null);n(this,"nebulaSprites",[]);n(this,"animationId",null);n(this,"fps",60);n(this,"frameCount",0);n(this,"lastFrameTime",0);n(this,"time",0);n(this,"raycaster",null);n(this,"mouse",null);n(this,"onClickCallback",null);n(this,"onHoverCallback",null);n(this,"hoveredSprite",null);n(this,"activeNodeId",null);n(this,"width",0);n(this,"height",0);n(this,"startRenderLoop",()=>{const t=e=>{this.frameCount++,e-this.lastFrameTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFrameTime=e),this.time=e*.001,this.updateAnimations(),this.renderer?.render(this.scene,this.camera),this.animationId=requestAnimationFrame(t)};this.animationId=requestAnimationFrame(t)});n(this,"handleMouseMove",t=>{if(!this.renderer||!this.THREE)return;const e=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(t.clientX-e.left)/e.width*2-1,this.mouse.y=-((t.clientY-e.top)/e.height)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const i=this.raycaster.intersectObjects(Array.from(this.nodeSprites.values()));if(i.length>0){const s=i[0].object;s!==this.hoveredSprite&&(this.hoveredSprite=s,this.renderer.domElement.style.cursor="pointer",this.onHoverCallback?.(s.userData.node))}else this.hoveredSprite&&(this.hoveredSprite=null,this.renderer.domElement.style.cursor="default",this.onHoverCallback?.(null))});n(this,"handleClick",()=>{this.hoveredSprite&&this.onClickCallback?.(this.hoveredSprite.userData.node)})}async initialize(t,e){const i=b.start("constellationRenderer.init");this.THREE=await w(()=>import("./three-vendor-y9bq9ss_.js").then(h=>h.ax),[]),this.container=t,this.data=e,this.width=t.clientWidth,this.height=t.clientHeight,this.scene=new this.THREE.Scene,this.scene.background=new this.THREE.Color(328976);const s=this.width/this.height,r=2;this.camera=new this.THREE.OrthographicCamera(-r*s,r*s,r,-r,.1,100),this.camera.position.z=10,this.renderer=new this.THREE.WebGLRenderer({antialias:!0,powerPreference:"high-performance"}),this.renderer.setSize(this.width,this.height),this.renderer.setPixelRatio(C("high")),t.appendChild(this.renderer.domElement),this.raycaster=new this.THREE.Raycaster,this.raycaster.params.Sprite={threshold:.2},this.mouse=new this.THREE.Vector2,this.createStarField(),this.createNebulae(),this.createConstellationLines(),this.createNodeStars(),this.renderer.domElement.addEventListener("mousemove",this.handleMouseMove),this.renderer.domElement.addEventListener("click",this.handleClick),this.startRenderLoop(),i()}createStarField(){if(!this.THREE||!this.scene)return;const t=500,e=new Float32Array(t*3),i=new Float32Array(t*3),s=new Float32Array(t);for(let a=0;a<t;a++){e[a*3]=(Math.random()-.5)*8,e[a*3+1]=(Math.random()-.5)*6,e[a*3+2]=-1-Math.random()*2;const o=.3+Math.random()*.7,l=Math.random();l<.1?(i[a*3]=o,i[a*3+1]=o*.8,i[a*3+2]=o*.6):l<.2?(i[a*3]=o*.8,i[a*3+1]=o*.9,i[a*3+2]=o):(i[a*3]=o,i[a*3+1]=o,i[a*3+2]=o),s[a]=Math.random()*3+1}const r=new this.THREE.BufferGeometry;r.setAttribute("position",new this.THREE.BufferAttribute(e,3)),r.setAttribute("color",new this.THREE.BufferAttribute(i,3)),r.setAttribute("size",new this.THREE.BufferAttribute(s,1));const h=new this.THREE.PointsMaterial({size:.02,vertexColors:!0,transparent:!0,opacity:.8,blending:this.THREE.AdditiveBlending});this.starParticles=new this.THREE.Points(r,h),this.scene.add(this.starParticles)}createNebulae(){if(!this.THREE||!this.scene)return;const t=[new this.THREE.Color(26367),new this.THREE.Color(16724838),new this.THREE.Color(10181046)];for(let e=0;e<5;e++){const i=document.createElement("canvas");i.width=256,i.height=256;const s=i.getContext("2d"),r=t[e%t.length],h=s.createRadialGradient(128,128,0,128,128,128);h.addColorStop(0,`rgba(${Math.floor(r.r*255)}, ${Math.floor(r.g*255)}, ${Math.floor(r.b*255)}, 0.15)`),h.addColorStop(.5,`rgba(${Math.floor(r.r*255)}, ${Math.floor(r.g*255)}, ${Math.floor(r.b*255)}, 0.05)`),h.addColorStop(1,"rgba(0, 0, 0, 0)"),s.fillStyle=h,s.fillRect(0,0,256,256);const a=new this.THREE.CanvasTexture(i),o=new this.THREE.SpriteMaterial({map:a,transparent:!0,blending:this.THREE.AdditiveBlending}),l=new this.THREE.Sprite(o);l.position.set((Math.random()-.5)*6,(Math.random()-.5)*4,-3),l.scale.set(3+Math.random()*2,3+Math.random()*2,1),this.scene.add(l),this.nebulaSprites.push(l)}}createConstellationLines(){if(!this.THREE||!this.scene||!this.data)return;const t=new this.THREE.LineBasicMaterial({color:16777215,transparent:!0,opacity:.15,blending:this.THREE.AdditiveBlending});this.data.nodes.forEach(e=>{e.connections&&e.connections.forEach(i=>{const s=this.data.nodes.find(p=>p.id===i);if(!s||e.id>i)return;const r=(e.position.x-.5)*4,h=(e.position.y-.5)*3,a=(s.position.x-.5)*4,o=(s.position.y-.5)*3,l=[new this.THREE.Vector3(r,h,0),new this.THREE.Vector3(a,o,0)],c=new this.THREE.BufferGeometry().setFromPoints(l),m=new this.THREE.Line(c,t.clone());this.scene.add(m),this.connectionLines.push(m)})})}createNodeStars(){!this.THREE||!this.scene||!this.data||this.data.nodes.forEach(t=>{const e=document.createElement("canvas");e.width=64,e.height=64;const i=e.getContext("2d"),s=t.metadata?.color||"#ffffff",r=i.createRadialGradient(32,32,0,32,32,32);r.addColorStop(0,s),r.addColorStop(.2,s),r.addColorStop(.5,this.adjustColorAlpha(s,.5)),r.addColorStop(1,"rgba(0, 0, 0, 0)"),i.fillStyle=r,i.fillRect(0,0,64,64),i.fillStyle="#ffffff",i.beginPath();const h=32,a=32;for(let u=0;u<4;u++){const E=u/4*Math.PI*2-Math.PI/2,f=h+Math.cos(E)*12,g=a+Math.sin(E)*12;u===0?i.moveTo(f,g):i.lineTo(f,g);const R=E+Math.PI/4,v=h+Math.cos(R)*4,S=a+Math.sin(R)*4;i.lineTo(v,S)}i.closePath(),i.fill();const o=new this.THREE.CanvasTexture(e),l=new this.THREE.SpriteMaterial({map:o,transparent:!0,blending:this.THREE.AdditiveBlending}),c=new this.THREE.Sprite(l),m=(t.position.x-.5)*4,p=(t.position.y-.5)*3;c.position.set(m,p,0),c.scale.set(.3,.3,1),c.userData={node:t},this.scene.add(c),this.nodeSprites.set(t.id,c)})}adjustColorAlpha(t,e){const i=parseInt(t.slice(1,3),16),s=parseInt(t.slice(3,5),16),r=parseInt(t.slice(5,7),16);return`rgba(${i}, ${s}, ${r}, ${e})`}updateAnimations(){if(this.starParticles){const t=this.starParticles.geometry.getAttribute("size");for(let e=0;e<t.count;e++){const i=1+e%3;t.setX(e,i*(.7+.3*Math.sin(this.time*2+e*.5)))}t.needsUpdate=!0}this.nebulaSprites.forEach((t,e)=>{const i=3+Math.sin(this.time*.5+e)*.2;t.scale.set(i,i,1),t.material.opacity=.1+Math.sin(this.time*.3+e*2)*.05}),this.nodeSprites.forEach((t,e)=>{const i=t===this.hoveredSprite,s=e===this.activeNodeId;let r=.3;s?r=.5:i&&(r=.4);const h=1+Math.sin(this.time*3+e.charCodeAt(0))*.1,a=t.scale.x,o=a+(r*h-a)*.1;t.scale.set(o,o,1)}),this.connectionLines.forEach((t,e)=>{const i=.1+Math.sin(this.time+e*.5)*.05;t.material.opacity=i})}setActiveNode(t){this.activeNodeId=t}setHighlightedCategory(t){this.nodeSprites.forEach(e=>{const i=e.userData.node,s=!t||i.category===t;e.material.opacity=s?1:.2})}setSearchFilter(t){const e=t.toLowerCase();this.nodeSprites.forEach(i=>{const s=i.userData.node,r=`${s.label} ${s.shortLabel||""} ${s.metadata?.description||""}`.toLowerCase(),h=!e||r.includes(e);i.material.opacity=h?1:.2})}resize(t,e){if(this.width=t,this.height=e,this.camera&&this.renderer){const i=t/e,s=2;this.camera.left=-s*i,this.camera.right=s*i,this.camera.top=s,this.camera.bottom=-s,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e)}}setQualityLevel(t){this.renderer&&this.renderer.setPixelRatio(C(t))}dispose(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.renderer&&(this.renderer.domElement.removeEventListener("mousemove",this.handleMouseMove),this.renderer.domElement.removeEventListener("click",this.handleClick),this.renderer.dispose(),this.container?.removeChild(this.renderer.domElement)),this.nodeSprites.clear(),this.connectionLines=[],this.nebulaSprites=[],this.scene=null,this.camera=null,this.renderer=null}onNodeClick(t){this.onClickCallback=t}onNodeHover(t){this.onHoverCallback=t}getFPS(){return this.fps}}export{_ as ConstellationRenderer};
