import{r as n,j as e,h as re}from"./react-vendor-D847gc3Q.js";import{G as ne,Z as T,A as z,m as S,aF as le,aE as G,N as R,J as ie}from"./index-CF1yimBQ.js";import{S as oe}from"./SEO-B-NXRDHI.js";import{L as v}from"./loader-circle-Cl_7-Fdo.js";import{R as $,T as g}from"./terminal-DIOt0BR7.js";import{S as W}from"./square-BzPyfi7b.js";import{R as Z}from"./refresh-cw-CJ2h9qCb.js";import{F as ce}from"./funnel-BuhZ2a1y.js";import{D as de}from"./download-DjVnTbDp.js";import{C as me}from"./chevron-down-DFuHOTsV.js";import{C as xe}from"./chevron-right-BT5_SqyT.js";import{C as he}from"./copy-BTsz1fgJ.js";import{C as V}from"./circle-x-CoUr_xSj.js";import{E as pe}from"./external-link-DHvDFtwr.js";import{P as A}from"./package-3_zOg_VX.js";import{C as ue}from"./cpu-jAtFqj_g.js";import{H as je}from"./hard-drive-BF4Ukn93.js";import{C as X}from"./circle-check-big-C1cis7IV.js";import{D as ge}from"./database-gKyw1Fcg.js";import{S as fe}from"./server-DIMf9m8y.js";import{G as _}from"./git-branch-BAxx3vj9.js";import{T as ye}from"./triangle-alert-C3dqg7SR.js";import"./leaflet-vendor-DZbo3Ov0.js";import"./apollo-vendor-BNHFeEEc.js";import"./reactflow-vendor-CYb5nRwM.js";import"./d3-vendor-mcDw60ct.js";import"./recharts-vendor-CxtoZpzE.js";const Q="";async function j(s,l={}){const c=localStorage.getItem("musclemap_token");return fetch(`${Q}${s}`,{...l,headers:{...l.headers,Authorization:`Bearer ${c}`,"Content-Type":"application/json"}})}function I({status:s}){const l={pending:{color:"text-yellow-400",icon:e.jsx(ie,{className:"w-3 h-3"}),bg:"bg-yellow-500/20"},running:{color:"text-blue-400",icon:e.jsx(v,{className:"w-3 h-3 animate-spin"}),bg:"bg-blue-500/20"},success:{color:"text-green-400",icon:e.jsx(X,{className:"w-3 h-3"}),bg:"bg-green-500/20"},failed:{color:"text-red-400",icon:e.jsx(V,{className:"w-3 h-3"}),bg:"bg-red-500/20"},timeout:{color:"text-orange-400",icon:e.jsx(ye,{className:"w-3 h-3"}),bg:"bg-orange-500/20"},cancelled:{color:"text-gray-400",icon:e.jsx(W,{className:"w-3 h-3"}),bg:"bg-gray-500/20"}},{color:c,icon:t,bg:m}=l[s]||l.pending;return e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium ${c} ${m}`,children:[t,s]})}function be({command:s,onExecute:l,disabled:c,loading:t}){const m={"git-pull":e.jsx(_,{className:"w-4 h-4"}),"git-status":e.jsx(_,{className:"w-4 h-4"}),"git-log":e.jsx(_,{className:"w-4 h-4"}),"pnpm-install":e.jsx(A,{className:"w-4 h-4"}),"build-packages":e.jsx(A,{className:"w-4 h-4"}),"build-api":e.jsx(fe,{className:"w-4 h-4"}),"build-frontend":e.jsx(T,{className:"w-4 h-4"}),"build-all":e.jsx($,{className:"w-4 h-4"}),"pm2-restart":e.jsx(Z,{className:"w-4 h-4"}),"pm2-status":e.jsx(G,{className:"w-4 h-4"}),"pm2-logs":e.jsx(g,{className:"w-4 h-4"}),"db-migrate":e.jsx(ge,{className:"w-4 h-4"}),"health-check":e.jsx(X,{className:"w-4 h-4"}),"disk-usage":e.jsx(je,{className:"w-4 h-4"}),"memory-usage":e.jsx(ue,{className:"w-4 h-4"}),typecheck:e.jsx(R,{className:"w-4 h-4"}),lint:e.jsx(R,{className:"w-4 h-4"})};return e.jsxs("button",{onClick:()=>l(s.key),disabled:c||t,className:`
        flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium
        transition-all duration-200 active:scale-95
        ${s.dangerous?"bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/30":"bg-white/5 text-gray-300 hover:bg-white/10 border border-white/10"}
        disabled:opacity-50 disabled:cursor-not-allowed
      `,children:[t?e.jsx(v,{className:"w-4 h-4 animate-spin"}):m[s.key]||e.jsx(g,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:s.description}),e.jsx("span",{className:"sm:hidden",children:s.key.split("-").pop()})]})}function Ne({sequence:s,onExecute:l,disabled:c,loading:t,isActive:m}){const[x,h]=n.useState(!1),E={"full-deploy":e.jsx($,{className:"w-5 h-5"}),"quick-deploy":e.jsx(T,{className:"w-5 h-5"}),"frontend-deploy":e.jsx(A,{className:"w-5 h-5"}),"safe-check":e.jsx(R,{className:"w-5 h-5"}),"system-status":e.jsx(G,{className:"w-5 h-5"})},k={"full-deploy":"from-purple-500 to-pink-500","quick-deploy":"from-blue-500 to-cyan-500","frontend-deploy":"from-green-500 to-emerald-500","safe-check":"from-yellow-500 to-orange-500","system-status":"from-gray-500 to-slate-500"};return e.jsx(S.div,{layout:!0,className:`
        rounded-xl border overflow-hidden transition-all duration-300
        ${m?"border-blue-500/50 bg-blue-500/10 ring-2 ring-blue-500/30":"border-white/10 bg-white/5 hover:border-white/20"}
      `,children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg bg-gradient-to-br ${k[s.key]||"from-gray-500 to-slate-500"}`,children:E[s.key]||e.jsx(g,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-white",children:s.name}),e.jsx("p",{className:"text-sm text-gray-400",children:s.description})]})]}),e.jsx("button",{onClick:()=>l(s.key),disabled:c||t,className:`
              px-4 py-2 rounded-lg font-medium text-sm
              bg-gradient-to-r ${k[s.key]||"from-gray-500 to-slate-500"}
              text-white shadow-lg hover:shadow-xl
              transition-all duration-200 active:scale-95
              disabled:opacity-50 disabled:cursor-not-allowed
            `,children:m?e.jsx(v,{className:"w-4 h-4 animate-spin"}):e.jsx(le,{className:"w-4 h-4"})})]}),e.jsxs("button",{onClick:()=>h(!x),className:"flex items-center gap-1 mt-3 text-xs text-gray-500 hover:text-gray-400",children:[x?e.jsx(me,{className:"w-3 h-3"}):e.jsx(xe,{className:"w-3 h-3"}),s.steps.length," steps"]}),e.jsx(z,{children:x&&e.jsx(S.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden",children:e.jsx("div",{className:"mt-2 pl-2 border-l-2 border-white/10 space-y-1",children:s.steps.map((r,u)=>e.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-2",children:[e.jsx("span",{className:"w-4 text-center text-gray-600",children:u+1}),e.jsx("code",{className:"font-mono",children:r})]},r))})})})]})})}function we({output:s,status:l,onClear:c}){const t=n.useRef(null);n.useEffect(()=>{t.current&&(t.current.scrollTop=t.current.scrollHeight)},[s]);const m=()=>{navigator.clipboard.writeText(s.join(""))};return e.jsxs("div",{className:"rounded-xl border border-white/10 bg-black/50 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-white/5 border-b border-white/10",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"text-sm font-medium text-gray-300",children:"Output"}),l&&e.jsx(I,{status:l})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:m,className:"p-1.5 rounded hover:bg-white/10 text-gray-400 hover:text-white transition-colors",title:"Copy output",children:e.jsx(he,{className:"w-4 h-4"})}),e.jsx("button",{onClick:c,className:"p-1.5 rounded hover:bg-white/10 text-gray-400 hover:text-white transition-colors",title:"Clear output",children:e.jsx(V,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{ref:t,className:"h-80 overflow-auto p-4 font-mono text-xs text-green-400 whitespace-pre-wrap",children:[s.length===0?e.jsx("span",{className:"text-gray-600",children:"Waiting for deployment output..."}):s.map((x,h)=>e.jsx("span",{className:x.includes("Error")||x.includes("error")?"text-red-400":"",children:x},h)),l==="running"&&e.jsx("span",{className:"inline-block w-2 h-4 bg-green-400 animate-pulse ml-1"})]})]})}function ve({logs:s,onViewDetails:l,loading:c}){return c?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(v,{className:"w-8 h-8 animate-spin text-gray-400"})}):s.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(g,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No deployment logs yet"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-xs text-gray-500 border-b border-white/10",children:[e.jsx("th",{className:"pb-3 font-medium",children:"ID"}),e.jsx("th",{className:"pb-3 font-medium",children:"Command/Sequence"}),e.jsx("th",{className:"pb-3 font-medium",children:"Status"}),e.jsx("th",{className:"pb-3 font-medium",children:"Source"}),e.jsx("th",{className:"pb-3 font-medium",children:"Duration"}),e.jsx("th",{className:"pb-3 font-medium",children:"Time"}),e.jsx("th",{className:"pb-3 font-medium"})]})}),e.jsx("tbody",{className:"text-sm",children:s.map(t=>e.jsxs("tr",{className:"border-b border-white/5 hover:bg-white/5 cursor-pointer transition-colors",onClick:()=>l(t),children:[e.jsxs("td",{className:"py-3 font-mono text-xs text-gray-400",children:[t.id.slice(0,16),"..."]}),e.jsx("td",{className:"py-3",children:e.jsx("span",{className:"font-medium text-white",children:t.sequence_key||t.command_key||"Unknown"})}),e.jsx("td",{className:"py-3",children:e.jsx(I,{status:t.status})}),e.jsx("td",{className:"py-3 text-gray-400",children:t.initiated_by}),e.jsx("td",{className:"py-3 text-gray-400",children:t.duration_ms?`${(t.duration_ms/1e3).toFixed(1)}s`:"-"}),e.jsx("td",{className:"py-3 text-gray-400",children:new Date(t.started_at).toLocaleString()}),e.jsx("td",{className:"py-3",children:e.jsx(pe,{className:"w-4 h-4 text-gray-500"})})]},t.id))})]})})}function ke({log:s,onClose:l}){const[c,t]=n.useState(null),[m,x]=n.useState(!1);return n.useEffect(()=>{s&&(x(!0),j(`/api/deploy/logs/${s.id}`).then(h=>h.json()).then(h=>t(h.data)).finally(()=>x(!1)))},[s]),s?e.jsx(S.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80",onClick:l,children:e.jsxs(S.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},className:"w-full max-w-4xl max-h-[80vh] bg-gray-900 rounded-2xl border border-white/10 overflow-hidden",onClick:h=>h.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-white/10",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-white",children:s.sequence_key||s.command_key}),e.jsx("p",{className:"text-sm text-gray-400 font-mono",children:s.id})]}),e.jsx(I,{status:s.status})]}),e.jsxs("div",{className:"p-4 space-y-4 overflow-auto max-h-[60vh]",children:[e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Source"}),e.jsx("p",{className:"text-sm text-white",children:s.initiated_by})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"IP"}),e.jsx("p",{className:"text-sm text-white font-mono",children:s.initiator_ip})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Duration"}),e.jsx("p",{className:"text-sm text-white",children:s.duration_ms?`${(s.duration_ms/1e3).toFixed(2)}s`:"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Exit Code"}),e.jsx("p",{className:"text-sm text-white",children:s.exit_code??"-"})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Output"}),m?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(v,{className:"w-6 h-6 animate-spin text-gray-400"})}):e.jsx("pre",{className:"p-4 bg-black/50 rounded-lg text-xs font-mono text-green-400 overflow-auto max-h-80 whitespace-pre-wrap",children:c?.output||"No output"})]})]}),e.jsx("div",{className:"p-4 border-t border-white/10 flex justify-end",children:e.jsx("button",{onClick:l,className:"px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20 transition-colors",children:"Close"})})]})}):null}function Ke(){const{user:s,hasHydrated:l}=ne(),[c,t]=n.useState([]),[m,x]=n.useState([]),[h,E]=n.useState([]),[k,r]=n.useState([]),[u,C]=n.useState(null),[O,N]=n.useState(null),[P,F]=n.useState(null),[Y,U]=n.useState(!0),[q,B]=n.useState(null),[D,H]=n.useState("deploy"),M=n.useRef(null);n.useEffect(()=>{j("/api/deploy/commands").then(a=>a.json()).then(a=>{t(a.data.commands),x(a.data.sequences)}).catch(console.error)},[]);const f=n.useCallback(()=>{U(!0),j("/api/deploy/logs?limit=50").then(a=>a.json()).then(a=>E(a.data.logs)).catch(console.error).finally(()=>U(!1))},[]);n.useEffect(()=>{f()},[f]),n.useEffect(()=>()=>{M.current?.close()},[]);const K=async a=>{F(a),r([`> Executing: ${a}
`]);try{const d=await(await j("/api/deploy/execute",{method:"POST",body:JSON.stringify({command:a})})).json();d.data?r(p=>[...p,d.data.output||"",`
Exit code: ${d.data.exitCode}
`]):r(p=>[...p,`Error: ${d.error?.message||"Unknown error"}
`]),f()}catch(y){r(d=>[...d,`Error: ${y instanceof Error?y.message:"Unknown error"}
`])}finally{F(null)}},ee=async a=>{N(a),r([`> Starting sequence: ${a}
`]);try{const d=await(await j("/api/deploy/execute",{method:"POST",body:JSON.stringify({sequence:a})})).json();if(d.data?.deploymentId){const p=d.data.deploymentId;C(p),r(w=>[...w,`Deployment ID: ${p}
`,`Connecting to stream...

`]);const te=localStorage.getItem("musclemap_token"),ae=`${Q}/api/deploy/stream/${p}?token=${encodeURIComponent(te||"")}`,b=new EventSource(ae);M.current=b,b.onopen=()=>{r(w=>[...w,`[Connected to stream]

`])},b.onmessage=w=>{try{const o=JSON.parse(w.data);switch(o.type){case"start":r(i=>[...i,`Starting ${o.sequence}...
`]);break;case"history":r(i=>[...i,o.output||""]);break;case"step-start":r(i=>[...i,`
--- ${o.command}: ${o.description} ---
`]);break;case"output":r(i=>[...i,o.chunk||""]);break;case"complete":r(i=>[...i,`
[${o.command}] Exit: ${o.exitCode} (${o.duration}ms)
`]);break;case"sequence-complete":r(i=>[...i,`
=== ${o.success?"SUCCESS":"FAILED"} (${o.duration}ms) ===
`]),C(null),N(null),b.close(),f();break;case"cancelled":r(i=>[...i,`
=== CANCELLED ===
`]),C(null),N(null),b.close(),f();break}}catch{}},b.onerror=w=>{r(o=>[...o,`
[Stream error - connection lost]
`]),setTimeout(async()=>{try{const i=await(await j(`/api/deploy/status?id=${p}`)).json();if(i.data&&!i.data.isActive){const J=await(await j(`/api/deploy/logs/${p}`)).json();J.data?.output&&r(L=>[...L,`
--- Final Output ---
`,J.data.output]),r(L=>[...L,`
=== ${i.data.status==="success"?"SUCCESS":"FAILED"} ===
`]),C(null),N(null),f()}}catch{}},2e3),b.close()}}else d.error&&(r(p=>[...p,`Error: ${d.error.message||"Unknown error"}
`]),N(null))}catch(y){r(d=>[...d,`Error: ${y instanceof Error?y.message:"Unknown error"}
`]),N(null)}},se=async()=>{if(u)try{await j(`/api/deploy/cancel/${u}`,{method:"POST"})}catch{}};return l?!s||!s.is_admin?e.jsx(re,{to:"/dashboard",replace:!0}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{title:"Deployment Control",description:"MuscleMap deployment management portal"}),e.jsxs("div",{className:"min-h-screen bg-[#0a0a0f] text-white",children:[e.jsx("header",{className:"border-b border-white/10 bg-black/50 backdrop-blur-xl sticky top-0 z-40",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500",children:e.jsx($,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold",children:"Deployment Control"}),e.jsx("p",{className:"text-sm text-gray-400",children:"MuscleMap Production Server"})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[u&&e.jsxs("button",{onClick:se,className:"flex items-center gap-2 px-4 py-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors",children:[e.jsx(W,{className:"w-4 h-4"}),"Cancel"]}),e.jsx("button",{onClick:f,className:"p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors",title:"Refresh",children:e.jsx(Z,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{className:"flex gap-1 mt-4",children:[e.jsxs("button",{onClick:()=>H("deploy"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${D==="deploy"?"bg-white/10 text-white":"text-gray-400 hover:text-white hover:bg-white/5"}`,children:[e.jsx($,{className:"w-4 h-4 inline-block mr-2"}),"Deploy"]}),e.jsxs("button",{onClick:()=>H("logs"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${D==="logs"?"bg-white/10 text-white":"text-gray-400 hover:text-white hover:bg-white/5"}`,children:[e.jsx(g,{className:"w-4 h-4 inline-block mr-2"}),"Logs"]})]})]})}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 py-6",children:D==="deploy"?e.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("section",{children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(T,{className:"w-5 h-5 text-yellow-400"}),"Deployment Sequences"]}),e.jsx("div",{className:"space-y-3",children:m.map(a=>e.jsx(Ne,{sequence:a,onExecute:ee,disabled:!!u||!!P,loading:O===a.key,isActive:O===a.key},a.key))})]}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(g,{className:"w-5 h-5 text-blue-400"}),"Individual Commands"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:c.map(a=>e.jsx(be,{command:a,onExecute:K,disabled:!!u,loading:P===a.key},a.key))})]})]}),e.jsx("div",{children:e.jsx(we,{output:k,status:u?"running":null,onClear:()=>r([])})})]}):e.jsxs("div",{className:"bg-white/5 rounded-xl border border-white/10 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(g,{className:"w-5 h-5"}),"Deployment History"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors",children:e.jsx(ce,{className:"w-4 h-4"})}),e.jsx("button",{className:"p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors",children:e.jsx(de,{className:"w-4 h-4"})})]})]}),e.jsx(ve,{logs:h,onViewDetails:B,loading:Y})]})}),e.jsx(z,{children:q&&e.jsx(ke,{log:q,onClose:()=>B(null)})})]})]}):e.jsx("div",{className:"min-h-screen bg-[#0a0a0f] flex items-center justify-center",children:e.jsx(v,{className:"w-8 h-8 animate-spin text-gray-400"})})}export{Ke as default};
