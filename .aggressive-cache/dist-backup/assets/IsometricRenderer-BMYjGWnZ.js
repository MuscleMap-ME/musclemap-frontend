var v=Object.defineProperty;var y=(E,e,t)=>e in E?v(E,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):E[e]=t;var r=(E,e,t)=>y(E,typeof e!="symbol"?e+"":e,t);import{_ as C}from"./index-DXxw33y3.js";import{p as b,g}from"./MapExplore-B2qiaE5y.js";import"./react-vendor-D847gc3Q.js";import"./leaflet-vendor-DZbo3Ov0.js";import"./apollo-vendor-BNHFeEEc.js";import"./reactflow-vendor-5ig9bY2l.js";import"./d3-vendor-DkU_Wy0v.js";import"./recharts-vendor-d8oTApeF.js";import"./building-2-B1wirvew.js";import"./gauge-BMvTlQEG.js";import"./arrow-left-D7Jg5X_q.js";import"./minimize-2-DJH6f2wX.js";class N{constructor(){r(this,"THREE",null);r(this,"container",null);r(this,"scene",null);r(this,"camera",null);r(this,"renderer",null);r(this,"data",null);r(this,"roomGroups",new Map);r(this,"roomMeshes",new Map);r(this,"labelSprites",new Map);r(this,"animationId",null);r(this,"fps",60);r(this,"frameCount",0);r(this,"lastFrameTime",0);r(this,"time",0);r(this,"raycaster",null);r(this,"mouse",null);r(this,"onClickCallback",null);r(this,"onHoverCallback",null);r(this,"hoveredMesh",null);r(this,"activeNodeId",null);r(this,"width",0);r(this,"height",0);r(this,"cameraTarget",{x:0,y:0});r(this,"startRenderLoop",()=>{const e=t=>{this.frameCount++,t-this.lastFrameTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFrameTime=t),this.time=t*.001,this.updateAnimations(),this.renderer?.render(this.scene,this.camera),this.animationId=requestAnimationFrame(e)};this.animationId=requestAnimationFrame(e)});r(this,"handleMouseMove",e=>{if(!this.renderer||!this.THREE)return;const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const i=Array.from(this.roomMeshes.values()),s=this.raycaster.intersectObjects(i,!0);let o=null;for(const a of s){let n=a.object;for(;n.parent&&!n.userData.node;)n=n.parent;if(n.userData.node){o=n;break}}o!==this.hoveredMesh&&(this.hoveredMesh=o,this.renderer.domElement.style.cursor=o?"pointer":"default",this.onHoverCallback?.(o?.userData.node||null))});r(this,"handleClick",()=>{this.hoveredMesh&&this.onClickCallback?.(this.hoveredMesh.userData.node)});r(this,"handleWheel",e=>{if(!this.camera)return;const t=e.deltaY>0?.5:-.5,i=Math.max(5,Math.min(15,-this.camera.top+t)),s=this.width/this.height;this.camera.left=-i*s,this.camera.right=i*s,this.camera.top=i,this.camera.bottom=-i,this.camera.updateProjectionMatrix()})}async initialize(e,t){const i=b.start("isometricRenderer.init");this.THREE=await C(()=>import("./three-vendor-y9bq9ss_.js").then(a=>a.ax),[]),this.container=e,this.data=t,this.width=e.clientWidth,this.height=e.clientHeight,this.scene=new this.THREE.Scene,this.scene.background=new this.THREE.Color(657941);const s=this.width/this.height,o=8;this.camera=new this.THREE.OrthographicCamera(-o*s,o*s,o,-o,.1,1e3),this.camera.position.set(20,15,20),this.camera.lookAt(0,0,0),this.renderer=new this.THREE.WebGLRenderer({antialias:!0,powerPreference:"high-performance"}),this.renderer.setSize(this.width,this.height),this.renderer.setPixelRatio(g("high")),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=this.THREE.PCFSoftShadowMap,e.appendChild(this.renderer.domElement),this.raycaster=new this.THREE.Raycaster,this.mouse=new this.THREE.Vector2,this.createFloor(),this.createRoomGroups(),this.setupLighting(),this.renderer.domElement.addEventListener("mousemove",this.handleMouseMove),this.renderer.domElement.addEventListener("click",this.handleClick),this.renderer.domElement.addEventListener("wheel",this.handleWheel,{passive:!0}),this.startRenderLoop(),i()}createFloor(){if(!this.THREE||!this.scene)return;const e=new this.THREE.GridHelper(30,30,1710638,1710638);e.position.y=-.01,this.scene.add(e);const t=new this.THREE.PlaneGeometry(30,30),i=new this.THREE.MeshStandardMaterial({color:986906,roughness:.8,metalness:.2}),s=new this.THREE.Mesh(t,i);s.rotation.x=-Math.PI/2,s.receiveShadow=!0,this.scene.add(s)}createRoomGroups(){if(!this.THREE||!this.scene||!this.data)return;const e=new Map;this.data.nodes.forEach(s=>{e.has(s.category)||e.set(s.category,[]),e.get(s.category).push(s)});const t=this.data.categories.length,i=8;this.data.categories.forEach((s,o)=>{const a=o/t*Math.PI*2-Math.PI/2,n=Math.cos(a)*i,d=Math.sin(a)*i,h=new this.THREE.Group;h.position.set(n,0,d),this.scene.add(h);const c=e.get(s.id)||[],m=[];this.createCategoryPlatform(h,s,c.length),c.forEach((p,l)=>{const u=this.createRoom(p,s,l,c.length);h.add(u),m.push(u),this.roomMeshes.set(p.id,u);const w=this.createLabel(p);w.position.copy(u.position),w.position.y+=1.8,h.add(w),this.labelSprites.set(p.id,w)});const f=this.createCategoryLabel(s);f.position.set(0,-.5,0),h.add(f),this.roomGroups.set(s.id,{group:h,category:s,nodes:c,rooms:m})})}createCategoryPlatform(e,t,i){if(!this.THREE)return;const s=Math.max(3,i*.8),o=new this.THREE.BoxGeometry(s,.2,s),a=new this.THREE.MeshStandardMaterial({color:new this.THREE.Color(t.color).multiplyScalar(.3),roughness:.6,metalness:.4}),n=new this.THREE.Mesh(o,a);n.position.y=.1,n.castShadow=!0,n.receiveShadow=!0,e.add(n);const d=new this.THREE.BoxGeometry(s+.1,.05,s+.1),h=new this.THREE.MeshBasicMaterial({color:t.color,transparent:!0,opacity:.5}),c=new this.THREE.Mesh(d,h);c.position.y=.2,e.add(c)}createRoom(e,t,i,s){if(!this.THREE)throw new Error("THREE not loaded");const o=i/s*Math.PI*2,a=Math.min(1.5,s*.3),n=Math.cos(o)*a,d=Math.sin(o)*a,h=.8,c=.6+Math.random()*.3,m=.8,f=new this.THREE.BoxGeometry(h,c,m),p=new this.THREE.MeshStandardMaterial({color:new this.THREE.Color(e.metadata?.color||t.color),roughness:.5,metalness:.3,transparent:!0,opacity:.9}),l=new this.THREE.Mesh(f,p);l.position.set(n,.2+c/2,d),l.castShadow=!0,l.receiveShadow=!0,l.userData={node:e};const u=new this.THREE.ConeGeometry(h*.7,.4,4),w=new this.THREE.MeshStandardMaterial({color:new this.THREE.Color(t.color).multiplyScalar(.7),roughness:.6,metalness:.3}),M=new this.THREE.Mesh(u,w);M.position.y=c/2+.2,M.rotation.y=Math.PI/4,l.add(M);const H=new this.THREE.PlaneGeometry(.2,.2),T=new this.THREE.MeshBasicMaterial({color:16777164,transparent:!0,opacity:.8}),R=new this.THREE.Mesh(H,T);return R.position.set(0,.1,m/2+.01),l.add(R),l}createLabel(e){if(!this.THREE)throw new Error("THREE not loaded");const t=document.createElement("canvas");t.width=256,t.height=64;const i=t.getContext("2d");i.font="32px system-ui",i.textAlign="center",i.fillText(e.metadata?.icon||"ðŸ“",128,40);const s=new this.THREE.CanvasTexture(t),o=new this.THREE.SpriteMaterial({map:s,transparent:!0}),a=new this.THREE.Sprite(o);return a.scale.set(.8,.2,1),a.userData={node:e},a}createCategoryLabel(e){if(!this.THREE)throw new Error("THREE not loaded");const t=document.createElement("canvas");t.width=256,t.height=64;const i=t.getContext("2d");i.font="bold 24px system-ui",i.textAlign="center",i.fillStyle="#ffffff",i.fillText(`${e.icon} ${e.label}`,128,45);const s=new this.THREE.CanvasTexture(t),o=new this.THREE.SpriteMaterial({map:s,transparent:!0}),a=new this.THREE.Sprite(o);return a.scale.set(2,.5,1),a}setupLighting(){if(!this.THREE||!this.scene)return;const e=new this.THREE.AmbientLight(4210768,.5);this.scene.add(e);const t=new this.THREE.DirectionalLight(16777215,1);t.position.set(10,20,10),t.castShadow=!0,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,t.shadow.camera.near=.5,t.shadow.camera.far=50,t.shadow.camera.left=-20,t.shadow.camera.right=20,t.shadow.camera.top=20,t.shadow.camera.bottom=-20,this.scene.add(t);const i=new this.THREE.DirectionalLight(4482815,.3);i.position.set(-10,10,-10),this.scene.add(i)}updateAnimations(){this.roomMeshes.forEach((e,t)=>{const i=e===this.hoveredMesh,o=t===this.activeNodeId?.5:i?.3:0,a=e.position.y-(.2+e.geometry.parameters.height/2),n=a+(o-a)*.1,d=e.geometry.parameters.height;e.position.y=.2+d/2+n,e.children.forEach(c=>{if(c.material instanceof this.THREE.MeshBasicMaterial){const m=c.material;m.opacity=.5+Math.sin(this.time*2+t.charCodeAt(0))*.3}});const h=this.labelSprites.get(t);h&&(h.position.y=e.position.y+d/2+.5)}),this.roomGroups.forEach((e,t)=>{const i=Math.sin(this.time*.5+t)*.02;e.group.position.y=i})}setActiveNode(e){this.activeNodeId=e}setHighlightedCategory(e){this.roomGroups.forEach((t,i)=>{const s=!e||i===e;t.group.traverse(o=>{if(o.material){const a=o.material;a.opacity!==void 0&&(a.opacity=s?.9:.3)}})})}setSearchFilter(e){const t=e.toLowerCase();this.roomMeshes.forEach(i=>{const s=i.userData.node,o=`${s.label} ${s.shortLabel||""} ${s.metadata?.description||""}`.toLowerCase(),a=!t||o.includes(t);i.material.opacity=a?.9:.3})}resize(e,t){if(this.width=e,this.height=t,this.camera&&this.renderer){const i=e/t,s=-this.camera.top;this.camera.left=-s*i,this.camera.right=s*i,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}}setQualityLevel(e){this.renderer&&this.THREE&&(this.renderer.setPixelRatio(g(e)),this.renderer.shadowMap.enabled=e!=="lite")}dispose(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.renderer&&(this.renderer.domElement.removeEventListener("mousemove",this.handleMouseMove),this.renderer.domElement.removeEventListener("click",this.handleClick),this.renderer.domElement.removeEventListener("wheel",this.handleWheel),this.renderer.dispose(),this.container?.removeChild(this.renderer.domElement)),this.roomGroups.clear(),this.roomMeshes.clear(),this.labelSprites.clear(),this.scene=null,this.camera=null,this.renderer=null}onNodeClick(e){this.onClickCallback=e}onNodeHover(e){this.onHoverCallback=e}getFPS(){return this.fps}}export{N as IsometricRenderer};
