const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/leaflet-vendor-CIGW-MKW.css"])))=>i.map(i=>d[i]);
import{r as i,j as e,a as ae,L as O}from"./react-vendor-D847gc3Q.js";import{a1 as ne,a2 as re,a3 as ie,_ as Y,e as le,a4 as ce}from"./index-IzYd_JK7.js";import oe from"./ActivityFeed-RbHLM0mo.js";import{R as K,b as de,d as xe,C as me,e as J,B as X,f as q,X as Q,Y as Z,g as ee}from"./recharts-vendor-CxtoZpzE.js";import{f as te}from"./date-vendor-C_JWt2cu.js";import"./leaflet-vendor-DZbo3Ov0.js";import"./apollo-vendor-BNHFeEEc.js";import"./reactflow-vendor-CYb5nRwM.js";import"./d3-vendor-mcDw60ct.js";const ue=6e4,G=new Map;function he(t={}){const{autoFetch:n=!0,refreshInterval:s=6e4}=t,[r,a]=i.useState(!1),[d,o]=i.useState(null),[u,x]=i.useState(null),[c,j]=i.useState(null),[v,w]=i.useState(null),[h,C]=i.useState(null),[g,m]=i.useState(null),[l,N]=i.useState(null),[S,A]=i.useState(null),p=i.useCallback(async(b,M,R)=>{const D=G.get(b);if(D&&Date.now()-D.ts<ue)return R(D.data),D.data;try{const z=await fetch(M);if(!z.ok)return R(null),null;const H=(await z.json()).data;return G.set(b,{data:H,ts:Date.now()}),R(H),H}catch{return R(null),null}},[]),$=i.useCallback((b="24h")=>p(`summary:${b}`,`/api/community/stats/summary?window=${b}`,x),[p]),F=i.useCallback(()=>p("archetypes","/api/community/stats/archetypes",j),[p]),P=i.useCallback((b="7d",M=20)=>p(`exercises:${b}:${M}`,`/api/community/stats/exercises?window=${b}&limit=${M}`,w),[p]),_=i.useCallback(()=>p("funnel","/api/community/stats/funnel",C),[p]),f=i.useCallback(()=>p("credits","/api/community/stats/credits",m),[p]),E=i.useCallback(()=>p("geographic","/api/community/stats/geographic",N),[p]),k=i.useCallback(async()=>{try{const b=await fetch("/api/community/now");if(!b.ok)throw new Error("Failed to fetch now stats");const M=await b.json();return A(M.data),M.data}catch(b){throw b}},[]),T=i.useCallback(async()=>{a(!0),o(null),(await Promise.allSettled([$(),F(),P(),_(),f(),E(),k()])).filter(R=>R.status==="rejected").length>0,a(!1)},[$,F,P,_,f,E,k]),se=i.useCallback(()=>(G.clear(),T()),[T]);return i.useEffect(()=>{n&&T()},[n,T]),i.useEffect(()=>{if(!s)return;const b=setInterval(()=>{k()},s);return()=>clearInterval(b)},[s,k]),{loading:r,error:d,summary:u,archetypes:c,exercises:v,funnel:h,credits:g,geographic:l,nowStats:S,fetchSummary:$,fetchArchetypes:F,fetchExercises:P,fetchFunnel:_,fetchCredits:f,fetchGeographic:E,fetchNowStats:k,fetchAll:T,refresh:se}}const ge=()=>ne(),pe=()=>{ie.getState().logout()},fe=()=>re(),L=async(t,n={})=>{const s={...n.headers,...fe(),"Content-Type":"application/json"},r=await fetch(t,{...n,headers:s});return r.status===401&&(pe(),typeof window<"u"&&(window.location.href="/login")),r},V={"US-NY":[40.7128,-74.006],"US-LA":[34.0522,-118.2437],"US-CHI":[41.8781,-87.6298],"US-HOU":[29.7604,-95.3698],"US-PHX":[33.4484,-112.074],"UK-LON":[51.5074,-.1278],"DE-BER":[52.52,13.405],"FR-PAR":[48.8566,2.3522],"JP-TKY":[35.6762,139.6503],"AU-SYD":[-33.8688,151.2093],"BR-SAO":[-23.5505,-46.6333],"IN-MUM":[19.076,72.8777],"CA-TOR":[43.6532,-79.3832]};function be({presenceData:t=[]}){return e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 min-h-[400px] flex flex-col items-center justify-center",children:[e.jsx("div",{className:"text-6xl mb-4",children:"ðŸ—ºï¸"}),e.jsx("h3",{className:"text-xl font-bold text-white mb-4",children:"Community Activity Map"}),t.length>0?e.jsx("div",{className:"w-full max-w-md space-y-2",children:t.slice(0,10).map((n,s)=>e.jsxs("div",{className:"flex justify-between items-center bg-gray-700 rounded-lg px-4 py-2",children:[e.jsx("span",{className:"text-gray-200",children:n.geoBucket}),e.jsxs("span",{className:"bg-purple-600 px-3 py-1 rounded-full text-sm font-bold",children:[n.count," active"]})]},n.geoBucket||s))}):e.jsx("p",{className:"text-gray-400",children:"No location data available"})]})}function je({presenceData:t=[]}){const n=i.useRef(null),s=i.useRef(null),r=i.useRef([]);return i.useEffect(()=>((async()=>{try{const d=await Y(()=>import("./leaflet-vendor-DZbo3Ov0.js").then(x=>x.l),__vite__mapDeps([0]));if(await Y(()=>import("./leaflet-vendor-DZbo3Ov0.js").then(x=>x.b),__vite__mapDeps([0])),!n.current||s.current)return;const o=d.map(n.current).setView([20,0],2);s.current=o,d.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors",maxZoom:18}).addTo(o);const u=x=>{const c=Math.min(50,20+x*2);return d.divIcon({className:"custom-marker",html:`
              <div style="
                width: ${c}px;
                height: ${c}px;
                background: linear-gradient(135deg, #8b5cf6, #6366f1);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: ${Math.max(10,c/3)}px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                border: 2px solid white;
              ">
                ${x}
              </div>
            `,iconSize:[c,c],iconAnchor:[c/2,c/2]})};t.forEach(x=>{const c=V[x.geoBucket];if(c){const j=d.marker(c,{icon:u(x.count)}).addTo(o).bindPopup(`<strong>${x.geoBucket}</strong><br/>${x.count} active users`);r.current.push(j)}})}catch{}})(),()=>{s.current&&(s.current.remove(),s.current=null),r.current=[]}),[]),i.useEffect(()=>{if(!s.current)return;const a=window.L;if(!a)return;r.current.forEach(o=>o.remove()),r.current=[];const d=o=>{const u=Math.min(50,20+o*2);return a.divIcon({className:"custom-marker",html:`
          <div style="
            width: ${u}px;
            height: ${u}px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: ${Math.max(10,u/3)}px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
          ">
            ${o}
          </div>
        `,iconSize:[u,u],iconAnchor:[u/2,u/2]})};t.forEach(o=>{const u=V[o.geoBucket];if(u){const x=a.marker(u,{icon:d(o.count)}).addTo(s.current).bindPopup(`<strong>${o.geoBucket}</strong><br/>${o.count} active users`);r.current.push(x)}})},[t]),e.jsx("div",{ref:n,className:"w-full h-[400px] rounded-xl overflow-hidden",style:{background:"#1f2937"}})}function ye({presenceData:t=[],loading:n=!1}){const[s,r]=i.useState(!0),[a,d]=i.useState(!1);return i.useEffect(()=>{Y(()=>import("./leaflet-vendor-DZbo3Ov0.js").then(o=>o.l),__vite__mapDeps([0])).then(()=>r(!0)).catch(()=>{d(!0),r(!1)})},[]),n?e.jsx("div",{className:"bg-gray-800 rounded-xl min-h-[400px] flex items-center justify-center",children:e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full"})}):a||!s?e.jsx(be,{presenceData:t}):e.jsxs("div",{className:"relative",children:[e.jsx(je,{presenceData:t}),e.jsxs("div",{className:"absolute top-4 right-4 bg-gray-900/90 backdrop-blur rounded-lg p-3 z-[1000]",children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Active Regions"}),e.jsx("div",{className:"text-2xl font-bold text-white",children:t.length})]})]})}const W=["#8b5cf6","#6366f1","#ec4899","#f59e0b","#10b981","#06b6d4","#ef4444","#84cc16"];function U({title:t,value:n,subtitle:s,icon:r,trend:a}){return e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-gray-400 text-sm",children:t}),r&&e.jsx("span",{className:"text-2xl",children:r})]}),e.jsx("div",{className:"text-2xl font-bold text-white",children:n}),s&&e.jsx("div",{className:"text-sm text-gray-400 mt-1",children:s}),a!==void 0&&e.jsxs("div",{className:`text-sm mt-1 ${a>=0?"text-green-400":"text-red-400"}`,children:[a>=0?"â†‘":"â†“"," ",Math.abs(a),"% from last period"]})]})}function ve({overview:t,credits:n}){return t?e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsx(U,{title:"Total Users",value:(t.totalUsers??0).toLocaleString(),subtitle:`+${t.newUsersInWindow??0} new`,icon:"ðŸ‘¥"}),e.jsx(U,{title:"Workouts",value:(t.workoutsCount??0).toLocaleString(),subtitle:t.window||"24h",icon:"ðŸ‹ï¸"}),e.jsx(U,{title:"Total TU",value:(t.totalWorkoutVolume??0).toLocaleString(),subtitle:"Training units",icon:"ðŸ’ª"}),e.jsx(U,{title:"Credits",value:(n?.totalCredits??0).toLocaleString(),subtitle:`Avg: ${Math.round(n?.avgBalance??0)}`,icon:"ðŸª™"})]}):null}function Ne({data:t}){if(!t||t.length===0)return e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 h-64 flex items-center justify-center text-gray-400",children:"No archetype data available"});const n=t.reduce((r,a)=>r+(a.count??a.userCount??0),0),s=t.map(r=>({name:r.name,value:r.count??r.userCount??0,percentage:n>0?Math.round((r.count??r.userCount??0)/n*100):0}));return e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Archetype Distribution"}),e.jsx(K,{width:"100%",height:250,children:e.jsxs(de,{children:[e.jsx(xe,{data:s,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",outerRadius:80,label:({name:r,percentage:a})=>`${r} (${a}%)`,labelLine:{stroke:"#6b7280"},children:s.map((r,a)=>e.jsx(me,{fill:W[a%W.length]},`cell-${a}`))}),e.jsx(J,{contentStyle:{background:"#1f2937",border:"none",borderRadius:"8px"},itemStyle:{color:"#fff"}})]})})]})}function we({data:t}){if(!t||t.length===0)return e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 h-64 flex items-center justify-center text-gray-400",children:"No exercise data available"});const n=t.slice(0,10).map(s=>({name:s.name,value:s.count??s.usageCount??0}));return e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Popular Exercises"}),e.jsx(K,{width:"100%",height:250,children:e.jsxs(X,{data:n,layout:"vertical",children:[e.jsx(q,{strokeDasharray:"3 3",stroke:"#374151"}),e.jsx(Q,{type:"number",stroke:"#9ca3af"}),e.jsx(Z,{type:"category",dataKey:"name",width:100,stroke:"#9ca3af",tick:{fontSize:12}}),e.jsx(J,{contentStyle:{background:"#1f2937",border:"none",borderRadius:"8px"},itemStyle:{color:"#fff"}}),e.jsx(ee,{dataKey:"value",fill:"#8b5cf6",radius:[0,4,4,0]})]})})]})}function Ce({data:t}){if(!t||t.registered===void 0&&!t?.stages)return e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 h-64 flex items-center justify-center text-gray-400",children:"No funnel data available"});const n=t.registered||0,s=t.stages||[{name:"Registered",count:t.registered??0},{name:"Onboarded",count:t.onboarded??0},{name:"First Workout",count:t.firstWorkout??0},{name:"Active (7d)",count:t.activeLastWeek??0}].map(r=>({...r,percentage:n>0?Math.round(r.count/n*100):0}));return e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"User Journey Funnel"}),e.jsx("div",{className:"space-y-2",children:s.map((r,a)=>e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-sm text-gray-300",children:r.name}),e.jsxs("span",{className:"text-sm text-gray-400",children:[r.count.toLocaleString()," (",r.percentage,"%)"]})]}),e.jsx("div",{className:"h-6 bg-gray-700 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full rounded-full transition-all duration-500",style:{width:`${r.percentage}%`,background:W[a%W.length]}})})]},r.name))})]})}function Se({data:t}){if(!t||t.totalCredits===void 0&&!t?.buckets)return e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 h-64 flex items-center justify-center text-gray-400",children:"No credit data available"});if(t.buckets&&t.buckets.length>0){const s=["negative","0","1-100","101-500","501-1000","1001-5000","5000+"].map(r=>{const a=t.buckets.find(d=>d.bucket===r);return a?{name:r,count:a.count}:null}).filter(Boolean);return e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Credit Distribution"}),e.jsx(K,{width:"100%",height:200,children:e.jsxs(X,{data:s,children:[e.jsx(q,{strokeDasharray:"3 3",stroke:"#374151"}),e.jsx(Q,{dataKey:"name",stroke:"#9ca3af",tick:{fontSize:10}}),e.jsx(Z,{stroke:"#9ca3af"}),e.jsx(J,{contentStyle:{background:"#1f2937",border:"none",borderRadius:"8px"},itemStyle:{color:"#fff"}}),e.jsx(ee,{dataKey:"count",fill:"#10b981",radius:[4,4,0,0]})]})})]})}return e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Credit Economy"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{className:"bg-gray-700 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-gray-400 mb-1",children:"Total in Circulation"}),e.jsx("div",{className:"text-lg font-bold text-green-400",children:(t.totalCredits??0).toLocaleString()})]}),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-gray-400 mb-1",children:"Total Spent"}),e.jsx("div",{className:"text-lg font-bold text-red-400",children:(t.totalSpent??0).toLocaleString()})]}),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-gray-400 mb-1",children:"Avg Balance"}),e.jsx("div",{className:"text-lg font-bold text-purple-400",children:Math.round(t.avgBalance??0).toLocaleString()})]})]})]})}function ke({data:t}){return t?e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Geographic Distribution"}),e.jsxs("div",{className:"text-sm text-gray-400 mb-3",children:[t.totalWithLocation," users with location data"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-300 mb-2",children:"Top Countries"}),e.jsx("div",{className:"space-y-1",children:t.byCountry?.slice(0,5).map(n=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-300",children:n.country}),e.jsx("span",{className:"text-purple-400",children:n.user_count})]},n.country_code))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-300 mb-2",children:"Top Cities"}),e.jsx("div",{className:"space-y-1",children:t.byCity?.slice(0,5).map((n,s)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-300",children:n.city}),e.jsx("span",{className:"text-purple-400",children:n.user_count})]},s))})]})]})]}):e.jsx("div",{className:"bg-gray-800 rounded-xl p-4 h-64 flex items-center justify-center text-gray-400",children:"No geographic data available"})}function Ee({overview:t,archetypes:n,exercises:s,funnel:r,credits:a,geographic:d,loading:o=!1}){const[u,x]=i.useState("24h");return o?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex gap-2",children:["1h","24h","7d"].map(c=>e.jsx("button",{onClick:()=>x(c),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${u===c?"bg-purple-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"}`,children:c},c))}),e.jsx(ve,{overview:t,credits:a}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(Ne,{data:n}),e.jsx(we,{data:s}),e.jsx(Ce,{data:r}),e.jsx(Se,{data:a}),e.jsx(ke,{data:d})]})]})}function I({label:t,value:n,subtext:s,color:r="purple"}){const a={purple:"from-purple-600 to-indigo-600",green:"from-green-600 to-emerald-600",blue:"from-blue-600 to-cyan-600",orange:"from-orange-600 to-amber-600"};return e.jsxs("div",{className:`bg-gradient-to-br ${a[r]} rounded-xl p-4`,children:[e.jsx("div",{className:"text-sm text-white/80",children:t}),e.jsx("div",{className:"text-2xl font-bold text-white",children:n}),s&&e.jsx("div",{className:"text-xs text-white/60 mt-1",children:s})]})}function Te({eventCounts:t}){if(!t||t.length===0)return e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-3",children:"Event Types"}),e.jsx("p",{className:"text-gray-400",children:"No events in this window"})]});const n=t.reduce((s,r)=>s+r.count,0);return e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-3",children:"Event Types"}),e.jsx("div",{className:"space-y-2",children:t.map(s=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"text-gray-300 text-sm",children:s.event_type})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-white font-medium",children:s.count}),e.jsxs("span",{className:"text-gray-500 text-xs",children:["(",Math.round(s.count/n*100),"%)"]})]})]},s.event_type))})]})}function Le({connections:t}){return e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-3",children:"WebSocket Connections"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-green-400",children:t?.communityConnections||0}),e.jsx("div",{className:"text-sm text-gray-400",children:"Community"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-purple-400",children:t?.monitorConnections||0}),e.jsx("div",{className:"text-sm text-gray-400",children:"Monitors"})]})]})]})}function Me({events:t,onUserClick:n}){return!t||t.length===0?e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-3",children:"Recent Events"}),e.jsx("p",{className:"text-gray-400",children:"No recent events"})]}):e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-3",children:"Recent Events (Raw)"}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:t.slice(0,50).map(s=>e.jsxs("div",{className:"bg-gray-700 rounded-lg p-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${s.visibility_scope==="admin"?"bg-red-600":s.visibility_scope==="moderator"?"bg-orange-600":"bg-green-600"}`,children:s.visibility_scope}),e.jsx("span",{className:"text-gray-400 text-xs",children:te(new Date(s.created_at),{addSuffix:!0})})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-purple-400",children:s.event_type}),e.jsxs("button",{onClick:()=>n?.(s.user_id),className:"text-blue-400 hover:underline text-xs",children:[s.user_id?.substring(0,12),"..."]})]}),s.geo_bucket&&e.jsxs("div",{className:"text-gray-400 text-xs mt-1",children:["Location: ",s.geo_bucket]})]},s.id))})]})}function Ae({userId:t,onClose:n}){const[s,r]=i.useState(!0),[a,d]=i.useState(null),[o,u]=i.useState(null);return i.useEffect(()=>{t&&(async()=>{try{const c=await L(`/api/community/monitor/user/${t}`);if(!c.ok)throw new Error("Failed to fetch user");const j=await c.json();d(j.data)}catch(c){u(c.message)}finally{r(!1)}})()},[t]),t?e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"User Details"}),e.jsx("button",{onClick:n,className:"text-gray-400 hover:text-white text-2xl",children:"Ã—"})]}),s&&e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full"})}),o&&e.jsx("div",{className:"bg-red-900/50 text-red-300 p-4 rounded-lg",children:o}),a&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-700 rounded-lg p-4",children:[e.jsx("h3",{className:"font-bold text-white mb-2",children:"User Info"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"ID:"}),e.jsx("span",{className:"text-white ml-2",children:a.user?.id})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Username:"}),e.jsx("span",{className:"text-white ml-2",children:a.user?.username})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Role:"}),e.jsx("span",{className:"text-white ml-2",children:a.user?.role||"user"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Joined:"}),e.jsx("span",{className:"text-white ml-2",children:new Date(a.user?.created_at).toLocaleDateString()})]})]})]}),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-4",children:[e.jsx("h3",{className:"font-bold text-white mb-2",children:"Privacy Settings"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Location:"}),e.jsx("span",{className:`ml-2 ${a.privacy?.shareLocation?"text-green-400":"text-red-400"}`,children:a.privacy?.shareLocation?"Enabled":"Disabled"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-400",children:"Feed:"}),e.jsx("span",{className:`ml-2 ${a.privacy?.showInFeed?"text-green-400":"text-red-400"}`,children:a.privacy?.showInFeed?"Visible":"Hidden"})]})]})]}),e.jsxs("div",{className:"bg-gray-700 rounded-lg p-4",children:[e.jsx("h3",{className:"font-bold text-white mb-2",children:"Recent Activity"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:a.events?.slice(0,20).map(x=>e.jsxs("div",{className:"flex justify-between text-sm bg-gray-600 rounded p-2",children:[e.jsx("span",{className:"text-purple-400",children:x.event_type}),e.jsx("span",{className:"text-gray-400",children:te(new Date(x.created_at),{addSuffix:!0})})]},x.id))})]})]})]})}):null}function $e({userRole:t}){const[n,s]=i.useState(!0),[r,a]=i.useState(null),[d,o]=i.useState(null),[u,x]=i.useState([]),[c,j]=i.useState("24h"),[v,w]=i.useState(null),h=i.useCallback(async()=>{try{const g=await L(`/api/community/monitor/metrics?window=${c}`);if(g.status===403){a("Insufficient permissions. Moderator role required.");return}if(!g.ok)throw new Error("Failed to fetch metrics");const m=await g.json();o(m.data)}catch(g){a(g.message)}},[c]),C=i.useCallback(async()=>{try{const g=await L("/api/community/monitor/feed?limit=100");if(!g.ok)throw new Error("Failed to fetch events");const m=await g.json();x(m.data?.events||[])}catch{}},[]);return i.useEffect(()=>{(async()=>{s(!0),await Promise.all([h(),C()]),s(!1)})()},[h,C]),i.useEffect(()=>{const g=setInterval(()=>{h(),C()},3e4);return()=>clearInterval(g)},[h,C]),!t||t!=="moderator"&&t!=="admin"?e.jsxs("div",{className:"bg-red-900/50 text-red-300 p-6 rounded-xl text-center",children:[e.jsx("p",{className:"text-xl mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-sm",children:"This panel requires moderator or admin privileges."})]}):n?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full"})}):r?e.jsx("div",{className:"bg-red-900/50 text-red-300 p-6 rounded-xl text-center",children:e.jsx("p",{children:r})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-white flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:"ðŸ”"})," Monitoring Dashboard"]}),e.jsx("div",{className:"flex gap-2",children:["1h","24h","7d"].map(g=>e.jsx("button",{onClick:()=>j(g),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${c===g?"bg-purple-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"}`,children:g},g))})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(I,{label:"Active Now",value:d?.activeNow?.total||0,subtext:"Users online",color:"green"}),e.jsx(I,{label:"Total Users",value:d?.overview?.users?.total?.toLocaleString()||0,subtext:`+${d?.overview?.users?.newInWindow||0} new`,color:"purple"}),e.jsx(I,{label:"Workouts",value:d?.overview?.workouts?.countInWindow?.toLocaleString()||0,subtext:`${c} window`,color:"blue"}),e.jsx(I,{label:"WS Connections",value:(d?.connections?.communityConnections||0)+(d?.connections?.monitorConnections||0),subtext:"Active sockets",color:"orange"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(Le,{connections:d?.connections}),e.jsx(Te,{eventCounts:d?.eventCounts})]}),e.jsx(Me,{events:u,onUserClick:w}),e.jsx(Ae,{userId:v,onClose:()=>w(null)})]})}function Pe({enabled:t,onChange:n,disabled:s=!1,color:r="purple"}){const a={purple:t?"bg-purple-600":"bg-gray-600",green:t?"bg-green-600":"bg-gray-600",blue:t?"bg-blue-600":"bg-gray-600"};return e.jsx("button",{onClick:()=>!s&&n(!t),disabled:s,className:`relative w-12 h-6 rounded-full transition-colors ${a[r]} ${s?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,children:e.jsx("span",{className:`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform ${t?"translate-x-6":""}`})})}function y({title:t,description:n,enabled:s,onChange:r,disabled:a,icon:d}){return e.jsxs("div",{className:"flex items-center justify-between py-4 border-b border-gray-700 last:border-0",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[d&&e.jsx("span",{className:"text-xl mt-0.5",children:d}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-white font-medium",children:t}),e.jsx("p",{className:"text-gray-400 text-sm mt-1",children:n})]})]}),e.jsx(Pe,{enabled:s,onChange:r,disabled:a})]})}function B({title:t,description:n}){return e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-white",children:t}),n&&e.jsx("p",{className:"text-gray-400 text-sm mt-1",children:n})]})}function Re(){const[t,n]=i.useState(!0),[s,r]=i.useState(!1),[a,d]=i.useState(null),[o,u]=i.useState(null),[x,c]=i.useState(null),[j,v]=i.useState(!1);i.useEffect(()=>{w()},[]);const w=async()=>{try{const[l,N]=await Promise.all([L("/api/privacy"),L("/api/privacy/summary")]);if(!l.ok)throw new Error("Failed to fetch privacy settings");if(!N.ok)throw new Error("Failed to fetch privacy summary");const S=await l.json(),A=await N.json();d(S.data),u(A.data)}catch(l){c(l.message)}finally{n(!1)}},h=async(l,N)=>{r(!0),c(null),v(!1);try{const S=await L("/api/privacy",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({[l]:N})});if(!S.ok)throw new Error("Failed to update settings");const A=await S.json();d(A.data);const p=await L("/api/privacy/summary");if(p.ok){const $=await p.json();u($.data)}v(!0),setTimeout(()=>v(!1),2e3)}catch(S){c(S.message)}finally{r(!1)}},C=async()=>{if(window.confirm(`Enable Minimalist Mode?

This will disable all community features and exclude your data from all comparisons and public features.

You can always re-enable features later.`)){r(!0),c(null);try{if(!(await L("/api/privacy/enable-minimalist",{method:"POST"})).ok)throw new Error("Failed to enable minimalist mode");await w(),v(!0),setTimeout(()=>v(!1),2e3)}catch(l){c(l.message)}finally{r(!1)}}},g=async()=>{if(window.confirm(`Disable Minimalist Mode?

This will restore all features to their default settings. Your data will again be visible in community features.`)){r(!0),c(null);try{if(!(await L("/api/privacy/disable-minimalist",{method:"POST"})).ok)throw new Error("Failed to disable minimalist mode");await w(),v(!0),setTimeout(()=>v(!1),2e3)}catch(l){c(l.message)}finally{r(!1)}}};if(t)return e.jsx("div",{className:"bg-gray-800 rounded-xl p-6 flex items-center justify-center min-h-[400px]",children:e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full"})});const m=a?.minimalistMode;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:`rounded-xl p-6 ${m?"bg-green-900/30 border border-green-600/30":"bg-gray-800"}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-3xl",children:m?"ðŸ›¡ï¸":"ðŸ”’"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:m?"Minimalist Mode Active":"Privacy Mode"}),e.jsx("p",{className:"text-gray-400 text-sm mt-1",children:m?"All community features are disabled":"One-click to disable all social features"})]})]}),j&&e.jsxs("span",{className:"text-green-400 text-sm flex items-center gap-1",children:[e.jsx("span",{children:"âœ“"})," Saved"]}),s&&e.jsx("span",{className:"text-gray-400 text-sm",children:"Saving..."})]}),o&&e.jsx("p",{className:"text-gray-300 text-sm mb-4 bg-gray-700/50 rounded-lg p-3",children:o.summary}),e.jsx("button",{onClick:m?g:C,disabled:s,className:`w-full py-3 px-4 rounded-lg font-medium transition-colors disabled:opacity-50 ${m?"bg-gray-600 hover:bg-gray-500 text-white":"bg-green-600 hover:bg-green-700 text-white"}`,children:s?"Processing...":m?"ðŸ”“ Restore Standard Mode":"ðŸ”’ Enable Minimalist Mode"}),!m&&e.jsx("p",{className:"text-gray-500 text-xs text-center mt-2",children:"Disable all community features with one click"})]}),x&&e.jsx("div",{className:"bg-red-900/50 text-red-300 p-3 rounded-lg text-sm",children:x}),o&&e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6",children:[e.jsx(B,{title:"Your Data Privacy"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[{label:"Comparisons",key:"excludedFromComparisons"},{label:"Activity Feed",key:"excludedFromActivityFeed"},{label:"Location",key:"locationHidden"},{label:"Presence",key:"presenceHidden"},{label:"Profile",key:"profilePrivate"}].map(({label:l,key:N})=>e.jsxs("div",{className:`p-3 rounded-lg text-center ${o.dataPrivacy[N]?"bg-green-900/30":"bg-gray-700/50"}`,children:[e.jsx("span",{className:"text-2xl",children:o.dataPrivacy[N]?"ðŸ”’":"ðŸ‘ï¸"}),e.jsx("p",{className:"text-white text-sm font-medium mt-1",children:l}),e.jsx("p",{className:"text-gray-400 text-xs",children:o.dataPrivacy[N]?"Hidden":"Visible"})]},N))})]}),e.jsxs("div",{className:`bg-gray-800 rounded-xl p-6 ${m?"opacity-60":""}`,children:[e.jsx(B,{title:"Community Features",description:m?"Disabled in minimalist mode":"Toggle individual features"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(y,{icon:"ðŸ†",title:"Leaderboards",description:"Appear in public rankings",enabled:!a?.optOutLeaderboards,onChange:l=>h("optOutLeaderboards",!l),disabled:s||m}),e.jsx(y,{icon:"ðŸ“°",title:"Community Feed",description:"Your activity visible in the feed",enabled:!a?.optOutCommunityFeed,onChange:l=>h("optOutCommunityFeed",!l),disabled:s||m}),e.jsx(y,{icon:"ðŸ‘¥",title:"Crews",description:"Join and participate in crews",enabled:!a?.optOutCrews,onChange:l=>h("optOutCrews",!l),disabled:s||m}),e.jsx(y,{icon:"âš”ï¸",title:"Rivals",description:"Challenge and compete with others",enabled:!a?.optOutRivals,onChange:l=>h("optOutRivals",!l),disabled:s||m}),e.jsx(y,{icon:"ðŸ“",title:"Hangouts",description:"Location-based community hubs",enabled:!a?.optOutHangouts,onChange:l=>h("optOutHangouts",!l),disabled:s||m}),e.jsx(y,{icon:"ðŸ’¬",title:"Messaging",description:"Direct and group messages",enabled:!a?.optOutMessaging,onChange:l=>h("optOutMessaging",!l),disabled:s||m})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl p-6",children:[e.jsx(B,{title:"UI Preferences",description:"Customize your experience"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(y,{icon:"ðŸŽ®",title:"Gamification",description:"XP, levels, and RPG elements",enabled:!a?.hideGamification,onChange:l=>h("hideGamification",!l),disabled:s}),e.jsx(y,{icon:"ðŸ…",title:"Achievements",description:"Badges and milestones",enabled:!a?.hideAchievements,onChange:l=>h("hideAchievements",!l),disabled:s}),e.jsx(y,{icon:"ðŸ’¡",title:"Tips & Insights",description:"Contextual guidance",enabled:!a?.hideTips,onChange:l=>h("hideTips",!l),disabled:s}),e.jsx(y,{icon:"ðŸ””",title:"Social Notifications",description:"Alerts about social activity",enabled:!a?.hideSocialNotifications,onChange:l=>h("hideSocialNotifications",!l),disabled:s}),e.jsx(y,{icon:"ðŸ“Š",title:"Progress Comparisons",description:"Compare with other users",enabled:!a?.hideProgressComparisons,onChange:l=>h("hideProgressComparisons",!l),disabled:s})]})]}),e.jsxs("div",{className:`bg-gray-800 rounded-xl p-6 ${m?"opacity-60":""}`,children:[e.jsx(B,{title:"Data & Tracking",description:"Control how your data is used"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(y,{icon:"ðŸ“ˆ",title:"Stats Comparison",description:"Include in aggregated statistics",enabled:!a?.excludeFromStatsComparison,onChange:l=>h("excludeFromStatsComparison",!l),disabled:s||m}),e.jsx(y,{icon:"ðŸ—ºï¸",title:"Location Features",description:"Geographic data collection",enabled:!a?.excludeFromLocationFeatures,onChange:l=>h("excludeFromLocationFeatures",!l),disabled:s||m}),e.jsx(y,{icon:"ðŸŸ¢",title:"Presence Tracking",description:"Online status visibility",enabled:!a?.disablePresenceTracking,onChange:l=>h("disablePresenceTracking",!l),disabled:s||m}),e.jsx(y,{icon:"ðŸ“¤",title:"Workout Sharing",description:"Allow workouts to be public",enabled:!a?.disableWorkoutSharing,onChange:l=>h("disableWorkoutSharing",!l),disabled:s})]})]}),e.jsxs("div",{className:"bg-gray-700/50 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-white font-medium flex items-center gap-2 mb-2",children:[e.jsx("span",{children:"ðŸ”’"})," Privacy First"]}),e.jsxs("ul",{className:"text-gray-400 text-sm space-y-1",children:[e.jsx("li",{children:"â€¢ Your personal workout data is always private unless you explicitly share it"}),e.jsx("li",{children:"â€¢ Changes are saved automatically"}),e.jsx("li",{children:"â€¢ You can enable minimalist mode at any time to disable all community features"}),e.jsx("li",{children:"â€¢ Your data is never sold to third parties"})]})]})]})}const Fe=[{id:"feed",label:"Live Feed",icon:"ðŸ“¡"},{id:"map",label:"Map",icon:"ðŸ—ºï¸"},{id:"stats",label:"Statistics",icon:"ðŸ“Š"},{id:"settings",label:"Settings",icon:"âš™ï¸"}],_e=[{id:"monitor",label:"Monitor",icon:"ðŸ”"}];function De({nowStats:t,connected:n}){return e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-6",children:[e.jsxs("div",{className:"bg-gradient-to-br from-green-600 to-emerald-700 rounded-xl p-4 text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-white",children:t?.activeUsers||0}),e.jsx("div",{className:"text-sm text-white/80",children:"Active Now"}),e.jsxs("div",{className:"flex items-center justify-center gap-1 mt-1",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${n?"bg-white animate-pulse":"bg-white/50"}`}),e.jsx("span",{className:"text-xs text-white/60",children:n?"Live":"Offline"})]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-purple-600 to-indigo-700 rounded-xl p-4 text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-white",children:t?.topExercises?.[0]?.count||0}),e.jsx("div",{className:"text-sm text-white/80 truncate",children:t?.topExercises?.[0]?.name||"Top Exercise"}),e.jsx("div",{className:"text-xs text-white/60 mt-1",children:"Last 15 min"})]}),e.jsxs("div",{className:"bg-gradient-to-br from-blue-600 to-cyan-700 rounded-xl p-4 text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-white",children:t?.topExercises?.length||0}),e.jsx("div",{className:"text-sm text-white/80",children:"Exercises"}),e.jsx("div",{className:"text-xs text-white/60 mt-1",children:"Trending"})]})]})}function Oe({exercises:t=[]}){return t.length===0?null:e.jsxs("div",{className:"bg-gray-800 rounded-xl p-4 mb-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-400 mb-3",children:"Trending Exercises (Last 15 min)"}),e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:t.slice(0,8).map((n,s)=>e.jsxs("div",{className:"flex-shrink-0 bg-gray-700 rounded-lg px-3 py-2 flex items-center gap-2",children:[e.jsxs("span",{className:"text-purple-400 font-bold text-sm",children:["#",s+1]}),e.jsx("span",{className:"text-white text-sm truncate max-w-[120px]",children:n.name}),e.jsxs("span",{className:"text-gray-400 text-xs",children:["(",n.count,")"]})]},n.exerciseId||s))})]})}function Ve(){const{user:t}=le(),n=ge(),[s,r]=i.useState("feed"),[a,d]=i.useState([]),o=t?.role||(t?.roles?.includes("admin")?"admin":"user"),u=o==="moderator"||o==="admin",{connected:x,snapshot:c,events:j,error:v}=ce("/api/community/ws/public",{autoConnect:!0,token:n}),[w,h]=i.useState(!1);i.useEffect(()=>{if(x||c||j.length>0||v){h(!0);return}const f=setTimeout(()=>h(!0),3e3);return()=>clearTimeout(f)},[x,c,j,v]);const{loading:C,summary:g,archetypes:m,exercises:l,funnel:N,credits:S,geographic:A,nowStats:p,refresh:$}=he({autoFetch:!0,refreshInterval:6e4}),F=ae.useMemo(()=>{const f=c?.recentEvents||[],E=[...j];for(const k of f)E.find(T=>T.id===k.id)||E.push(k);return E.sort((k,T)=>new Date(T.ts)-new Date(k.ts)).slice(0,100)},[c,j]),P=i.useCallback(async()=>{try{const f=await fetch("/api/community/presence");if(!f.ok)return;const E=await f.json();d(E.data?.byGeoBucket||[])}catch{}},[]);i.useEffect(()=>{P();const f=setInterval(P,3e4);return()=>clearInterval(f)},[P]);const _=[...Fe,...u?_e:[]];return e.jsxs("div",{className:"min-h-screen bg-gray-900 text-white pb-24",children:[e.jsx("header",{className:"bg-gray-800 border-b border-gray-700 sticky top-0 z-20",children:e.jsx("div",{className:"max-w-6xl mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(O,{to:"/dashboard",className:"text-gray-400 hover:text-white flex items-center gap-2",children:[e.jsx("span",{children:"â†"}),e.jsx("span",{className:"hidden sm:inline",children:"Back"})]}),e.jsxs("h1",{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:"ðŸŒ"}),e.jsx("span",{children:"Community"})]}),e.jsx("button",{onClick:$,className:"text-gray-400 hover:text-white p-2",title:"Refresh",children:"ðŸ”„"})]})})}),e.jsxs("main",{className:"max-w-6xl mx-auto px-4 py-6",children:[e.jsxs("div",{className:"flex gap-2 mb-6 overflow-x-auto pb-2",children:[e.jsx(O,{to:"/competitions",className:"flex items-center gap-2 bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-full whitespace-nowrap text-sm font-medium transition-colors",children:"ðŸ† Competitions"}),e.jsx(O,{to:"/highfives",className:"flex items-center gap-2 bg-green-600 hover:bg-green-700 px-4 py-2 rounded-full whitespace-nowrap text-sm font-medium transition-colors",children:"ðŸ–ï¸ High Fives"}),e.jsx(O,{to:"/locations",className:"flex items-center gap-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-full whitespace-nowrap text-sm font-medium transition-colors",children:"ðŸ“ Locations"})]}),e.jsx(De,{nowStats:p,connected:x}),e.jsx(Oe,{exercises:p?.topExercises}),e.jsx("div",{className:"flex gap-2 mb-6 overflow-x-auto pb-2",children:_.map(f=>e.jsxs("button",{onClick:()=>r(f.id),className:`flex items-center gap-2 px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors ${s===f.id?"bg-purple-600 text-white":"bg-gray-800 text-gray-300 hover:bg-gray-700"}`,children:[e.jsx("span",{children:f.icon}),e.jsx("span",{children:f.label})]},f.id))}),e.jsxs("div",{className:"min-h-[400px]",children:[s==="feed"&&e.jsx(oe,{events:F,loading:!w&&!c&&j.length===0,connected:x}),s==="map"&&e.jsx(ye,{presenceData:a,loading:a.length===0}),s==="stats"&&e.jsx(Ee,{overview:g,archetypes:m,exercises:l,funnel:N,credits:S,geographic:A,loading:C}),s==="settings"&&e.jsx(Re,{}),s==="monitor"&&u&&e.jsx($e,{userRole:o})]})]})]})}export{Ve as default};
