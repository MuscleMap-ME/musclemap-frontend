import{_ as E}from"./index-Ttza9pip.js";import{p as u,g as d}from"./MapExplore-DjXVXJHI.js";import"./react-vendor-D1NxaRNd.js";import"./leaflet-vendor-DZbo3Ov0.js";import"./apollo-vendor-BMQ75Ycx.js";import"./reactflow-vendor-Dz2P_-Qa.js";import"./d3-vendor-mcDw60ct.js";import"./recharts-vendor-BziRPEEi.js";import"./building-2-DTl2ZuKc.js";import"./gauge-DP4QXDX2.js";import"./arrow-left-Dv1u8CrY.js";import"./minimize-2-BoHGb1a5.js";class I{THREE=null;container=null;scene=null;camera=null;renderer=null;data=null;nodeMeshes=new Map;globeMesh=null;animationId=null;fps=60;frameCount=0;lastFrameTime=0;raycaster=null;mouse=null;onClickCallback=null;onHoverCallback=null;hoveredMesh=null;activeNodeId=null;rotationSpeed=.001;isUserInteracting=!1;mouseDownTime=0;async initialize(e,t){const i=u.start("world3dRenderer.init");this.THREE=await E(()=>import("./three-vendor-y9bq9ss_.js").then(n=>n.ax),[]),this.container=e,this.data=t,this.scene=new this.THREE.Scene,this.scene.background=new this.THREE.Color(657935);const s=e.clientWidth/e.clientHeight;this.camera=new this.THREE.PerspectiveCamera(60,s,.1,1e3),this.camera.position.set(0,0,4),this.renderer=new this.THREE.WebGLRenderer({antialias:!0,powerPreference:"high-performance",stencil:!1}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.renderer.setPixelRatio(d("high")),e.appendChild(this.renderer.domElement),this.raycaster=new this.THREE.Raycaster,this.mouse=new this.THREE.Vector2,this.createGlobe(),this.createNodeMarkers(),this.setupLighting(),this.renderer.domElement.addEventListener("mousemove",this.handleMouseMove),this.renderer.domElement.addEventListener("click",this.handleClick),this.renderer.domElement.addEventListener("mousedown",this.handleMouseDown),this.renderer.domElement.addEventListener("mouseup",this.handleMouseUp),this.renderer.domElement.addEventListener("wheel",this.handleWheel,{passive:!0}),this.startRenderLoop(),i()}createGlobe(){if(!this.THREE||!this.scene)return;const e=new this.THREE.SphereGeometry(1.8,48,48),t=new this.THREE.MeshBasicMaterial({color:1710638,wireframe:!0,transparent:!0,opacity:.3});this.globeMesh=new this.THREE.Mesh(e,t),this.scene.add(this.globeMesh);const i=new this.THREE.SphereGeometry(1.7,32,32),s=new this.THREE.MeshBasicMaterial({color:26367,transparent:!0,opacity:.05}),n=new this.THREE.Mesh(i,s);this.scene.add(n),this.createGridLines()}createGridLines(){if(!this.THREE||!this.scene)return;const e=new this.THREE.LineBasicMaterial({color:26367,transparent:!0,opacity:.1});for(let t=-60;t<=60;t+=30){const i=t*Math.PI/180,s=1.85*Math.cos(i),n=1.85*Math.sin(i),r=[];for(let a=0;a<=64;a++){const c=a/64*Math.PI*2;r.push(new this.THREE.Vector3(s*Math.cos(c),n,s*Math.sin(c)))}const o=new this.THREE.BufferGeometry().setFromPoints(r),h=new this.THREE.Line(o,e);this.scene.add(h)}for(let t=0;t<12;t++){const i=t/12*Math.PI*2,s=[];for(let o=0;o<=64;o++){const h=(o/64-.5)*Math.PI;s.push(new this.THREE.Vector3(1.85*Math.cos(h)*Math.cos(i),1.85*Math.sin(h),1.85*Math.cos(h)*Math.sin(i)))}const n=new this.THREE.BufferGeometry().setFromPoints(s),r=new this.THREE.Line(n,e);this.scene.add(r)}}createNodeMarkers(){if(!this.THREE||!this.scene||!this.data)return;const e=new this.THREE.SphereGeometry(.08,16,16);this.data.nodes.forEach((t,i)=>{const s=t.position.y*Math.PI,n=t.position.x*Math.PI*2,r=1.9,o=r*Math.sin(s)*Math.cos(n),h=r*Math.cos(s),a=r*Math.sin(s)*Math.sin(n),c=new this.THREE.Color(t.metadata?.color||"#ffffff"),m=new this.THREE.MeshBasicMaterial({color:c,transparent:!0,opacity:.9}),l=new this.THREE.Mesh(e,m);l.position.set(o,h,a),l.userData={node:t},this.scene.add(l),this.nodeMeshes.set(t.id,l),this.createNodeGlow(l,c)})}createNodeGlow(e,t){if(!this.THREE||!this.scene)return;const i=new this.THREE.SphereGeometry(.12,8,8),s=new this.THREE.MeshBasicMaterial({color:t,transparent:!0,opacity:.3}),n=new this.THREE.Mesh(i,s);n.position.copy(e.position),this.scene.add(n)}setupLighting(){if(!this.THREE||!this.scene)return;const e=new this.THREE.AmbientLight(16777215,.5);this.scene.add(e);const t=new this.THREE.DirectionalLight(16777215,.5);t.position.set(5,5,5),this.scene.add(t)}startRenderLoop=()=>{const e=t=>{this.frameCount++,t-this.lastFrameTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFrameTime=t),this.globeMesh&&!this.isUserInteracting&&(this.globeMesh.rotation.y+=this.rotationSpeed,this.nodeMeshes.forEach(i=>{i.position.applyAxisAngle(new this.THREE.Vector3(0,1,0),this.rotationSpeed)})),this.nodeMeshes.forEach(i=>{const s=i===this.hoveredMesh,r=i.userData.node?.id===this.activeNodeId?1.5:s?1.3:1;i.scale.lerp(new this.THREE.Vector3(r,r,r),.1)}),this.renderer?.render(this.scene,this.camera),this.animationId=requestAnimationFrame(e)};this.animationId=requestAnimationFrame(e)};handleMouseMove=e=>{if(!this.renderer||!this.THREE)return;const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const i=this.raycaster.intersectObjects(Array.from(this.nodeMeshes.values()));if(i.length>0){const s=i[0].object;s!==this.hoveredMesh&&(this.hoveredMesh=s,this.renderer.domElement.style.cursor="pointer",this.onHoverCallback?.(s.userData.node))}else this.hoveredMesh&&(this.hoveredMesh=null,this.renderer.domElement.style.cursor="grab",this.onHoverCallback?.(null));if(this.isUserInteracting&&e.buttons===1){const s=e.movementX*.005,n=e.movementY*.005;this.globeMesh&&(this.globeMesh.rotation.y+=s,this.globeMesh.rotation.x+=n,this.globeMesh.rotation.x=Math.max(-Math.PI/4,Math.min(Math.PI/4,this.globeMesh.rotation.x))),this.nodeMeshes.forEach(r=>{r.position.applyAxisAngle(new this.THREE.Vector3(0,1,0),s),r.position.applyAxisAngle(new this.THREE.Vector3(1,0,0),n)})}};handleMouseDown=()=>{this.isUserInteracting=!0,this.mouseDownTime=performance.now(),this.renderer&&(this.renderer.domElement.style.cursor="grabbing")};handleMouseUp=()=>{this.isUserInteracting=!1,this.renderer&&(this.renderer.domElement.style.cursor=this.hoveredMesh?"pointer":"grab")};handleClick=()=>{performance.now()-this.mouseDownTime<200&&this.hoveredMesh&&this.onClickCallback?.(this.hoveredMesh.userData.node)};handleWheel=e=>{if(!this.camera)return;const t=e.deltaY>0?.2:-.2,i=Math.max(2.5,Math.min(6,this.camera.position.z+t));this.camera.position.z=i};setActiveNode(e){this.activeNodeId=e}setHighlightedCategory(e){this.nodeMeshes.forEach(t=>{const i=t.userData.node,s=!e||i.category===e;t.material.opacity=s?.9:.2})}setSearchFilter(e){const t=e.toLowerCase();this.nodeMeshes.forEach(i=>{const s=i.userData.node,n=`${s.label} ${s.shortLabel||""} ${s.metadata?.description||""}`.toLowerCase(),r=!t||n.includes(t);i.material.opacity=r?.9:.2})}resize(e,t){this.camera&&this.renderer&&(this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t))}setQualityLevel(e){this.renderer&&this.renderer.setPixelRatio(d(e))}dispose(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.renderer&&(this.renderer.domElement.removeEventListener("mousemove",this.handleMouseMove),this.renderer.domElement.removeEventListener("click",this.handleClick),this.renderer.domElement.removeEventListener("mousedown",this.handleMouseDown),this.renderer.domElement.removeEventListener("mouseup",this.handleMouseUp),this.renderer.domElement.removeEventListener("wheel",this.handleWheel),this.renderer.dispose(),this.container?.removeChild(this.renderer.domElement)),this.nodeMeshes.clear(),this.scene=null,this.camera=null,this.renderer=null}onNodeClick(e){this.onClickCallback=e}onNodeHover(e){this.onHoverCallback=e}getFPS(){return this.fps}}export{I as World3DRenderer};
