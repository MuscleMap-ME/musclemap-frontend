import{r as a,j as e,L as P}from"./react-vendor-D847gc3Q.js";import{c}from"./recharts-vendor-CxtoZpzE.js";import{G as R,m as u,A as H}from"./index-RH5w6CoJ.js";import{a as O}from"./sanitize-CfVRSXz9.js";import{a as g}from"./date-vendor-C_JWt2cu.js";import"./leaflet-vendor-DZbo3Ov0.js";import"./d3-vendor-mcDw60ct.js";import"./apollo-vendor-BNHFeEEc.js";import"./reactflow-vendor-CYb5nRwM.js";const r={Back:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M15 19l-7-7 7-7"})}),Send:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})}),Plus:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 4v16m8-8H4"})}),Search:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),More:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"})}),Archive:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"})}),Star:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"})}),User:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),Users:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})})},D=[{id:"inbox",label:"Inbox"},{id:"starred",label:"Starred"},{id:"archived",label:"Archived"}];function Z(){const{token:l}=R(),[w,p]=a.useState([]),[i,f]=a.useState(null),[j,b]=a.useState([]),[x,y]=a.useState(""),[_,z]=a.useState(!0),[m,B]=a.useState("inbox"),[U,h]=a.useState(!1),[A,T]=a.useState(""),[N,W]=a.useState(""),[k,M]=a.useState([]),C=a.useRef(null),v=a.useCallback(async()=>{if(l)try{const o=await(await fetch("/api/messaging/conversations",{headers:{Authorization:`Bearer ${l}`}})).json(),n=(o.data||[]).map(t=>({id:t.id,type:t.type,name:t.name,display_name:t.name||t.participants?.find(d=>d.userId!==o.currentUserId)?.displayName||t.participants?.find(d=>d.userId!==o.currentUserId)?.username,last_message:t.lastMessage?.content,last_activity_at:t.lastMessageAt||t.createdAt,unread_count:t.unreadCount||0,participants:t.participants}));p(m==="starred"?n.filter(t=>t.starred):m==="archived"?n.filter(t=>t.archived):n.filter(t=>!t.archived))}catch{}finally{z(!1)}},[l,m]),S=a.useCallback(async s=>{if(l)try{const t=((await(await fetch(`/api/messaging/conversations/${s}/messages`,{headers:{Authorization:`Bearer ${l}`}})).json()).data||[]).map(d=>({id:d.id,content:d.content,sender_id:d.senderId,sender_name:d.sender?.displayName||d.sender?.username||"Unknown",created_at:d.createdAt}));b(t),fetch(`/api/messaging/conversations/${s}/read`,{method:"POST",headers:{Authorization:`Bearer ${l}`}}).catch(()=>{})}catch{}},[l]);a.useEffect(()=>{v()},[v]),a.useEffect(()=>{i&&S(i.id)},[i,S]),a.useEffect(()=>{C.current?.scrollIntoView({behavior:"smooth"})},[j]);const $=async s=>{if(s.preventDefault(),!(!x.trim()||!i))try{const n=await(await fetch(`/api/messaging/conversations/${i.id}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({content:O(x)})})).json();if(n.data){const t=n.data;b([...j,{id:t.id,content:t.content,sender_id:"me",sender_name:"You",created_at:t.createdAt}]),y("")}}catch{}},E=async s=>{if(s.length<2)return M([]);try{const n=await(await fetch(`/api/users/search?q=${encodeURIComponent(s)}`,{headers:{Authorization:`Bearer ${l}`}})).json();M(n.users||[])}catch{}},I=async s=>{try{const n=await(await fetch("/api/messaging/conversations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({type:"direct",participantIds:[s]})})).json();n.data?.id&&(h(!1),v(),f({id:n.data.id,...n.data}))}catch{}},L=s=>{const o=new Date(s),t=new Date-o;return t<864e5?g(o,"HH:mm"):t<6048e5?g(o,"EEE"):g(o,"MMM d")};return e.jsxs("div",{className:"min-h-screen bg-[#0a0a0f] text-white flex",children:[e.jsxs("div",{className:c("w-full md:w-80 lg:w-96 border-r border-white/5 flex flex-col",i?"hidden md:flex":"flex"),children:[e.jsxs("div",{className:"p-4 border-b border-white/5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(P,{to:"/dashboard",className:"p-2 -ml-2 rounded-xl hover:bg-white/5",children:e.jsx(r.Back,{})}),e.jsx("h1",{className:"text-xl font-semibold",children:"Messages"})]}),e.jsx("button",{onClick:()=>h(!0),className:"p-2 rounded-xl bg-white/5 hover:bg-white/10 transition-all",children:e.jsx(r.Plus,{})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(r.Search,{}),e.jsx("input",{type:"text",placeholder:"Search conversations...",value:A,onChange:s=>T(s.target.value),className:"w-full pl-10 pr-4 py-2.5 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:border-white/20 text-sm"})]}),e.jsx("div",{className:"flex gap-1 mt-4 p-1 bg-white/5 rounded-xl",children:D.map(s=>e.jsx("button",{onClick:()=>B(s.id),className:c("flex-1 py-2 text-sm font-medium rounded-lg transition-all",m===s.id?"bg-white/10 text-white":"text-gray-400 hover:text-white"),children:s.label},s.id))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:_?e.jsx("div",{className:"p-8 text-center text-gray-500",children:"Loading..."}):w.length===0?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-white/5 flex items-center justify-center",children:e.jsx(r.User,{})}),e.jsx("p",{className:"text-gray-400",children:"No conversations yet"}),e.jsx("button",{onClick:()=>h(!0),className:"mt-4 px-4 py-2 bg-violet-600 rounded-xl text-sm font-medium hover:bg-violet-700 transition-all",children:"Start a conversation"})]}):w.map(s=>e.jsx(u.div,{initial:{opacity:0},animate:{opacity:1},onClick:()=>f(s),className:c("p-4 border-b border-white/5 cursor-pointer transition-all",i?.id===s.id?"bg-white/5":"hover:bg-white/5"),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:c("w-12 h-12 rounded-full flex items-center justify-center",s.type==="group"?"bg-violet-500/20":"bg-white/10"),children:s.type==="group"?e.jsx(r.Users,{}):e.jsx(r.User,{})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium truncate",children:s.display_name||s.name||"Unknown"}),e.jsx("span",{className:"text-xs text-gray-500",children:s.last_activity_at&&L(s.last_activity_at)})]}),e.jsx("p",{className:"text-sm text-gray-400 truncate",children:s.last_message||"No messages yet"})]}),s.unread_count>0&&e.jsx("span",{className:"w-5 h-5 rounded-full bg-violet-500 text-xs font-bold flex items-center justify-center",children:s.unread_count})]})},s.id))})]}),e.jsx("div",{className:c("flex-1 flex flex-col",i?"flex":"hidden md:flex"),children:i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-white/5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>f(null),className:"md:hidden p-2 -ml-2 rounded-xl hover:bg-white/5",children:e.jsx(r.Back,{})}),e.jsx("div",{className:c("w-10 h-10 rounded-full flex items-center justify-center",i.type==="group"?"bg-violet-500/20":"bg-white/10"),children:i.type==="group"?e.jsx(r.Users,{}):e.jsx(r.User,{})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-medium",children:i.display_name||i.name}),e.jsx("span",{className:"text-xs text-gray-500",children:i.type==="group"?"Group":"Direct message"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"p-2 rounded-xl hover:bg-white/5",children:e.jsx(r.Star,{})}),e.jsx("button",{className:"p-2 rounded-xl hover:bg-white/5",children:e.jsx(r.Archive,{})}),e.jsx("button",{className:"p-2 rounded-xl hover:bg-white/5",children:e.jsx(r.More,{})})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[j.map(s=>e.jsx(u.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:c("flex",s.sender_id==="me"?"justify-end":"justify-start"),children:e.jsxs("div",{className:c("max-w-[75%] p-3 rounded-2xl",s.sender_id==="me"?"bg-violet-600 rounded-br-md":"bg-white/10 rounded-bl-md"),children:[s.sender_id!=="me"&&e.jsx("div",{className:"text-xs text-violet-400 mb-1",children:s.sender_name}),e.jsx("p",{className:"text-sm",children:s.content}),e.jsx("div",{className:"text-xs text-white/50 mt-1 text-right",children:L(s.created_at)})]})},s.id)),e.jsx("div",{ref:C})]}),e.jsxs("form",{onSubmit:$,className:"p-4 border-t border-white/5",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx("input",{type:"text",value:x,onChange:s=>y(s.target.value),placeholder:"Type a message...",className:"flex-1 px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:border-white/20"}),e.jsx("button",{type:"submit",disabled:!x.trim(),className:"px-5 py-3 bg-violet-600 hover:bg-violet-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-xl transition-all",children:e.jsx(r.Send,{})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"0.1 credits per recipient"})]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-4 rounded-full bg-white/5 flex items-center justify-center",children:e.jsx(r.User,{})}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-gray-400",children:"Choose from your existing conversations or start a new one"})]})})}),e.jsx(H,{children:U&&e.jsx(u.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4",onClick:()=>h(!1),children:e.jsxs(u.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},onClick:s=>s.stopPropagation(),className:"bg-[#12121a] border border-white/10 rounded-2xl w-full max-w-md overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-white/10 flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"New Message"}),e.jsx("button",{onClick:()=>h(!1),className:"p-2 rounded-xl hover:bg-white/5",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"p-4",children:[e.jsx("input",{type:"text",value:N,onChange:s=>{W(s.target.value),E(s.target.value)},placeholder:"Search for users...",className:"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:border-white/20"}),e.jsxs("div",{className:"mt-4 max-h-64 overflow-y-auto",children:[k.map(s=>e.jsxs("div",{onClick:()=>I(s.id),className:"flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 cursor-pointer",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white/10 flex items-center justify-center",children:e.jsx(r.User,{})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.username}),e.jsx("div",{className:"text-sm text-gray-500",children:s.city||"MuscleMap User"})]})]},s.id)),N.length>=2&&k.length===0&&e.jsx("p",{className:"text-center text-gray-500 py-8",children:"No users found"})]})]})]})})})]})}export{Z as default};
