var v=function(s,e,t){if(t||arguments.length===2)for(var n=0,o=e.length,r;n<o;n++)(r||!(n in e))&&(r||(r=Array.prototype.slice.call(e,0,n)),r[n]=e[n]);return s.concat(r||Array.prototype.slice.call(e))},x=function(){function s(e){var t=e.debug,n=t===void 0?!1:t;this.debug=n,this.lines=[]}return s.prototype.emit=function(e,t){if(e in console)var n=s.prefix},s.prototype.tailLogs=function(){var e=this;this.lines.forEach(function(t){var n=t[0],o=t[1];return e.emit(n,o)})},s.prototype.getLogs=function(){return this.lines},s.prototype.write=function(e,t){var n=s.buffer;this.lines=v(v([],this.lines.slice(1-n),!0),[[e,t]],!1),(this.debug||e!=="log")&&this.emit(e,t)},s.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.write("log",e)},s.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.write("warn",e)},s.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.write("error",e)},s.buffer=30,s.prefix="[apollo-cache-persist]",s}(),k=function(){function s(e){var t=e.cache,n=e.serialize,o=n===void 0?!0:n;this.cache=t,this.serialize=o}return s.prototype.extract=function(){var e=this.cache.extract();return this.serialize&&(e=JSON.stringify(e)),e},s.prototype.restore=function(e){this.serialize&&typeof e=="string"&&(e=JSON.parse(e)),e!=null&&this.cache.restore(e)},s}(),l=function(s,e,t,n){function o(r){return r instanceof t?r:new t(function(c){c(r)})}return new(t||(t=Promise))(function(r,c){function u(h){try{i(n.next(h))}catch(f){c(f)}}function a(h){try{i(n.throw(h))}catch(f){c(f)}}function i(h){h.done?r(h.value):o(h.value).then(u,a)}i((n=n.apply(s,e||[])).next())})},g=function(s,e){var t={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},n,o,r,c;return c={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function u(i){return function(h){return a([i,h])}}function a(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(t=0)),t;)try{if(n=1,o&&(r=i[0]&2?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[i[0]&2,r.value]),i[0]){case 0:case 1:r=i;break;case 4:return t.label++,{value:i[1],done:!1};case 5:t.label++,o=i[1],i=[0];continue;case 7:i=t.ops.pop(),t.trys.pop();continue;default:if(r=t.trys,!(r=r.length>0&&r[r.length-1])&&(i[0]===6||i[0]===2)){t=0;continue}if(i[0]===3&&(!r||i[1]>r[0]&&i[1]<r[3])){t.label=i[1];break}if(i[0]===6&&t.label<r[1]){t.label=r[1],r=i;break}if(r&&t.label<r[2]){t.label=r[2],t.ops.push(i);break}r[2]&&t.ops.pop(),t.trys.pop();continue}i=e.call(s,t)}catch(h){i=[6,h],o=0}finally{n=r=0}if(i[0]&5)throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}},w=function(){function s(e){var t=e.storage,n=e.key,o=n===void 0?"apollo-cache-persist":n;this.storage=t,this.key=o}return s.prototype.read=function(){return l(this,void 0,void 0,function(){return g(this,function(e){return[2,this.storage.getItem(this.key)]})})},s.prototype.write=function(e){return l(this,void 0,void 0,function(){return g(this,function(t){switch(t.label){case 0:return[4,this.storage.setItem(this.key,e)];case 1:return t.sent(),[2]}})})},s.prototype.purge=function(){return l(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,this.storage.removeItem(this.key)];case 1:return e.sent(),[2]}})})},s.prototype.getSize=function(){return l(this,void 0,void 0,function(){var e;return g(this,function(t){switch(t.label){case 0:return[4,this.storage.getItem(this.key)];case 1:return e=t.sent(),e==null?[2,0]:[2,typeof e=="string"?e.length:null]}})})},s}(),p=function(s,e,t,n){function o(r){return r instanceof t?r:new t(function(c){c(r)})}return new(t||(t=Promise))(function(r,c){function u(h){try{i(n.next(h))}catch(f){c(f)}}function a(h){try{i(n.throw(h))}catch(f){c(f)}}function i(h){h.done?r(h.value):o(h.value).then(u,a)}i((n=n.apply(s,e||[])).next())})},d=function(s,e){var t={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},n,o,r,c;return c={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function u(i){return function(h){return a([i,h])}}function a(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(t=0)),t;)try{if(n=1,o&&(r=i[0]&2?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[i[0]&2,r.value]),i[0]){case 0:case 1:r=i;break;case 4:return t.label++,{value:i[1],done:!1};case 5:t.label++,o=i[1],i=[0];continue;case 7:i=t.ops.pop(),t.trys.pop();continue;default:if(r=t.trys,!(r=r.length>0&&r[r.length-1])&&(i[0]===6||i[0]===2)){t=0;continue}if(i[0]===3&&(!r||i[1]>r[0]&&i[1]<r[3])){t.label=i[1];break}if(i[0]===6&&t.label<r[1]){t.label=r[1],r=i;break}if(r&&t.label<r[2]){t.label=r[2],t.ops.push(i);break}r[2]&&t.ops.pop(),t.trys.pop();continue}i=e.call(s,t)}catch(h){i=[6,h],o=0}finally{n=r=0}if(i[0]&5)throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}},b=function(){function s(e,t){var n=e.log,o=e.cache,r=e.storage,c=t.maxSize,u=c===void 0?1024*1024:c,a=t.persistenceMapper;this.log=n,this.cache=o,this.storage=r,this.paused=!1,a&&(this.persistenceMapper=a),u&&(this.maxSize=u)}return s.prototype.persist=function(){return p(this,void 0,void 0,function(){var e,t;return d(this,function(n){switch(n.label){case 0:return n.trys.push([0,6,,7]),e=this.cache.extract(),!this.paused&&this.persistenceMapper?[4,this.persistenceMapper(e)]:[3,2];case 1:e=n.sent(),n.label=2;case 2:return this.maxSize!=null&&typeof e=="string"&&e.length>this.maxSize&&!this.paused?[4,this.purge()]:[3,4];case 3:return n.sent(),this.paused=!0,[2];case 4:return this.paused?[2]:[4,this.storage.write(e)];case 5:return n.sent(),this.log.info(typeof e=="string"?"Persisted cache of size ".concat(e.length," characters"):"Persisted cache"),[3,7];case 6:throw t=n.sent(),this.log.error("Error persisting cache",t),t;case 7:return[2]}})})},s.prototype.restore=function(){return p(this,void 0,void 0,function(){var e,t;return d(this,function(n){switch(n.label){case 0:return n.trys.push([0,5,,6]),[4,this.storage.read()];case 1:return e=n.sent(),e==null?[3,3]:[4,this.cache.restore(e)];case 2:return n.sent(),this.log.info(typeof e=="string"?"Restored cache of size ".concat(e.length," characters"):"Restored cache"),[3,4];case 3:this.log.info("No stored cache to restore"),n.label=4;case 4:return[3,6];case 5:throw t=n.sent(),this.log.error("Error restoring cache",t),t;case 6:return[2]}})})},s.prototype.purge=function(){return p(this,void 0,void 0,function(){var e;return d(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,this.storage.purge()];case 1:return t.sent(),this.log.info("Purged cache storage"),[3,3];case 2:throw e=t.sent(),this.log.error("Error purging cache storage",e),e;case 3:return[2]}})})},s}();const m=function(s){var e=s.cache;return function(t){var n=e.write,o=e.evict,r=e.modify,c=e.gc;return e.write=function(){for(var u=[],a=0;a<arguments.length;a++)u[a]=arguments[a];var i=n.apply(e,u);return t(),i},e.evict=function(){for(var u=[],a=0;a<arguments.length;a++)u[a]=arguments[a];var i=o.apply(e,u);return t(),i},e.modify=function(){for(var u=[],a=0;a<arguments.length;a++)u[a]=arguments[a];var i=r.apply(e,u);return t(),i},e.gc=function(){for(var u=[],a=0;a<arguments.length;a++)u[a]=arguments[a];var i=c.apply(e,u);return t(),i},function(){e.write=n,e.evict=o,e.modify=r,e.gc=c}}},z=function(s){var e=s.log,t=s.cache;return function(n){return e.warn("Trigger option `background` not available on web; using `write` trigger"),m({cache:t})(n)}};var C=function(){function s(e,t){var n=e.log,o=e.persistor,r=this;this.fire=function(){if(!r.debounce){r.persist();return}r.timeout!=null&&clearTimeout(r.timeout),r.timeout=setTimeout(r.persist,r.debounce)},this.persist=function(){r.paused||r.persistor.persist()};var c=s.defaultDebounce,u=t.cache,a=t.debounce,i=t.trigger,h=i===void 0?"write":i;if(h)switch(this.debounce=a??c,this.persistor=o,this.paused=!1,h){case"write":this.uninstall=m({cache:u})(this.fire);break;case"background":a&&n.warn("Debounce is not recommended with `background` trigger"),this.debounce=a,this.uninstall=z({cache:u,log:n})(this.fire);break;default:if(typeof h=="function")this.uninstall=h(this.fire);else throw Error("Unrecognized trigger option: ".concat(h))}}return s.prototype.pause=function(){this.paused=!0},s.prototype.resume=function(){this.paused=!1},s.prototype.remove=function(){this.uninstall&&(this.uninstall(),this.uninstall=null,this.paused=!0)},s.defaultDebounce=1e3,s}(),S=function(){function s(e){if(!e.cache)throw new Error("In order to persist your Apollo Cache, you need to pass in a cache. Please see https://www.apollographql.com/docs/react/basics/caching.html for our default InMemoryCache.");if(!e.storage)throw new Error("In order to persist your Apollo Cache, you need to pass in an underlying storage provider. Please see https://github.com/apollographql/apollo-cache-persist#storage-providers");var t=new x(e),n=new k(e),o=new w(e),r=new b({log:t,cache:n,storage:o},e),c=new C({log:t,persistor:r},e);this.log=t,this.cache=n,this.storage=o,this.persistor=r,this.trigger=c}return s.prototype.persist=function(){return this.persistor.persist()},s.prototype.restore=function(){return this.persistor.restore()},s.prototype.purge=function(){return this.persistor.purge()},s.prototype.pause=function(){this.trigger.pause()},s.prototype.resume=function(){this.trigger.resume()},s.prototype.remove=function(){this.trigger.remove()},s.prototype.getLogs=function(e){if(e===void 0&&(e=!1),e)this.log.tailLogs();else return this.log.getLogs()},s.prototype.getSize=function(){return this.storage.getSize()},s}();const A=function(s){var e=new S(s);return e.restore()};var y=function(){var s=function(e,t){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,o){n.__proto__=o}||function(n,o){for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(n[r]=o[r])},s(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");s(e,t);function n(){this.constructor=e}e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)}}();(function(s){y(e,s);function e(t){var n=s.call(this,t)||this;return n.storage=new P(t),n.persistor=new E({log:n.log,cache:n.cache,storage:n.storage},t),n}return e.prototype.restoreSync=function(){this.persistor.restoreSync()},e})(S);var E=function(s){y(e,s);function e(t,n){var o=t.log,r=t.cache,c=t.storage;return s.call(this,{log:o,cache:r,storage:c},n)||this}return e.prototype.restoreSync=function(){this.cache.restore(this.storage.readSync())},e}(b),P=function(s){y(e,s);function e(t){return s.call(this,t)||this}return e.prototype.readSync=function(){return this.storage.getItem(this.key)},e}(w);export{S as CachePersistor,E as SynchronousPersistor,P as SynchronousStorage,A as persistCache};
