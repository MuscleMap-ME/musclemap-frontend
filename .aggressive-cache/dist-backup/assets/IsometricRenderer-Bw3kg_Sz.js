import{_ as H}from"./index-Ccc0k-LV.js";import{p as T,g as M}from"./MapExplore-B-u-z99M.js";import"./react-vendor-D1NxaRNd.js";import"./leaflet-vendor-DZbo3Ov0.js";import"./apollo-vendor-BMQ75Ycx.js";import"./reactflow-vendor-Dz2P_-Qa.js";import"./d3-vendor-mcDw60ct.js";import"./recharts-vendor-BziRPEEi.js";import"./building-2-D3fhtaUh.js";import"./gauge-DuwLrm79.js";import"./arrow-left-BOO8OuvL.js";import"./minimize-2-B1XlupLy.js";class z{THREE=null;container=null;scene=null;camera=null;renderer=null;data=null;roomGroups=new Map;roomMeshes=new Map;labelSprites=new Map;animationId=null;fps=60;frameCount=0;lastFrameTime=0;time=0;raycaster=null;mouse=null;onClickCallback=null;onHoverCallback=null;hoveredMesh=null;activeNodeId=null;width=0;height=0;cameraTarget={x:0,y:0};async initialize(e,t){const i=T.start("isometricRenderer.init");this.THREE=await H(()=>import("./three-vendor-y9bq9ss_.js").then(r=>r.ax),[]),this.container=e,this.data=t,this.width=e.clientWidth,this.height=e.clientHeight,this.scene=new this.THREE.Scene,this.scene.background=new this.THREE.Color(657941);const s=this.width/this.height,o=8;this.camera=new this.THREE.OrthographicCamera(-o*s,o*s,o,-o,.1,1e3),this.camera.position.set(20,15,20),this.camera.lookAt(0,0,0),this.renderer=new this.THREE.WebGLRenderer({antialias:!0,powerPreference:"high-performance"}),this.renderer.setSize(this.width,this.height),this.renderer.setPixelRatio(M("high")),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=this.THREE.PCFSoftShadowMap,e.appendChild(this.renderer.domElement),this.raycaster=new this.THREE.Raycaster,this.mouse=new this.THREE.Vector2,this.createFloor(),this.createRoomGroups(),this.setupLighting(),this.renderer.domElement.addEventListener("mousemove",this.handleMouseMove),this.renderer.domElement.addEventListener("click",this.handleClick),this.renderer.domElement.addEventListener("wheel",this.handleWheel,{passive:!0}),this.startRenderLoop(),i()}createFloor(){if(!this.THREE||!this.scene)return;const e=new this.THREE.GridHelper(30,30,1710638,1710638);e.position.y=-.01,this.scene.add(e);const t=new this.THREE.PlaneGeometry(30,30),i=new this.THREE.MeshStandardMaterial({color:986906,roughness:.8,metalness:.2}),s=new this.THREE.Mesh(t,i);s.rotation.x=-Math.PI/2,s.receiveShadow=!0,this.scene.add(s)}createRoomGroups(){if(!this.THREE||!this.scene||!this.data)return;const e=new Map;this.data.nodes.forEach(s=>{e.has(s.category)||e.set(s.category,[]),e.get(s.category).push(s)});const t=this.data.categories.length,i=8;this.data.categories.forEach((s,o)=>{const r=o/t*Math.PI*2-Math.PI/2,a=Math.cos(r)*i,l=Math.sin(r)*i,n=new this.THREE.Group;n.position.set(a,0,l),this.scene.add(n);const h=e.get(s.id)||[],d=[];this.createCategoryPlatform(n,s,h.length),h.forEach((m,c)=>{const E=this.createRoom(m,s,c,h.length);n.add(E),d.push(E),this.roomMeshes.set(m.id,E);const p=this.createLabel(m);p.position.copy(E.position),p.position.y+=1.8,n.add(p),this.labelSprites.set(m.id,p)});const u=this.createCategoryLabel(s);u.position.set(0,-.5,0),n.add(u),this.roomGroups.set(s.id,{group:n,category:s,nodes:h,rooms:d})})}createCategoryPlatform(e,t,i){if(!this.THREE)return;const s=Math.max(3,i*.8),o=new this.THREE.BoxGeometry(s,.2,s),r=new this.THREE.MeshStandardMaterial({color:new this.THREE.Color(t.color).multiplyScalar(.3),roughness:.6,metalness:.4}),a=new this.THREE.Mesh(o,r);a.position.y=.1,a.castShadow=!0,a.receiveShadow=!0,e.add(a);const l=new this.THREE.BoxGeometry(s+.1,.05,s+.1),n=new this.THREE.MeshBasicMaterial({color:t.color,transparent:!0,opacity:.5}),h=new this.THREE.Mesh(l,n);h.position.y=.2,e.add(h)}createRoom(e,t,i,s){if(!this.THREE)throw new Error("THREE not loaded");const o=i/s*Math.PI*2,r=Math.min(1.5,s*.3),a=Math.cos(o)*r,l=Math.sin(o)*r,n=.8,h=.6+Math.random()*.3,d=.8,u=new this.THREE.BoxGeometry(n,h,d),m=new this.THREE.MeshStandardMaterial({color:new this.THREE.Color(e.metadata?.color||t.color),roughness:.5,metalness:.3,transparent:!0,opacity:.9}),c=new this.THREE.Mesh(u,m);c.position.set(a,.2+h/2,l),c.castShadow=!0,c.receiveShadow=!0,c.userData={node:e};const E=new this.THREE.ConeGeometry(n*.7,.4,4),p=new this.THREE.MeshStandardMaterial({color:new this.THREE.Color(t.color).multiplyScalar(.7),roughness:.6,metalness:.3}),w=new this.THREE.Mesh(E,p);w.position.y=h/2+.2,w.rotation.y=Math.PI/4,c.add(w);const R=new this.THREE.PlaneGeometry(.2,.2),g=new this.THREE.MeshBasicMaterial({color:16777164,transparent:!0,opacity:.8}),f=new this.THREE.Mesh(R,g);return f.position.set(0,.1,d/2+.01),c.add(f),c}createLabel(e){if(!this.THREE)throw new Error("THREE not loaded");const t=document.createElement("canvas");t.width=256,t.height=64;const i=t.getContext("2d");i.font="32px system-ui",i.textAlign="center",i.fillText(e.metadata?.icon||"ðŸ“",128,40);const s=new this.THREE.CanvasTexture(t),o=new this.THREE.SpriteMaterial({map:s,transparent:!0}),r=new this.THREE.Sprite(o);return r.scale.set(.8,.2,1),r.userData={node:e},r}createCategoryLabel(e){if(!this.THREE)throw new Error("THREE not loaded");const t=document.createElement("canvas");t.width=256,t.height=64;const i=t.getContext("2d");i.font="bold 24px system-ui",i.textAlign="center",i.fillStyle="#ffffff",i.fillText(`${e.icon} ${e.label}`,128,45);const s=new this.THREE.CanvasTexture(t),o=new this.THREE.SpriteMaterial({map:s,transparent:!0}),r=new this.THREE.Sprite(o);return r.scale.set(2,.5,1),r}setupLighting(){if(!this.THREE||!this.scene)return;const e=new this.THREE.AmbientLight(4210768,.5);this.scene.add(e);const t=new this.THREE.DirectionalLight(16777215,1);t.position.set(10,20,10),t.castShadow=!0,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,t.shadow.camera.near=.5,t.shadow.camera.far=50,t.shadow.camera.left=-20,t.shadow.camera.right=20,t.shadow.camera.top=20,t.shadow.camera.bottom=-20,this.scene.add(t);const i=new this.THREE.DirectionalLight(4482815,.3);i.position.set(-10,10,-10),this.scene.add(i)}startRenderLoop=()=>{const e=t=>{this.frameCount++,t-this.lastFrameTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFrameTime=t),this.time=t*.001,this.updateAnimations(),this.renderer?.render(this.scene,this.camera),this.animationId=requestAnimationFrame(e)};this.animationId=requestAnimationFrame(e)};updateAnimations(){this.roomMeshes.forEach((e,t)=>{const i=e===this.hoveredMesh,o=t===this.activeNodeId?.5:i?.3:0,r=e.position.y-(.2+e.geometry.parameters.height/2),a=r+(o-r)*.1,l=e.geometry.parameters.height;e.position.y=.2+l/2+a,e.children.forEach(h=>{if(h.material instanceof this.THREE.MeshBasicMaterial){const d=h.material;d.opacity=.5+Math.sin(this.time*2+t.charCodeAt(0))*.3}});const n=this.labelSprites.get(t);n&&(n.position.y=e.position.y+l/2+.5)}),this.roomGroups.forEach((e,t)=>{const i=Math.sin(this.time*.5+t)*.02;e.group.position.y=i})}handleMouseMove=e=>{if(!this.renderer||!this.THREE)return;const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const i=Array.from(this.roomMeshes.values()),s=this.raycaster.intersectObjects(i,!0);let o=null;for(const r of s){let a=r.object;for(;a.parent&&!a.userData.node;)a=a.parent;if(a.userData.node){o=a;break}}o!==this.hoveredMesh&&(this.hoveredMesh=o,this.renderer.domElement.style.cursor=o?"pointer":"default",this.onHoverCallback?.(o?.userData.node||null))};handleClick=()=>{this.hoveredMesh&&this.onClickCallback?.(this.hoveredMesh.userData.node)};handleWheel=e=>{if(!this.camera)return;const t=e.deltaY>0?.5:-.5,i=Math.max(5,Math.min(15,-this.camera.top+t)),s=this.width/this.height;this.camera.left=-i*s,this.camera.right=i*s,this.camera.top=i,this.camera.bottom=-i,this.camera.updateProjectionMatrix()};setActiveNode(e){this.activeNodeId=e}setHighlightedCategory(e){this.roomGroups.forEach((t,i)=>{const s=!e||i===e;t.group.traverse(o=>{if(o.material){const r=o.material;r.opacity!==void 0&&(r.opacity=s?.9:.3)}})})}setSearchFilter(e){const t=e.toLowerCase();this.roomMeshes.forEach(i=>{const s=i.userData.node,o=`${s.label} ${s.shortLabel||""} ${s.metadata?.description||""}`.toLowerCase(),r=!t||o.includes(t);i.material.opacity=r?.9:.3})}resize(e,t){if(this.width=e,this.height=t,this.camera&&this.renderer){const i=e/t,s=-this.camera.top;this.camera.left=-s*i,this.camera.right=s*i,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}}setQualityLevel(e){this.renderer&&this.THREE&&(this.renderer.setPixelRatio(M(e)),this.renderer.shadowMap.enabled=e!=="lite")}dispose(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.renderer&&(this.renderer.domElement.removeEventListener("mousemove",this.handleMouseMove),this.renderer.domElement.removeEventListener("click",this.handleClick),this.renderer.domElement.removeEventListener("wheel",this.handleWheel),this.renderer.dispose(),this.container?.removeChild(this.renderer.domElement)),this.roomGroups.clear(),this.roomMeshes.clear(),this.labelSprites.clear(),this.scene=null,this.camera=null,this.renderer=null}onNodeClick(e){this.onClickCallback=e}onNodeHover(e){this.onHoverCallback=e}getFPS(){return this.fps}}export{z as IsometricRenderer};
