import{r as a,j as e,L as ee}from"./react-vendor-D1NxaRNd.js";import{c as h}from"./recharts-vendor-BziRPEEi.js";import{y as se,m as y,A as te}from"./index-VPOrxyVC.js";import{a as ae}from"./sanitize-CfVRSXz9.js";import{a as L}from"./date-vendor-C_JWt2cu.js";import"./leaflet-vendor-DZbo3Ov0.js";import"./d3-vendor-mcDw60ct.js";import"./apollo-vendor-D9c7jRvS.js";import"./reactflow-vendor-Dz2P_-Qa.js";const l={Back:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M15 19l-7-7 7-7"})}),Send:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})}),Plus:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 4v16m8-8H4"})}),Search:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),More:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"})}),Archive:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"})}),Star:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"})}),Block:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"})}),User:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),Users:()=>e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})})},re=[{id:"inbox",label:"Inbox"},{id:"starred",label:"Starred"},{id:"archived",label:"Archived"}];function ue(){const{token:c,user:R}=se(),d=R?.id,[B,p]=a.useState([]),[r,j]=a.useState(null),[N,_]=a.useState([]),[v,U]=a.useState(""),[D,H]=a.useState(!0),[g,F]=a.useState("inbox"),[Y,u]=a.useState(!1),[J,Q]=a.useState(""),[A,V]=a.useState(""),[z,E]=a.useState([]),[T,b]=a.useState(!1),[k,f]=a.useState(!1),[$,x]=a.useState(""),I=a.useRef(null),M=a.useRef(null),C=a.useCallback(async()=>{if(!(!c||!d))try{const i=((await(await fetch("/api/messaging/conversations",{headers:{Authorization:`Bearer ${c}`}})).json()).data||[]).map(t=>{const o=t.participants?.find(m=>m.userId!==d);return{id:t.id,type:t.type,name:t.name,display_name:t.name||o?.displayName||o?.username||"Unknown",last_message:t.lastMessage?.content,last_activity_at:t.lastMessageAt||t.createdAt,unread_count:t.unreadCount||0,participants:t.participants}});p(g==="starred"?i.filter(t=>t.starred):g==="archived"?i.filter(t=>t.archived):i.filter(t=>!t.archived))}catch{}finally{H(!1)}},[c,g,d]),P=a.useCallback(async s=>{if(!(!c||!d))try{const t=((await(await fetch(`/api/messaging/conversations/${s}/messages`,{headers:{Authorization:`Bearer ${c}`}})).json()).data||[]).map(o=>({id:o.id,content:o.content,sender_id:o.sender?.id===d?"me":o.sender?.id,sender_name:o.sender?.id===d?"You":o.sender?.displayName||o.sender?.username||"Unknown",created_at:o.createdAt}));_(t),fetch(`/api/messaging/conversations/${s}/read`,{method:"POST",headers:{Authorization:`Bearer ${c}`}}).catch(()=>{})}catch{}},[c,d]);a.useEffect(()=>{C()},[C]),a.useEffect(()=>{r&&P(r.id)},[r,P]),a.useEffect(()=>{I.current?.scrollIntoView({behavior:"smooth"})},[N]);const G=async s=>{if(s.preventDefault(),!v.trim()||!r)return;const n=ae(v);x("");try{const t=await(await fetch(`/api/messaging/conversations/${r.id}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({content:n})})).json();if(t.error){x(t.error.message||"Failed to send message"),setTimeout(()=>x(""),5e3);return}if(t.data){const o=t.data;_([...N,{id:o.id,content:o.content,sender_id:"me",sender_name:"You",created_at:o.createdAt}]),U(""),p(m=>m.map(S=>S.id===r.id?{...S,last_message:n,last_activity_at:o.createdAt}:S)),j(m=>m&&{...m,last_message:n})}}catch{x("Failed to send message"),setTimeout(()=>x(""),5e3)}},q=async s=>{if(s.length<2)return E([]);try{const i=await(await fetch(`/api/users/search?q=${encodeURIComponent(s)}`,{headers:{Authorization:`Bearer ${c}`}})).json();E(i.users||[])}catch{}},K=async s=>{try{const i=await(await fetch("/api/messaging/conversations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({type:"direct",participantIds:[s]})})).json();if(i.error){x(i.error.message||"Cannot start conversation"),setTimeout(()=>x(""),3e3);return}i.data?.id&&(u(!1),C(),j({id:i.data.id,...i.data}))}catch{}},w=a.useCallback(()=>!r||r.type==="group"?null:r.participants?.find(n=>n.userId!==d)?.userId,[r,d]),W=a.useCallback(async()=>{const s=w();if(!s||!c){f(!1);return}try{const i=await(await fetch(`/api/messaging/block/${s}`,{headers:{Authorization:`Bearer ${c}`}})).json();f(i.data?.isBlocked||!1)}catch{f(!1)}},[w,c]);a.useEffect(()=>{r&&W()},[r,W]);const X=async()=>{const s=w();if(s)try{await fetch(`/api/messaging/block/${s}`,{method:"POST",headers:{Authorization:`Bearer ${c}`}}),f(!0),b(!1)}catch{}},Z=async()=>{const s=w();if(s)try{await fetch(`/api/messaging/block/${s}`,{method:"DELETE",headers:{Authorization:`Bearer ${c}`}}),f(!1),b(!1)}catch{}};a.useEffect(()=>{const s=n=>{M.current&&!M.current.contains(n.target)&&b(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const O=s=>{const n=new Date(s),t=new Date-n;return t<864e5?L(n,"HH:mm"):t<6048e5?L(n,"EEE"):L(n,"MMM d")};return e.jsxs("div",{className:"min-h-screen bg-[#0a0a0f] text-white flex",children:[e.jsxs("div",{className:h("w-full md:w-80 lg:w-96 border-r border-white/5 flex flex-col",r?"hidden md:flex":"flex"),children:[e.jsxs("div",{className:"p-4 border-b border-white/5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ee,{to:"/dashboard",className:"p-2 -ml-2 rounded-xl hover:bg-white/5",children:e.jsx(l.Back,{})}),e.jsx("h1",{className:"text-xl font-semibold",children:"Messages"})]}),e.jsx("button",{onClick:()=>u(!0),className:"p-2 rounded-xl bg-white/5 hover:bg-white/10 transition-all",children:e.jsx(l.Plus,{})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(l.Search,{}),e.jsx("input",{type:"text",placeholder:"Search conversations...",value:J,onChange:s=>Q(s.target.value),className:"w-full pl-10 pr-4 py-2.5 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:border-white/20 text-sm"})]}),e.jsx("div",{className:"flex gap-1 mt-4 p-1 bg-white/5 rounded-xl",children:re.map(s=>e.jsx("button",{onClick:()=>F(s.id),className:h("flex-1 py-2 text-sm font-medium rounded-lg transition-all",g===s.id?"bg-white/10 text-white":"text-gray-400 hover:text-white"),children:s.label},s.id))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:D?e.jsx("div",{className:"p-8 text-center text-gray-500",children:"Loading..."}):B.length===0?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-white/5 flex items-center justify-center",children:e.jsx(l.User,{})}),e.jsx("p",{className:"text-gray-400",children:"No conversations yet"}),e.jsx("button",{onClick:()=>u(!0),className:"mt-4 px-4 py-2 bg-violet-600 rounded-xl text-sm font-medium hover:bg-violet-700 transition-all",children:"Start a conversation"})]}):B.map(s=>e.jsx(y.div,{initial:{opacity:0},animate:{opacity:1},onClick:()=>j(s),className:h("p-4 border-b border-white/5 cursor-pointer transition-all",r?.id===s.id?"bg-white/5":"hover:bg-white/5"),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:h("w-12 h-12 rounded-full flex items-center justify-center",s.type==="group"?"bg-violet-500/20":"bg-white/10"),children:s.type==="group"?e.jsx(l.Users,{}):e.jsx(l.User,{})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium truncate",children:s.display_name||s.name||"Unknown"}),e.jsx("span",{className:"text-xs text-gray-500",children:s.last_activity_at&&O(s.last_activity_at)})]}),e.jsx("p",{className:"text-sm text-gray-400 truncate",children:s.last_message||"No messages yet"})]}),s.unread_count>0&&e.jsx("span",{className:"w-5 h-5 rounded-full bg-violet-500 text-xs font-bold flex items-center justify-center",children:s.unread_count})]})},s.id))})]}),e.jsx("div",{className:h("flex-1 flex flex-col",r?"flex":"hidden md:flex"),children:r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-white/5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>j(null),className:"md:hidden p-2 -ml-2 rounded-xl hover:bg-white/5",children:e.jsx(l.Back,{})}),e.jsx("div",{className:h("w-10 h-10 rounded-full flex items-center justify-center",r.type==="group"?"bg-violet-500/20":"bg-white/10"),children:r.type==="group"?e.jsx(l.Users,{}):e.jsx(l.User,{})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-medium",children:r.display_name||r.name}),e.jsx("span",{className:"text-xs text-gray-500",children:r.type==="group"?"Group":"Direct message"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"p-2 rounded-xl hover:bg-white/5",children:e.jsx(l.Star,{})}),e.jsx("button",{className:"p-2 rounded-xl hover:bg-white/5",children:e.jsx(l.Archive,{})}),e.jsxs("div",{className:"relative",ref:M,children:[e.jsx("button",{onClick:()=>b(!T),className:"p-2 rounded-xl hover:bg-white/5",children:e.jsx(l.More,{})}),T&&e.jsx("div",{className:"absolute right-0 top-full mt-1 w-48 bg-[#1a1a24] border border-white/10 rounded-xl shadow-xl z-50 overflow-hidden",children:r.type==="direct"&&e.jsxs("button",{onClick:k?Z:X,className:"w-full px-4 py-3 text-left text-sm hover:bg-white/5 flex items-center gap-3 text-red-400 hover:text-red-300",children:[e.jsx(l.Block,{}),k?"Unblock User":"Block User"]})})]})]})]}),k&&e.jsx("div",{className:"px-4 py-2 bg-red-500/10 border-b border-red-500/20 text-red-400 text-sm text-center",children:"You have blocked this user. They cannot send you messages."}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[N.map(s=>e.jsx(y.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:h("flex",s.sender_id==="me"?"justify-end":"justify-start"),children:e.jsxs("div",{className:h("max-w-[75%] p-3 rounded-2xl",s.sender_id==="me"?"bg-violet-600 rounded-br-md":"bg-white/10 rounded-bl-md"),children:[s.sender_id!=="me"&&e.jsx("div",{className:"text-xs text-violet-400 mb-1",children:s.sender_name}),e.jsx("p",{className:"text-sm",children:s.content}),e.jsx("div",{className:"text-xs text-white/50 mt-1 text-right",children:O(s.created_at)})]})},s.id)),e.jsx("div",{ref:I})]}),e.jsxs("form",{onSubmit:G,className:"p-4 border-t border-white/5",children:[$&&e.jsx("div",{className:"mb-3 px-4 py-2 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 text-sm",children:$}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("input",{type:"text",value:v,onChange:s=>U(s.target.value),placeholder:"Type a message...",className:"flex-1 px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:border-white/20"}),e.jsx("button",{type:"submit",disabled:!v.trim(),className:"px-5 py-3 bg-violet-600 hover:bg-violet-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-xl transition-all",children:e.jsx(l.Send,{})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"0.1 credits per recipient"})]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-4 rounded-full bg-white/5 flex items-center justify-center",children:e.jsx(l.User,{})}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-gray-400",children:"Choose from your existing conversations or start a new one"})]})})}),e.jsx(te,{children:Y&&e.jsx(y.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4",onClick:()=>u(!1),children:e.jsxs(y.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},onClick:s=>s.stopPropagation(),className:"bg-[#12121a] border border-white/10 rounded-2xl w-full max-w-md overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-white/10 flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"New Message"}),e.jsx("button",{onClick:()=>u(!1),className:"p-2 rounded-xl hover:bg-white/5",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"p-4",children:[e.jsx("input",{type:"text",value:A,onChange:s=>{V(s.target.value),q(s.target.value)},placeholder:"Search for users...",className:"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:border-white/20"}),e.jsxs("div",{className:"mt-4 max-h-64 overflow-y-auto",children:[z.map(s=>e.jsxs("div",{onClick:()=>K(s.id),className:"flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 cursor-pointer",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white/10 flex items-center justify-center",children:e.jsx(l.User,{})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.username}),e.jsx("div",{className:"text-sm text-gray-500",children:s.city||"MuscleMap User"})]})]},s.id)),A.length>=2&&z.length===0&&e.jsx("p",{className:"text-center text-gray-500 py-8",children:"No users found"})]})]})]})})})]})}export{ue as default};
