import{al as g,am as p,an as h,ao as F}from"./index-Bd5HTF5q.js";const q={BUG_REPORT:"bug_report",FEATURE_REQUEST:"feature_request",QUESTION:"question",GENERAL:"general"},N={bug_report:"Report a Bug",feature_request:"Suggest a Feature",question:"Ask a Question",general:"General Feedback"},U={bug_report:"Something isn't working right? Let us know.",feature_request:"Have an idea to make MuscleMap better?",question:"Need help or have a question?",general:"Share your thoughts with us."},V=[{value:"low",label:"Low",description:"Minor issue, workaround exists"},{value:"medium",label:"Medium",description:"Noticeable issue, affects experience"},{value:"high",label:"High",description:"Significant issue, blocks workflow"},{value:"critical",label:"Critical",description:"App is unusable or data is lost"}],c=g(p(h((a,n)=>({isOpen:!1,feedbackType:null,step:"select",openFeedbackModal:(e=null)=>a({isOpen:!0,feedbackType:e,step:e?"form":"select",formData:{...n().initialFormData},submitting:!1,error:null}),closeFeedbackModal:()=>a({isOpen:!1,feedbackType:null,step:"select",formData:{...n().initialFormData},submitting:!1,error:null}),setFeedbackType:e=>a({feedbackType:e,step:"form"}),setStep:e=>a({step:e}),initialFormData:{title:"",description:"",priority:"medium",stepsToReproduce:"",expectedBehavior:"",actualBehavior:"",category:"",attachments:[]},formData:{title:"",description:"",priority:"medium",stepsToReproduce:"",expectedBehavior:"",actualBehavior:"",category:"",attachments:[]},updateFormData:(e,t)=>a(r=>({formData:{...r.formData,[e]:t}})),resetFormData:()=>a(e=>({formData:{...e.initialFormData}})),submitting:!1,error:null,lastSubmittedId:null,setSubmitting:e=>a({submitting:e}),setError:e=>a({error:e}),setSubmissionSuccess:e=>a({submitting:!1,error:null,lastSubmittedId:e,step:"success"}),faqCategories:[],faqEntries:{},faqLoading:!1,faqSearchQuery:"",faqSearchResults:null,expandedFaqId:null,setFaqCategories:e=>a({faqCategories:e}),setFaqEntries:e=>a({faqEntries:e}),setFaqLoading:e=>a({faqLoading:e}),setFaqSearchQuery:e=>a({faqSearchQuery:e}),setFaqSearchResults:e=>a({faqSearchResults:e}),setExpandedFaqId:e=>a(t=>({expandedFaqId:t.expandedFaqId===e?null:e})),popularFeatures:[],popularFeaturesLoading:!1,userVotes:new Set,setPopularFeatures:e=>a({popularFeatures:e}),setPopularFeaturesLoading:e=>a({popularFeaturesLoading:e}),addUserVote:e=>a(t=>{const r=new Set(t.userVotes);return r.add(e),{userVotes:r}}),removeUserVote:e=>a(t=>{const r=new Set(t.userVotes);return r.delete(e),{userVotes:r}}),hasVoted:e=>n().userVotes.has(e),myFeedback:[],myFeedbackLoading:!1,myFeedbackCursor:null,myFeedbackHasMore:!0,setMyFeedback:(e,t=!1)=>a(r=>({myFeedback:t?[...r.myFeedback,...e]:e})),setMyFeedbackLoading:e=>a({myFeedbackLoading:e}),setMyFeedbackCursor:e=>a({myFeedbackCursor:e}),setMyFeedbackHasMore:e=>a({myFeedbackHasMore:e}),getDeviceInfo:()=>typeof window>"u"?{}:{userAgent:navigator.userAgent,screenSize:`${window.innerWidth}x${window.innerHeight}`,platform:navigator.platform,appVersion:"1.0.0"}}),{name:"musclemap-feedback",partialize:a=>({userVotes:Array.from(a.userVotes),faqCategories:a.faqCategories}),onRehydrateStorage:()=>a=>{a&&a.userVotes&&(a.userVotes=new Set(a.userVotes))}}))),G=()=>{const a=c(l=>l.isOpen),n=c(l=>l.feedbackType),e=c(l=>l.step),t=c(l=>l.openFeedbackModal),r=c(l=>l.closeFeedbackModal),i=c(l=>l.setFeedbackType),o=c(l=>l.setStep);return{isOpen:a,feedbackType:n,step:e,openFeedbackModal:t,closeFeedbackModal:r,setFeedbackType:i,setStep:o}},$=()=>{const a=c(o=>o.formData),n=c(o=>o.updateFormData),e=c(o=>o.resetFormData),t=c(o=>o.submitting),r=c(o=>o.error),i=c(o=>o.getDeviceInfo);return{formData:a,updateFormData:n,resetFormData:e,submitting:t,error:r,getDeviceInfo:i}},z=()=>{const a=c(s=>s.faqCategories),n=c(s=>s.faqEntries),e=c(s=>s.faqLoading),t=c(s=>s.faqSearchQuery),r=c(s=>s.faqSearchResults),i=c(s=>s.expandedFaqId),o=c(s=>s.setFaqSearchQuery),l=c(s=>s.setExpandedFaqId);return{categories:a,entries:n,loading:e,searchQuery:t,searchResults:r,expandedId:i,setSearchQuery:o,toggleExpanded:l}},u={IDLE:"idle",SYNCING:"syncing",SUCCESS:"success",ERROR:"error",CONFLICT:"conflict"},b={CLIENT_WINS:"client_wins",SERVER_WINS:"server_wins",MERGE:"merge",MANUAL:"manual"},f={WORKOUT:"workout",SET:"set",UNKNOWN:"unknown"};function m(a,n={}){return navigator.serviceWorker?.controller?new Promise(e=>{const t=new MessageChannel;t.port1.onmessage=r=>{e(r.data)},navigator.serviceWorker.controller.postMessage({type:a,payload:n},[t.port2]),setTimeout(()=>e(null),5e3)}):Promise.resolve(null)}async function T(){return m("GET_SYNC_STATUS")}async function x(){return m("GET_QUEUE_STATUS")}async function D(){return m("FORCE_SYNC")}async function I(a,n){return m("RESOLVE_CONFLICT",{id:a,resolution:n})}async function A(a){return m("CACHE_EXERCISES",{exercises:a})}async function M(){return m("GET_CACHED_EXERCISES")}g(p(h((a,n)=>({isOnline:typeof navigator<"u"?navigator.onLine:!0,lastOnlineAt:null,lastOfflineAt:null,offlineDuration:0,syncStatus:u.IDLE,lastSyncAttempt:null,lastSuccessfulSync:null,syncError:null,syncProgress:0,pendingCount:0,pendingWorkouts:0,pendingSets:0,pendingOther:0,failedCount:0,conflictCount:0,conflicts:[],defaultResolutionStrategy:b.SERVER_WINS,exerciseCacheCount:0,lastExerciseCacheUpdate:null,exerciseCacheExpiry:30*24*60*60*1e3,queueDetails:[],setOnline:()=>{const e=Date.now(),t=n().lastOfflineAt,r=t?e-t:0;a({isOnline:!0,lastOnlineAt:e,offlineDuration:r}),n().refreshSyncStatus(),n().triggerSync()},setOffline:()=>{a({isOnline:!1,lastOfflineAt:Date.now()})},setSyncStatus:e=>a({syncStatus:e}),setSyncProgress:e=>a({syncProgress:e}),setSyncError:e=>a({syncStatus:u.ERROR,syncError:e}),clearSyncError:()=>a({syncError:null,syncStatus:u.IDLE}),refreshSyncStatus:async()=>{try{const e=await T();e&&a({pendingCount:e.pending||0,failedCount:e.failed||0,conflictCount:e.conflicts||0,lastSyncAttempt:e.lastAttempt,lastSuccessfulSync:e.lastSuccess});const t=await x();t&&a({pendingCount:t.count||0,conflictCount:t.conflictCount||0,queueDetails:t.syncQueue||[],conflicts:t.conflicts||[]})}catch{}},triggerSync:async()=>{if(!n().isOnline)return!1;a({syncStatus:u.SYNCING,syncProgress:0});try{return await D(),a({syncStatus:u.SUCCESS,lastSuccessfulSync:Date.now(),syncProgress:100}),await n().refreshSyncStatus(),!0}catch(e){return a({syncStatus:u.ERROR,syncError:e.message||"Sync failed"}),!1}},incrementPending:(e=f.UNKNOWN)=>{const t={pendingCount:n().pendingCount+1};e===f.WORKOUT?t.pendingWorkouts=n().pendingWorkouts+1:e===f.SET?t.pendingSets=n().pendingSets+1:t.pendingOther=n().pendingOther+1,a(t)},decrementPending:(e=f.UNKNOWN)=>{const t={pendingCount:Math.max(0,n().pendingCount-1)};e===f.WORKOUT?t.pendingWorkouts=Math.max(0,n().pendingWorkouts-1):e===f.SET?t.pendingSets=Math.max(0,n().pendingSets-1):t.pendingOther=Math.max(0,n().pendingOther-1),a(t)},clearPending:()=>a({pendingCount:0,pendingWorkouts:0,pendingSets:0,pendingOther:0,failedCount:0,queueDetails:[]}),setConflicts:e=>a({conflicts:e,conflictCount:e.length}),addConflict:e=>{const t=[...n().conflicts,e];a({conflicts:t,conflictCount:t.length,syncStatus:u.CONFLICT})},resolveConflict:async(e,t)=>{try{await I(e,t);const r=n().conflicts.filter(i=>i.id!==e);return a({conflicts:r,conflictCount:r.length,syncStatus:r.length===0?u.IDLE:u.CONFLICT}),t!==b.MANUAL&&await n().triggerSync(),!0}catch{return!1}},resolveAllConflicts:async()=>{const{conflicts:e,defaultResolutionStrategy:t}=n();for(const r of e)await n().resolveConflict(r.id,t)},setDefaultResolutionStrategy:e=>a({defaultResolutionStrategy:e}),cacheExercises:async e=>{try{const t=await A(e);return t?.count&&a({exerciseCacheCount:t.count,lastExerciseCacheUpdate:Date.now()}),t?.count||0}catch{return 0}},refreshExerciseCacheStatus:async()=>{try{const e=await M();e?.count!==void 0&&a({exerciseCacheCount:e.count})}catch{}},isExerciseCacheStale:()=>{const{lastExerciseCacheUpdate:e,exerciseCacheExpiry:t}=n();return e?Date.now()-e>t:!0},initialize:()=>{a({isOnline:navigator.onLine}),window.addEventListener("online",()=>n().setOnline()),window.addEventListener("offline",()=>n().setOffline()),navigator.serviceWorker&&navigator.serviceWorker.addEventListener("message",e=>{const{type:t,...r}=e.data||{};switch(t){case"SYNC_SUCCESS":n().decrementPending(r.operation);break;case"SYNC_FAILED":a({failedCount:n().failedCount+1});break;case"SYNC_CONFLICT":n().addConflict({id:Date.now(),operation:r.operation,resourceId:r.resourceId,createdAt:Date.now()});break;case"QUEUE_STATUS":a({pendingCount:r.count||0,conflictCount:r.conflictCount||0,queueDetails:r.syncQueue||[],conflicts:r.conflicts||[]});break;case"SYNC_STATUS":a({pendingCount:r.pending||0,failedCount:r.failed||0,conflictCount:r.conflicts||0,lastSyncAttempt:r.lastAttempt,lastSuccessfulSync:r.lastSuccess});break;case"EXERCISES_CACHED":a({exerciseCacheCount:r.count||0,lastExerciseCacheUpdate:Date.now()});break}}),n().refreshSyncStatus(),n().refreshExerciseCacheStatus()}}),{name:"musclemap-offline",partialize:a=>({defaultResolutionStrategy:a.defaultResolutionStrategy,exerciseCacheExpiry:a.exerciseCacheExpiry})})));async function d(a,n,e){const t=localStorage.getItem("musclemap_token"),r={"Content-Type":"application/json"};t&&(r.Authorization=`Bearer ${t}`);const i=await fetch(`/api${n}`,{method:a,headers:r,body:e?JSON.stringify(e):void 0});if(!i.ok){const o=await i.json().catch(()=>({}));throw new Error(o.error?.message||"Request failed")}return i.json()}const O={loginStatus:null,loginCalendar:[],streaks:[],totalCurrentDays:0,totalLongestDays:0,dailyChallenges:[],weeklyChallenge:null,activeEvents:[],upcomingEvents:[],currentMultipliers:{credits:1,xp:1,challenges:1},recoveryScore:null,restDayActivities:[],loading:{login:!1,streaks:!1,challenges:!1,events:!1,recovery:!1},error:null,showDailyRewardModal:!1,showStreakAtRiskModal:!1,lastClaimedReward:null};g()(h((a,n)=>({...O,fetchLoginStatus:async()=>{a(e=>({loading:{...e.loading,login:!0},error:null}));try{const e=await d("GET","/daily-login/status");a({loginStatus:e,showStreakAtRiskModal:e.streakAtRisk&&e.streakFreezesOwned>0,loading:{...n().loading,login:!1}})}catch(e){a({error:e instanceof Error?e.message:"Failed to fetch login status",loading:{...n().loading,login:!1}})}},claimDailyReward:async(e=!1)=>{a(t=>({loading:{...t.loading,login:!0},error:null}));try{const t=await d("POST","/daily-login/claim",{useFreeze:e});a({lastClaimedReward:t,showDailyRewardModal:!0,loading:{...n().loading,login:!1}}),await n().fetchLoginStatus()}catch(t){a({error:t instanceof Error?t.message:"Failed to claim reward",loading:{...n().loading,login:!1}})}},purchaseStreakFreeze:async()=>{a(e=>({loading:{...e.loading,login:!0},error:null}));try{await d("POST","/daily-login/purchase-freeze"),await n().fetchLoginStatus()}catch(e){a({error:e instanceof Error?e.message:"Failed to purchase freeze",loading:{...n().loading,login:!1}})}},fetchLoginCalendar:async(e=30)=>{try{const t=await d("GET",`/daily-login/calendar?days=${e}`);a({loginCalendar:t})}catch{}},fetchAllStreaks:async()=>{a(e=>({loading:{...e.loading,streaks:!0},error:null}));try{const e=await d("GET","/streaks");a({streaks:e.streaks,totalCurrentDays:e.totalCurrentDays,totalLongestDays:e.totalLongestDays,loading:{...n().loading,streaks:!1}})}catch(e){a({error:e instanceof Error?e.message:"Failed to fetch streaks",loading:{...n().loading,streaks:!1}})}},fetchStreak:async e=>{try{return await d("GET",`/streaks/${e}`)}catch{return null}},claimStreakMilestone:async(e,t)=>{try{await d("POST",`/streaks/${e}/claim`,{milestoneDays:t}),await n().fetchAllStreaks()}catch(r){a({error:r instanceof Error?r.message:"Failed to claim milestone"})}},fetchDailyChallenges:async()=>{a(e=>({loading:{...e.loading,challenges:!0},error:null}));try{const e=await d("GET","/challenges/daily");a({dailyChallenges:e,loading:{...n().loading,challenges:!1}})}catch(e){a({error:e instanceof Error?e.message:"Failed to fetch challenges",loading:{...n().loading,challenges:!1}})}},claimChallengeReward:async e=>{try{await d("POST",`/challenges/daily/claim/${e}`),await n().fetchDailyChallenges()}catch(t){a({error:t instanceof Error?t.message:"Failed to claim challenge"})}},fetchWeeklyChallenge:async()=>{try{const e=await d("GET","/challenges/weekly");a({weeklyChallenge:e})}catch{}},claimWeeklyChallengeReward:async()=>{try{await d("POST","/challenges/weekly/claim"),await n().fetchWeeklyChallenge()}catch(e){a({error:e instanceof Error?e.message:"Failed to claim weekly challenge"})}},fetchActiveEvents:async()=>{a(e=>({loading:{...e.loading,events:!0},error:null}));try{const e=await d("GET","/events/active");a({activeEvents:e,loading:{...n().loading,events:!1}})}catch(e){a({error:e instanceof Error?e.message:"Failed to fetch events",loading:{...n().loading,events:!1}})}},fetchUpcomingEvents:async()=>{try{const e=await d("GET","/events/upcoming");a({upcomingEvents:e})}catch{}},joinEvent:async e=>{try{await d("POST",`/events/${e}/join`),await n().fetchActiveEvents()}catch(t){a({error:t instanceof Error?t.message:"Failed to join event"})}},fetchMultipliers:async()=>{try{const e=await d("GET","/events/multipliers");a({currentMultipliers:e})}catch{}},fetchRecoveryScore:async()=>{a(e=>({loading:{...e.loading,recovery:!0},error:null}));try{const e=await d("GET","/engagement/recovery/today");a({recoveryScore:e,loading:{...n().loading,recovery:!1}})}catch(e){a({error:e instanceof Error?e.message:"Failed to fetch recovery score",loading:{...n().loading,recovery:!1}})}},logRestDayActivity:async(e,t={})=>{try{await d("POST","/engagement/recovery/log-activity",{activityType:e,metadata:t}),await n().fetchRestDayActivities(),await n().fetchRecoveryScore()}catch(r){a({error:r instanceof Error?r.message:"Failed to log activity"})}},fetchRestDayActivities:async()=>{try{const e=await d("GET","/engagement/recovery/activities");a({restDayActivities:e})}catch{}},setShowDailyRewardModal:e=>a({showDailyRewardModal:e}),setShowStreakAtRiskModal:e=>a({showStreakAtRiskModal:e}),clearLastClaimedReward:()=>a({lastClaimedReward:null}),clearError:()=>a({error:null}),initializeEngagement:async()=>{const e=n();await Promise.all([e.fetchLoginStatus(),e.fetchAllStreaks(),e.fetchDailyChallenges(),e.fetchWeeklyChallenge(),e.fetchActiveEvents(),e.fetchMultipliers(),e.fetchRecoveryScore()])}}),{name:"musclemap-engagement",storage:F(()=>localStorage),partialize:a=>({loginCalendar:a.loginCalendar,currentMultipliers:a.currentMultipliers})}));const y=[{id:"current_path",type:"current_path",x:0,y:0,w:2,h:1,visible:!0,settings:{}},{id:"stats",type:"stats",x:2,y:0,w:1,h:2,visible:!0,settings:{}},{id:"quick_actions",type:"quick_actions",x:0,y:1,w:3,h:1,visible:!0,settings:{}},{id:"xp_progress",type:"xp_progress",x:0,y:2,w:1,h:1,visible:!0,settings:{}},{id:"daily_quests",type:"daily_quests",x:1,y:2,w:1,h:1,visible:!0,settings:{}},{id:"insights",type:"insights",x:0,y:3,w:3,h:1,visible:!0,settings:{}},{id:"daily_challenges",type:"daily_challenges",x:0,y:4,w:2,h:1,visible:!0,settings:{}},{id:"todays_workout",type:"todays_workout",x:0,y:5,w:1,h:1,visible:!0,settings:{}},{id:"weekly_progress",type:"weekly_progress",x:1,y:5,w:1,h:1,visible:!0,settings:{}},{id:"nutrition",type:"nutrition",x:0,y:6,w:2,h:1,visible:!0,settings:{}},{id:"muscle_map",type:"muscle_map",x:0,y:7,w:2,h:2,visible:!0,settings:{}},{id:"daily_tip",type:"daily_tip",x:0,y:9,w:2,h:1,visible:!0,settings:{}},{id:"milestones",type:"milestones",x:0,y:10,w:2,h:1,visible:!0,settings:{}},{id:"adventure_map",type:"adventure_map",x:0,y:11,w:2,h:2,visible:!0,settings:{}},{id:"activity",type:"activity",x:0,y:13,w:2,h:2,visible:!0,settings:{}},{id:"hydration",type:"hydration",x:2,y:2,w:1,h:1,visible:!0,settings:{}},{id:"music_player",type:"music_player",x:2,y:3,w:1,h:1,visible:!1,settings:{}},{id:"coach_tips",type:"coach_tips",x:2,y:4,w:1,h:1,visible:!0,settings:{}}],E=()=>localStorage.getItem("musclemap_token");async function v(a,n={}){const e=E(),t={"Content-Type":"application/json",...n.headers||{}};return e&&(t.Authorization=`Bearer ${e}`),fetch(a,{...n,headers:t})}g()(p(h((a,n)=>({widgets:y,columns:12,rowHeight:100,platform:"web",isEditMode:!1,availableWidgets:[],isLoading:!1,isSaving:!1,error:null,loadLayout:async()=>{if(E()){a({isLoading:!0,error:null});try{const t=await v("/api/me/dashboard/layout?platform=web");if(!t.ok)throw new Error("Failed to load layout");const r=await t.json();r.success&&r.data?.layout?a({widgets:r.data.layout.widgets||y,columns:r.data.layout.columns||12,rowHeight:r.data.layout.rowHeight||100,isLoading:!1}):a({widgets:y,isLoading:!1})}catch{a({error:"Failed to load layout",isLoading:!1})}}},saveLayout:async()=>{if(!E())return;const{widgets:t,columns:r,rowHeight:i}=n();a({isSaving:!0,error:null});try{if(!(await v("/api/me/dashboard/layout?platform=web",{method:"PUT",body:JSON.stringify({widgets:t,columns:r,rowHeight:i})})).ok)throw new Error("Failed to save layout");a({isSaving:!1})}catch{a({error:"Failed to save layout",isSaving:!1})}},loadAvailableWidgets:async()=>{try{const e=await v("/api/me/dashboard/widgets");if(!e.ok)throw new Error("Failed to load widgets");const t=await e.json();t.success&&t.data?.widgets&&a({availableWidgets:t.data.widgets})}catch{a({error:"Failed to load available widgets"})}},addWidget:e=>{const{widgets:t,availableWidgets:r}=n();if(t.some(s=>s.type===e)){a({widgets:t.map(s=>s.type===e?{...s,visible:!0}:s)});return}const i=r.find(s=>s.id===e);if(!i)return;const o=t.reduce((s,w)=>Math.max(s,w.y+w.h),0),l={id:`${e}_${Date.now()}`,type:e,x:0,y:o,w:i.defaultWidth,h:i.defaultHeight,visible:!0,settings:{}};a({widgets:[...t,l]})},removeWidget:e=>{a(t=>({widgets:(Array.isArray(t.widgets)?t.widgets:y).filter(r=>r.id!==e)}))},updateWidget:(e,t)=>{a(r=>({widgets:(Array.isArray(r.widgets)?r.widgets:y).map(i=>i.id===e?{...i,...t}:i)}))},moveWidget:(e,t,r)=>{a(i=>({widgets:(Array.isArray(i.widgets)?i.widgets:y).map(o=>o.id===e?{...o,x:t,y:r}:o)}))},resizeWidget:(e,t,r)=>{a(i=>({widgets:i.widgets.map(o=>o.id===e?{...o,w:t,h:r}:o)}))},toggleWidgetVisibility:e=>{a(t=>({widgets:t.widgets.map(r=>r.id===e?{...r,visible:!r.visible}:r)}))},updateWidgetSettings:(e,t)=>{a(r=>({widgets:r.widgets.map(i=>i.id===e?{...i,settings:{...i.settings,...t}}:i)}))},toggleEditMode:()=>{const{isEditMode:e,saveLayout:t}=n();e&&t(),a({isEditMode:!e})},resetToDefault:async()=>{a({widgets:y}),await n().saveLayout()},setColumns:e=>a({columns:e}),setRowHeight:e=>a({rowHeight:e}),updateLayout:e=>{a(t=>({widgets:t.widgets.map(r=>{const i=e.find(o=>o.i===r.id);return i?{...r,x:i.x,y:i.y,w:i.w,h:i.h}:r})}))}}),{name:"musclemap-dashboard",partialize:a=>({widgets:a.widgets,columns:a.columns,rowHeight:a.rowHeight})})));const k=()=>localStorage.getItem("musclemap_token");async function C(a,n={}){const e=k(),t={"Content-Type":"application/json",...n.headers||{}};return e&&(t.Authorization=`Bearer ${e}`),fetch(a,{...n,headers:t})}function P(){return`hydration_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function L(a){const n=new Date;return a.getDate()===n.getDate()&&a.getMonth()===n.getMonth()&&a.getFullYear()===n.getFullYear()}g()(p(h((a,n)=>({todayLogs:[],currentIntake:0,dailyGoal:64,remindersEnabled:!0,reminderIntervalMinutes:15,lastReminderAt:null,nextReminderAt:null,reminderTimerId:null,showDuringWorkout:!0,workoutMode:!1,soundEnabled:!0,vibrationEnabled:!0,isLoading:!1,isSyncing:!1,logWater:e=>{const t={id:P(),amount:e,timestamp:new Date};a(r=>({todayLogs:[...r.todayLogs,t],currentIntake:r.currentIntake+e})),n().syncToServer(e),n().remindersEnabled&&n().scheduleNextReminder()},undoLastLog:()=>{const{todayLogs:e}=n();if(e.length===0)return;const t=e[e.length-1];a(r=>({todayLogs:r.todayLogs.slice(0,-1),currentIntake:Math.max(0,r.currentIntake-t.amount)}))},setDailyGoal:e=>{a({dailyGoal:e})},enableReminders:()=>{a({remindersEnabled:!0}),n().scheduleNextReminder()},disableReminders:()=>{const{reminderTimerId:e}=n();e&&clearTimeout(e),a({remindersEnabled:!1,reminderTimerId:null,nextReminderAt:null})},setReminderInterval:e=>{a({reminderIntervalMinutes:e}),n().remindersEnabled&&n().scheduleNextReminder()},snoozeReminder:(e=5)=>{const t=new Date(Date.now()+e*60*1e3);a({nextReminderAt:t}),n().scheduleReminderAt(t)},dismissReminder:()=>{a({lastReminderAt:new Date}),n().remindersEnabled&&n().scheduleNextReminder()},enterWorkoutMode:()=>{a({workoutMode:!0})},exitWorkoutMode:()=>{a({workoutMode:!1})},updateSettings:e=>{a(t=>({remindersEnabled:e.enabled??t.remindersEnabled,reminderIntervalMinutes:e.intervalMinutes??t.reminderIntervalMinutes,soundEnabled:e.soundEnabled??t.soundEnabled,vibrationEnabled:e.vibrationEnabled??t.vibrationEnabled,showDuringWorkout:e.showDuringWorkout??t.showDuringWorkout,dailyGoal:e.dailyGoalOz??t.dailyGoal})),e.enabled!==!1&&n().remindersEnabled&&n().scheduleNextReminder()},loadFromServer:async()=>{if(k()){a({isLoading:!0});try{const t=await C("/api/me/hydration/today");if(!t.ok)throw new Error("Failed to load hydration");const r=await t.json();if(r.success&&r.data){const i=(r.data.logs||[]).map(l=>({id:l.id,amount:l.amount_oz,timestamp:new Date(l.logged_at)})),o=i.reduce((l,s)=>l+s.amount,0);a({todayLogs:i,currentIntake:o,isLoading:!1})}}catch{a({isLoading:!1})}}},syncToServer:async e=>{if(k()){a({isSyncing:!0});try{await C("/api/me/hydration",{method:"POST",body:JSON.stringify({amount_oz:e})})}catch{}finally{a({isSyncing:!1})}}},resetForNewDay:()=>{a({todayLogs:[],currentIntake:0,lastReminderAt:null})},scheduleNextReminder:()=>{const{reminderIntervalMinutes:e,reminderTimerId:t}=n();t&&clearTimeout(t);const r=new Date(Date.now()+e*60*1e3);a({nextReminderAt:r}),n().scheduleReminderAt(r)},scheduleReminderAt:e=>{const t=e.getTime()-Date.now();if(t<=0)return;const r=window.setTimeout(()=>{const{workoutMode:i,showDuringWorkout:o}=n();if(i&&!o){n().scheduleNextReminder();return}n().triggerReminder()},t);a({reminderTimerId:r})},triggerReminder:()=>{const{soundEnabled:e,vibrationEnabled:t}=n();if(e)try{const r=new AudioContext,i=r.createOscillator(),o=r.createGain();i.connect(o),o.connect(r.destination),i.frequency.value=800,i.type="sine",o.gain.value=.3,i.start(),i.stop(r.currentTime+.2)}catch{}t&&"vibrate"in navigator&&navigator.vibrate([200,100,200]),window.dispatchEvent(new CustomEvent("hydration-reminder",{detail:{currentIntake:n().currentIntake,dailyGoal:n().dailyGoal}})),a({lastReminderAt:new Date})}}),{name:"musclemap-hydration",partialize:a=>({todayLogs:a.todayLogs,currentIntake:a.currentIntake,dailyGoal:a.dailyGoal,remindersEnabled:a.remindersEnabled,reminderIntervalMinutes:a.reminderIntervalMinutes,soundEnabled:a.soundEnabled,vibrationEnabled:a.vibrationEnabled,showDuringWorkout:a.showDuringWorkout}),onRehydrate:a=>n=>{if(n&&n.todayLogs.length>0){const e=n.todayLogs[n.todayLogs.length-1];L(new Date(e.timestamp))||n.resetForNewDay()}n?.remindersEnabled&&setTimeout(()=>{n.scheduleNextReminder()},1e3)}})));const _=()=>localStorage.getItem("musclemap_token");async function S(a,n={}){const e=_(),t={"Content-Type":"application/json",...n.headers||{}};return e&&(t.Authorization=`Bearer ${e}`),fetch(a,{...n,headers:t})}g()(p(h((a,n)=>({connections:[],activeProvider:null,isConnecting:!1,connectionError:null,isPlaying:!1,currentTrack:null,queue:[],progress:0,progressMs:0,volume:70,isMuted:!1,shuffle:!1,repeat:"off",playlists:[],selectedPlaylistId:null,isLoadingPlaylists:!1,autoPlayOnWorkout:!0,bpmMatchingEnabled:!1,targetBpm:null,fadeOnRest:!0,isExpanded:!1,showMiniPlayer:!0,connect:async e=>{a({isConnecting:!0,connectionError:null});try{const t=await S(`/api/me/music/connect/${e}`,{method:"POST"});if(!t.ok)throw new Error("Failed to initiate connection");const r=await t.json();if(r.data?.authUrl){const l=window.screenX+(window.outerWidth-500)/2,s=window.screenY+(window.outerHeight-600)/2,w=window.open(r.data.authUrl,`${e}_auth`,`width=500,height=600,left=${l},top=${s}`),R=setInterval(async()=>{w?.closed&&(clearInterval(R),await n().refreshConnections(),a({isConnecting:!1}))},500)}}catch(t){a({isConnecting:!1,connectionError:t instanceof Error?t.message:"Connection failed"})}},disconnect:async e=>{try{await S(`/api/me/music/disconnect/${e}`,{method:"DELETE"}),a(t=>({connections:t.connections.filter(r=>r.provider!==e),activeProvider:t.activeProvider===e?null:t.activeProvider})),n().activeProvider===e&&(n().pause(),a({currentTrack:null,isPlaying:!1}))}catch{}},setActiveProvider:e=>{a({activeProvider:e}),e&&n().loadPlaylists()},refreshConnections:async()=>{try{const e=await S("/api/me/music/status");if(!e.ok)return;const t=await e.json();if(t.success&&t.data?.connections){const r=t.data.connections.map(i=>({provider:i.provider,connected:!0,connectedAt:new Date(i.connected_at),expiresAt:i.token_expires_at?new Date(i.token_expires_at):void 0}));a({connections:r}),!n().activeProvider&&r.length>0&&a({activeProvider:r[0].provider})}}catch{}},play:()=>{const{activeProvider:e}=n();e&&a({isPlaying:!0})},pause:()=>{const{activeProvider:e}=n();e&&a({isPlaying:!1})},toggle:()=>{const{isPlaying:e}=n();e?n().pause():n().play()},next:()=>{const{activeProvider:e,queue:t}=n();e&&t.length>0&&a({queue:t.slice(1)})},previous:()=>{const{activeProvider:e,progressMs:t}=n();if(e&&t>3e3){n().seek(0);return}},seek:e=>{const{activeProvider:t,currentTrack:r}=n();if(!t||!r)return;const i=e/r.durationMs*100;a({progressMs:e,progress:i})},setVolume:e=>{const{activeProvider:t}=n();a({volume:e,isMuted:e===0})},toggleMute:()=>{const{isMuted:e,volume:t}=n();e?n().setVolume(t||70):n().setVolume(0),a({isMuted:!e})},toggleShuffle:()=>{a(e=>({shuffle:!e.shuffle}))},cycleRepeat:()=>{a(e=>{const t=["off","context","track"],r=t.indexOf(e.repeat);return{repeat:t[(r+1)%t.length]}})},playTrack:e=>{const{activeProvider:t}=n();t&&a({currentTrack:e,isPlaying:!0,progressMs:0,progress:0})},addToQueue:e=>{a(t=>({queue:[...t.queue,e]}))},clearQueue:()=>{a({queue:[]})},loadPlaylists:async()=>{const{activeProvider:e}=n();if(e){a({isLoadingPlaylists:!0});try{const t=await S("/api/me/music/playlists");if(!t.ok)throw new Error("Failed to load playlists");const r=await t.json();if(r.success&&r.data?.playlists){const i=r.data.playlists.map(o=>({id:o.id,name:o.name,description:o.description,imageUrl:o.images?.[0]?.url,trackCount:o.tracks?.total||0,provider:e,uri:o.uri}));a({playlists:i,isLoadingPlaylists:!1})}}catch{a({isLoadingPlaylists:!1})}}},selectPlaylist:e=>{a({selectedPlaylistId:e})},playPlaylist:(e,t=!1)=>{const{activeProvider:r,playlists:i}=n();!r||!i.find(l=>l.id===e)||a({shuffle:t,selectedPlaylistId:e})},setAutoPlayOnWorkout:e=>{a({autoPlayOnWorkout:e})},setBpmMatching:(e,t)=>{a({bpmMatchingEnabled:e,targetBpm:t||null})},setFadeOnRest:e=>{a({fadeOnRest:e})},startWorkoutPlayback:()=>{const{autoPlayOnWorkout:e,selectedPlaylistId:t}=n();e&&t&&n().playPlaylist(t)},pauseForRest:()=>{const{fadeOnRest:e,volume:t}=n();if(e){const i=t/10;let o=0;const l=setInterval(()=>{o++;const s=Math.max(0,t-i*o);n().setVolume(s),o>=10&&(clearInterval(l),n().pause())},100)}else n().pause()},resumeAfterRest:()=>{const{fadeOnRest:e}=n(),t=70;if(n().play(),e){const i=t/10;let o=0;n().setVolume(0);const l=setInterval(()=>{o++;const s=Math.min(t,i*o);n().setVolume(s),o>=10&&clearInterval(l)},100)}},toggleExpanded:()=>{a(e=>({isExpanded:!e.isExpanded}))},setShowMiniPlayer:e=>{a({showMiniPlayer:e})},updatePlaybackState:e=>{a(e)}}),{name:"musclemap-music",partialize:a=>({activeProvider:a.activeProvider,volume:a.volume,shuffle:a.shuffle,repeat:a.repeat,autoPlayOnWorkout:a.autoPlayOnWorkout,bpmMatchingEnabled:a.bpmMatchingEnabled,targetBpm:a.targetBpm,fadeOnRest:a.fadeOnRest,showMiniPlayer:a.showMiniPlayer,selectedPlaylistId:a.selectedPlaylistId})})));export{N as F,V as P,c as a,U as b,q as c,$ as d,z as e,G as u};
