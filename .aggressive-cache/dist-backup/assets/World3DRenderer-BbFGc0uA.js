var p=Object.defineProperty;var M=(c,e,t)=>e in c?p(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var n=(c,e,t)=>M(c,typeof e!="symbol"?e+"":e,t);import{_ as f}from"./index-KAEVVvQC.js";import{p as w,g as E}from"./MapExplore-D-okNYHL.js";import"./react-vendor-D847gc3Q.js";import"./leaflet-vendor-DZbo3Ov0.js";import"./apollo-vendor-BNHFeEEc.js";import"./reactflow-vendor-CYb5nRwM.js";import"./d3-vendor-mcDw60ct.js";import"./recharts-vendor-CxtoZpzE.js";import"./building-2-CMC6RdCb.js";import"./gauge-CiSiLrHL.js";import"./arrow-left-ChdADQnB.js";import"./minimize-2-CXSCHYL-.js";class D{constructor(){n(this,"THREE",null);n(this,"container",null);n(this,"scene",null);n(this,"camera",null);n(this,"renderer",null);n(this,"data",null);n(this,"nodeMeshes",new Map);n(this,"globeMesh",null);n(this,"animationId",null);n(this,"fps",60);n(this,"frameCount",0);n(this,"lastFrameTime",0);n(this,"raycaster",null);n(this,"mouse",null);n(this,"onClickCallback",null);n(this,"onHoverCallback",null);n(this,"hoveredMesh",null);n(this,"activeNodeId",null);n(this,"rotationSpeed",.001);n(this,"isUserInteracting",!1);n(this,"mouseDownTime",0);n(this,"startRenderLoop",()=>{const e=t=>{this.frameCount++,t-this.lastFrameTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFrameTime=t),this.globeMesh&&!this.isUserInteracting&&(this.globeMesh.rotation.y+=this.rotationSpeed,this.nodeMeshes.forEach(i=>{i.position.applyAxisAngle(new this.THREE.Vector3(0,1,0),this.rotationSpeed)})),this.nodeMeshes.forEach(i=>{const s=i===this.hoveredMesh,o=i.userData.node?.id===this.activeNodeId?1.5:s?1.3:1;i.scale.lerp(new this.THREE.Vector3(o,o,o),.1)}),this.renderer?.render(this.scene,this.camera),this.animationId=requestAnimationFrame(e)};this.animationId=requestAnimationFrame(e)});n(this,"handleMouseMove",e=>{if(!this.renderer||!this.THREE)return;const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const i=this.raycaster.intersectObjects(Array.from(this.nodeMeshes.values()));if(i.length>0){const s=i[0].object;s!==this.hoveredMesh&&(this.hoveredMesh=s,this.renderer.domElement.style.cursor="pointer",this.onHoverCallback?.(s.userData.node))}else this.hoveredMesh&&(this.hoveredMesh=null,this.renderer.domElement.style.cursor="grab",this.onHoverCallback?.(null));if(this.isUserInteracting&&e.buttons===1){const s=e.movementX*.005,r=e.movementY*.005;this.globeMesh&&(this.globeMesh.rotation.y+=s,this.globeMesh.rotation.x+=r,this.globeMesh.rotation.x=Math.max(-Math.PI/4,Math.min(Math.PI/4,this.globeMesh.rotation.x))),this.nodeMeshes.forEach(o=>{o.position.applyAxisAngle(new this.THREE.Vector3(0,1,0),s),o.position.applyAxisAngle(new this.THREE.Vector3(1,0,0),r)})}});n(this,"handleMouseDown",()=>{this.isUserInteracting=!0,this.mouseDownTime=performance.now(),this.renderer&&(this.renderer.domElement.style.cursor="grabbing")});n(this,"handleMouseUp",()=>{this.isUserInteracting=!1,this.renderer&&(this.renderer.domElement.style.cursor=this.hoveredMesh?"pointer":"grab")});n(this,"handleClick",()=>{performance.now()-this.mouseDownTime<200&&this.hoveredMesh&&this.onClickCallback?.(this.hoveredMesh.userData.node)});n(this,"handleWheel",e=>{if(!this.camera)return;const t=e.deltaY>0?.2:-.2,i=Math.max(2.5,Math.min(6,this.camera.position.z+t));this.camera.position.z=i})}async initialize(e,t){const i=w.start("world3dRenderer.init");this.THREE=await f(()=>import("./three-vendor-y9bq9ss_.js").then(r=>r.ax),[]),this.container=e,this.data=t,this.scene=new this.THREE.Scene,this.scene.background=new this.THREE.Color(657935);const s=e.clientWidth/e.clientHeight;this.camera=new this.THREE.PerspectiveCamera(60,s,.1,1e3),this.camera.position.set(0,0,4),this.renderer=new this.THREE.WebGLRenderer({antialias:!0,powerPreference:"high-performance",stencil:!1}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.renderer.setPixelRatio(E("high")),e.appendChild(this.renderer.domElement),this.raycaster=new this.THREE.Raycaster,this.mouse=new this.THREE.Vector2,this.createGlobe(),this.createNodeMarkers(),this.setupLighting(),this.renderer.domElement.addEventListener("mousemove",this.handleMouseMove),this.renderer.domElement.addEventListener("click",this.handleClick),this.renderer.domElement.addEventListener("mousedown",this.handleMouseDown),this.renderer.domElement.addEventListener("mouseup",this.handleMouseUp),this.renderer.domElement.addEventListener("wheel",this.handleWheel,{passive:!0}),this.startRenderLoop(),i()}createGlobe(){if(!this.THREE||!this.scene)return;const e=new this.THREE.SphereGeometry(1.8,48,48),t=new this.THREE.MeshBasicMaterial({color:1710638,wireframe:!0,transparent:!0,opacity:.3});this.globeMesh=new this.THREE.Mesh(e,t),this.scene.add(this.globeMesh);const i=new this.THREE.SphereGeometry(1.7,32,32),s=new this.THREE.MeshBasicMaterial({color:26367,transparent:!0,opacity:.05}),r=new this.THREE.Mesh(i,s);this.scene.add(r),this.createGridLines()}createGridLines(){if(!this.THREE||!this.scene)return;const e=new this.THREE.LineBasicMaterial({color:26367,transparent:!0,opacity:.1});for(let t=-60;t<=60;t+=30){const i=t*Math.PI/180,s=1.85*Math.cos(i),r=1.85*Math.sin(i),o=[];for(let l=0;l<=64;l++){const d=l/64*Math.PI*2;o.push(new this.THREE.Vector3(s*Math.cos(d),r,s*Math.sin(d)))}const h=new this.THREE.BufferGeometry().setFromPoints(o),a=new this.THREE.Line(h,e);this.scene.add(a)}for(let t=0;t<12;t++){const i=t/12*Math.PI*2,s=[];for(let h=0;h<=64;h++){const a=(h/64-.5)*Math.PI;s.push(new this.THREE.Vector3(1.85*Math.cos(a)*Math.cos(i),1.85*Math.sin(a),1.85*Math.cos(a)*Math.sin(i)))}const r=new this.THREE.BufferGeometry().setFromPoints(s),o=new this.THREE.Line(r,e);this.scene.add(o)}}createNodeMarkers(){if(!this.THREE||!this.scene||!this.data)return;const e=new this.THREE.SphereGeometry(.08,16,16);this.data.nodes.forEach((t,i)=>{const s=t.position.y*Math.PI,r=t.position.x*Math.PI*2,o=1.9,h=o*Math.sin(s)*Math.cos(r),a=o*Math.cos(s),l=o*Math.sin(s)*Math.sin(r),d=new this.THREE.Color(t.metadata?.color||"#ffffff"),u=new this.THREE.MeshBasicMaterial({color:d,transparent:!0,opacity:.9}),m=new this.THREE.Mesh(e,u);m.position.set(h,a,l),m.userData={node:t},this.scene.add(m),this.nodeMeshes.set(t.id,m),this.createNodeGlow(m,d)})}createNodeGlow(e,t){if(!this.THREE||!this.scene)return;const i=new this.THREE.SphereGeometry(.12,8,8),s=new this.THREE.MeshBasicMaterial({color:t,transparent:!0,opacity:.3}),r=new this.THREE.Mesh(i,s);r.position.copy(e.position),this.scene.add(r)}setupLighting(){if(!this.THREE||!this.scene)return;const e=new this.THREE.AmbientLight(16777215,.5);this.scene.add(e);const t=new this.THREE.DirectionalLight(16777215,.5);t.position.set(5,5,5),this.scene.add(t)}setActiveNode(e){this.activeNodeId=e}setHighlightedCategory(e){this.nodeMeshes.forEach(t=>{const i=t.userData.node,s=!e||i.category===e;t.material.opacity=s?.9:.2})}setSearchFilter(e){const t=e.toLowerCase();this.nodeMeshes.forEach(i=>{const s=i.userData.node,r=`${s.label} ${s.shortLabel||""} ${s.metadata?.description||""}`.toLowerCase(),o=!t||r.includes(t);i.material.opacity=o?.9:.2})}resize(e,t){this.camera&&this.renderer&&(this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t))}setQualityLevel(e){this.renderer&&this.renderer.setPixelRatio(E(e))}dispose(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.renderer&&(this.renderer.domElement.removeEventListener("mousemove",this.handleMouseMove),this.renderer.domElement.removeEventListener("click",this.handleClick),this.renderer.domElement.removeEventListener("mousedown",this.handleMouseDown),this.renderer.domElement.removeEventListener("mouseup",this.handleMouseUp),this.renderer.domElement.removeEventListener("wheel",this.handleWheel),this.renderer.dispose(),this.container?.removeChild(this.renderer.domElement)),this.nodeMeshes.clear(),this.scene=null,this.camera=null,this.renderer=null}onNodeClick(e){this.onClickCallback=e}onNodeHover(e){this.onHoverCallback=e}getFPS(){return this.fps}}export{D as World3DRenderer};
