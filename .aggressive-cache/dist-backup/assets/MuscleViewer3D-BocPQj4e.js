import{r,m as ke,j as l}from"./react-vendor-D847gc3Q.js";import{b as fe,u as de,C as We}from"./react-three-fiber.esm-BEHpZAxY.js";import{V as B,H as Ie,f as Te,P as me,O as he,a as He,M as _e,C as L}from"./three-vendor-y9bq9ss_.js";import{_ as $e,c as K}from"./recharts-vendor-CxtoZpzE.js";import{a as ce,C as Ae,u as Fe,O as Ve}from"./registry-jDNYOzK3.js";import{a as Le}from"./MuscleViewer-CZj64VIg.js";import"./leaflet-vendor-DZbo3Ov0.js";import"./d3-vendor-mcDw60ct.js";import"./index-CF1yimBQ.js";import"./apollo-vendor-BNHFeEEc.js";import"./reactflow-vendor-CYb5nRwM.js";const N=new B,Y=new B,Ne=new B,le=new Te;function ze(e,s,n){const o=N.setFromMatrixPosition(e.matrixWorld);o.project(s);const i=n.width/2,f=n.height/2;return[o.x*i+i,-(o.y*f)+f]}function De(e,s){const n=N.setFromMatrixPosition(e.matrixWorld),o=Y.setFromMatrixPosition(s.matrixWorld),i=n.sub(o),f=s.getWorldDirection(Ne);return i.angleTo(f)>Math.PI/2}function qe(e,s,n,o){const i=N.setFromMatrixPosition(e.matrixWorld),f=i.clone();f.project(s),le.set(f.x,f.y),n.setFromCamera(le,s);const h=n.intersectObjects(o,!0);if(h.length){const v=h[0].distance;return i.distanceTo(n.ray.origin)<v}return!0}function Ue(e,s){if(s instanceof he)return s.zoom;if(s instanceof me){const n=N.setFromMatrixPosition(e.matrixWorld),o=Y.setFromMatrixPosition(s.matrixWorld),i=s.fov*Math.PI/180,f=n.distanceTo(o);return 1/(2*Math.tan(i/2)*f)}else return 1}function Be(e,s,n){if(s instanceof me||s instanceof he){const o=N.setFromMatrixPosition(e.matrixWorld),i=Y.setFromMatrixPosition(s.matrixWorld),f=o.distanceTo(i),h=(n[1]-n[0])/(s.far-s.near),v=n[1]-h*s.far;return Math.round(h*f+v)}}const X=e=>Math.abs(e)<1e-10?0:e;function pe(e,s,n=""){let o="matrix3d(";for(let i=0;i!==16;i++)o+=X(s[i]*e.elements[i])+(i!==15?",":")");return n+o}const Ze=(e=>s=>pe(s,e))([1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1]),Ge=(e=>(s,n)=>pe(s,e(n),"translate(-50%,-50%)"))(e=>[1/e,1/e,1/e,1,-1/e,-1/e,-1/e,-1,1/e,1/e,1/e,1,1,1,1,1]);function Je(e){return e&&typeof e=="object"&&"current"in e}const xe=r.forwardRef(({children:e,eps:s=.001,style:n,className:o,prepend:i,center:f,fullscreen:h,portal:v,distanceFactor:w,sprite:S=!1,transform:u=!1,occlude:d,onOcclude:P,castShadow:E,receiveShadow:I,material:T,geometry:H,zIndexRange:t=[16777271,0],calculatePosition:a=ze,as:m="div",wrapperClass:j,pointerEvents:_="auto",...y},ee)=>{const{gl:te,camera:p,scene:se,size:g,raycaster:ve,events:ye,viewport:Me}=fe(),[x]=r.useState(()=>document.createElement(m)),Z=r.useRef(),M=r.useRef(null),re=r.useRef(0),z=r.useRef([0,0]),F=r.useRef(null),G=r.useRef(null),$=v?.current||ye.connected||te.domElement.parentNode,R=r.useRef(null),D=r.useRef(!1),q=r.useMemo(()=>d&&d!=="blending"||Array.isArray(d)&&d.length&&Je(d[0]),[d]);r.useLayoutEffect(()=>{const b=te.domElement;d&&d==="blending"?(b.style.zIndex=`${Math.floor(t[0]/2)}`,b.style.position="absolute",b.style.pointerEvents="none"):(b.style.zIndex=null,b.style.position=null,b.style.pointerEvents=null)},[d]),r.useLayoutEffect(()=>{if(M.current){const b=Z.current=ke(x);if(se.updateMatrixWorld(),u)x.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const c=a(M.current,p,g);x.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${c[0]}px,${c[1]}px,0);transform-origin:0 0;`}return $&&(i?$.prepend(x):$.appendChild(x)),()=>{$&&$.removeChild(x),b.unmount()}}},[$,u]),r.useLayoutEffect(()=>{j&&(x.className=j)},[j]);const ne=r.useMemo(()=>u?{position:"absolute",top:0,left:0,width:g.width,height:g.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:f?"translate3d(-50%,-50%,0)":"none",...h&&{top:-g.height/2,left:-g.width/2,width:g.width,height:g.height},...n},[n,f,h,g,u]),Pe=r.useMemo(()=>({position:"absolute",pointerEvents:_}),[_]);r.useLayoutEffect(()=>{if(D.current=!1,u){var b;(b=Z.current)==null||b.render(r.createElement("div",{ref:F,style:ne},r.createElement("div",{ref:G,style:Pe},r.createElement("div",{ref:ee,className:o,style:n,children:e}))))}else{var c;(c=Z.current)==null||c.render(r.createElement("div",{ref:ee,style:ne,className:o,children:e}))}});const A=r.useRef(!0);de(b=>{if(M.current){p.updateMatrixWorld(),M.current.updateWorldMatrix(!0,!1);const c=u?z.current:a(M.current,p,g);if(u||Math.abs(re.current-p.zoom)>s||Math.abs(z.current[0]-c[0])>s||Math.abs(z.current[1]-c[1])>s){const O=De(M.current,p);let C=!1;q&&(Array.isArray(d)?C=d.map(k=>k.current):d!=="blending"&&(C=[se]));const V=A.current;if(C){const k=qe(M.current,p,ve,C);A.current=k&&!O}else A.current=!O;V!==A.current&&(P?P(!A.current):x.style.display=A.current?"block":"none");const U=Math.floor(t[0]/2),we=d?q?[t[0],U]:[U-1,0]:t;if(x.style.zIndex=`${Be(M.current,p,we)}`,u){const[k,ie]=[g.width/2,g.height/2],J=p.projectionMatrix.elements[5]*ie,{isOrthographicCamera:ae,top:je,left:Ce,bottom:Se,right:Ee}=p,Re=Ze(p.matrixWorldInverse),Oe=ae?`scale(${J})translate(${X(-(Ee+Ce)/2)}px,${X((je+Se)/2)}px)`:`translateZ(${J}px)`;let W=M.current.matrixWorld;S&&(W=p.matrixWorldInverse.clone().transpose().copyPosition(W).scale(M.current.scale),W.elements[3]=W.elements[7]=W.elements[11]=0,W.elements[15]=1),x.style.width=g.width+"px",x.style.height=g.height+"px",x.style.perspective=ae?"":`${J}px`,F.current&&G.current&&(F.current.style.transform=`${Oe}${Re}translate(${k}px,${ie}px)`,G.current.style.transform=Ge(W,1/((w||10)/400)))}else{const k=w===void 0?1:Ue(M.current,p)*w;x.style.transform=`translate3d(${c[0]}px,${c[1]}px,0) scale(${k})`}z.current=c,re.current=p.zoom}}if(!q&&R.current&&!D.current)if(u){if(F.current){const c=F.current.children[0];if(c!=null&&c.clientWidth&&c!=null&&c.clientHeight){const{isOrthographicCamera:O}=p;if(O||H)y.scale&&(Array.isArray(y.scale)?y.scale instanceof B?R.current.scale.copy(y.scale.clone().divideScalar(1)):R.current.scale.set(1/y.scale[0],1/y.scale[1],1/y.scale[2]):R.current.scale.setScalar(1/y.scale));else{const C=(w||10)/400,V=c.clientWidth*C,U=c.clientHeight*C;R.current.scale.set(V,U,1)}D.current=!0}}}else{const c=x.children[0];if(c!=null&&c.clientWidth&&c!=null&&c.clientHeight){const O=1/Me.factor,C=c.clientWidth*O,V=c.clientHeight*O;R.current.scale.set(C,V,1),D.current=!0}R.current.lookAt(b.camera.position)}});const oe=r.useMemo(()=>({vertexShader:u?void 0:`
          /*
            This shader is from the THREE's SpriteMaterial.
            We need to turn the backing plane into a Sprite
            (make it always face the camera) if "transfrom"
            is false.
          */
          #include <common>

          void main() {
            vec2 center = vec2(0., 1.);
            float rotation = 0.0;

            // This is somewhat arbitrary, but it seems to work well
            // Need to figure out how to derive this dynamically if it even matters
            float size = 0.03;

            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
            vec2 scale;
            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );

            bool isPerspective = isPerspectiveMatrix( projectionMatrix );
            if ( isPerspective ) scale *= - mvPosition.z;

            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;
            vec2 rotatedPosition;
            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
            mvPosition.xy += rotatedPosition;

            gl_Position = projectionMatrix * mvPosition;
          }
      `,fragmentShader:`
        void main() {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        }
      `}),[u]);return r.createElement("group",$e({},y,{ref:M}),d&&!q&&r.createElement("mesh",{castShadow:E,receiveShadow:I,ref:R},H||r.createElement("planeGeometry",null),T||r.createElement("shaderMaterial",{side:Ie,vertexShader:oe.vertexShader,fragmentShader:oe.fragmentShader})))}),ge={front:{position:[0,0,3],target:[0,0,0]},back:{position:[0,0,-3],target:[0,0,0]},left:{position:[-3,0,0],target:[0,0,0]},right:{position:[3,0,0],target:[0,0,0]},isometric:{position:[2,1.5,2.5],target:[0,0,0]}},be={chest:["pectoralis major","pectoralis minor"],abs:["rectus abdominis","abdomin"],obliques:["oblique","external oblique","internal oblique"],front_delts:["deltoid","anterior deltoid"],upper_back:["rhomboid","trapezius"],lats:["latissimus"],lower_back:["erector","quadratus lumborum"],rear_delts:["posterior deltoid"],traps:["trapezius"],biceps:["biceps"],triceps:["triceps"],forearms:["brachioradialis","flexor","extensor","pronator"],side_delts:["lateral deltoid","middle deltoid"],quads:["quadriceps","rectus femoris","vastus"],hip_flexors:["iliopsoas","psoas","iliacus"],adductors:["adductor"],glutes:["gluteus","gluteal"],hamstrings:["hamstring","biceps femoris","semitendinosus","semimembranosus"],calves:["gastrocnemius","soleus","calf"]};function ue(e){if(e<=0)return new L(.5,.3,.3);if(e<.25){const s=e*4;return new L(.2,.2+s*.5,.8)}else if(e<.5){const s=(e-.25)*4;return new L(s,.7,.8-s*.8)}else if(e<.75){const s=(e-.5)*4;return new L(1,.7-s*.3,0)}else{const s=(e-.75)*4;return new L(1,.4-s*.4,0)}}function Q(e,s){const n=be[s];if(!n)return!1;const o=e.toLowerCase();return n.some(i=>o.includes(i.toLowerCase()))}function Ke({filePath:e,muscles:s,autoRotate:n,interactive:o,showLabels:i,onMeshClick:f,onMeshHover:h}){const v=r.useRef(null),w=r.useRef(new Map),S=r.useRef(new Map),[u,d]=r.useState(null),{scene:P}=Fe(e),E=r.useMemo(()=>{const t={};return s.forEach(({id:a,intensity:m,isPrimary:j})=>{const _=j!==!1?m:m*.5;t[a]=Math.max(t[a]||0,_)}),t},[s]);r.useEffect(()=>{P&&(w.current.clear(),S.current.clear(),P.traverse(t=>{if(t instanceof He&&t.name&&(w.current.set(t.name,t),t.material instanceof _e)){const a=t.material.clone();a.transparent=!0,a.roughness=.6,a.metalness=.1,t.material=a,S.current.set(t.name,a)}}))},[P]),r.useEffect(()=>{S.current.forEach((t,a)=>{let m=0;Object.entries(E).forEach(([_,y])=>{Q(a,_)&&y>m&&(m=y)});const j=ue(m);t.color.copy(j),m>.3?(t.emissive.copy(j),t.emissiveIntensity=m*.3):(t.emissive.setHex(0),t.emissiveIntensity=0),t.opacity=m>0?.85+m*.15:.7,t.needsUpdate=!0})},[E]),r.useEffect(()=>{if(!u)return;const t=S.current.get(u);return t&&(t.emissive.setHex(4491519),t.emissiveIntensity=.4,t.needsUpdate=!0),()=>{if(t){let a=0;if(Object.entries(E).forEach(([m,j])=>{Q(u,m)&&(a=Math.max(a,j))}),a>.3){const m=ue(a);t.emissive.copy(m),t.emissiveIntensity=a*.3}else t.emissive.setHex(0),t.emissiveIntensity=0;t.needsUpdate=!0}}},[u,E]),de((t,a)=>{n&&v.current&&(v.current.rotation.y+=a*.15)});const I=r.useCallback(t=>{if(!o)return;t.stopPropagation();const a=t.object;a.name&&(d(a.name),h?.(a.name),document.body.style.cursor="pointer")},[o,h]),T=r.useCallback(()=>{o&&(d(null),h?.(null),document.body.style.cursor="auto")},[o,h]),H=r.useCallback(t=>{if(!o)return;t.stopPropagation();const a=t.object;a.name&&Object.keys(be).forEach(m=>{Q(a.name,m)&&f?.(m)})},[o,f]);return l.jsxs("group",{ref:v,children:[l.jsx("primitive",{object:P,scale:.01,position:[0,-1,0],onPointerOver:I,onPointerOut:T,onClick:H}),i&&u&&l.jsx(xe,{position:[0,1.5,0],center:!0,children:l.jsx("div",{className:"px-2 py-1 bg-black/80 text-white text-xs rounded whitespace-nowrap",children:u.replace(/\.[lr]$/,"").replace(/_/g," ")})})]})}function Qe({view:e,interactive:s}){const{camera:n}=fe(),o=r.useRef(null);return r.useEffect(()=>{const i=ge[e];i&&(n.position.set(...i.position),n.lookAt(...i.target))},[e,n]),l.jsx(Ve,{ref:o,enabled:s,enablePan:!1,minDistance:1.5,maxDistance:6,minPolarAngle:Math.PI*.1,maxPolarAngle:Math.PI*.9})}function Xe(){return l.jsx(xe,{center:!0,children:l.jsx(Le,{mode:"inline"})})}function ut({muscles:e,mode:s="card",interactive:n=!0,showLabels:o=!0,autoRotate:i=!1,initialView:f="front",colorScheme:h="heatmap",lod:v,onMuscleClick:w,onMuscleHover:S,className:u,style:d}){const[P,E]=r.useState(f),I=ce.getAsset("male_muscles"),T=I?ce.getFilePath(I,v):null;if(!T)return l.jsx("div",{className:K("flex items-center justify-center bg-[var(--void-deep,#0a0f1a)]",u),style:d,children:l.jsx("p",{className:"text-[var(--text-tertiary,#94a3b8)] text-sm",children:"Model not available"})});const H={compact:{width:120,height:160},card:{width:200,height:280},fullscreen:{width:"100%",height:"100%",minHeight:400},inline:{width:80,height:100}};return l.jsxs("div",{className:K("relative rounded-xl overflow-hidden","bg-gradient-to-b from-[var(--void-deep,#0a0f1a)] to-[var(--void-deeper,#050810)]",u),style:{...H[s],...d},children:[l.jsxs(We,{camera:{position:ge[P].position,fov:45},dpr:[1,2],gl:{antialias:!0,alpha:!0,powerPreference:"high-performance"},onCreated:({gl:t})=>{t.setClearColor(0,0)},children:[l.jsx("ambientLight",{intensity:.4}),l.jsx("directionalLight",{position:[5,5,5],intensity:.7}),l.jsx("directionalLight",{position:[-5,5,-5],intensity:.3}),l.jsx("pointLight",{position:[0,10,0],intensity:.2,color:"#4488ff"}),l.jsxs(r.Suspense,{fallback:l.jsx(Xe,{}),children:[l.jsx(Ke,{filePath:T,muscles:e,autoRotate:i,interactive:n,showLabels:o,onMeshClick:w,onMeshHover:S}),l.jsx(Ae,{position:[0,-1.5,0],opacity:.3,scale:8,blur:2,color:"#000020"})]}),l.jsx(Qe,{view:P,interactive:n})]}),(s==="card"||s==="fullscreen")&&n&&l.jsx("div",{className:"absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1",children:["front","back","left","right"].map(t=>l.jsx("button",{onClick:()=>E(t),className:K("px-2 py-1 text-xs rounded transition-colors",P===t?"bg-[var(--electric-blue,#0066ff)] text-white":"bg-white/10 text-white/70 hover:bg-white/20"),children:t.charAt(0).toUpperCase()+t.slice(1)},t))})]})}export{ut as MuscleViewer3D,ut as default};
