<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brave Minimal Test</title>
  <style>
    body {
      font-family: -apple-system, system-ui, sans-serif;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    .result {
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
    }
    .pass { background: #1e3a2f; color: #4ade80; }
    .fail { background: #3a1e1e; color: #f87171; }
    .info { background: #1e2a3a; color: #60a5fa; }
    pre {
      background: #0a0a0f;
      padding: 10px;
      border-radius: 4px;
      overflow: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>Brave Minimal Test</h1>
  <p>Testing what Brave Shields blocks before loading any modules.</p>
  <div id="results"></div>

  <script>
    // This runs BEFORE any modules load
    const results = document.getElementById('results');

    function log(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = 'result ' + type;
      div.textContent = msg;
      results.appendChild(div);
    }

    // Test 1: Basic JavaScript works
    log('✓ Basic JavaScript: Working', 'pass');

    // Test 2: localStorage
    try {
      localStorage.setItem('_test', '1');
      localStorage.removeItem('_test');
      log('✓ localStorage: Working', 'pass');
    } catch (e) {
      log('✗ localStorage: ' + e.message, 'fail');
    }

    // Test 3: sessionStorage
    try {
      sessionStorage.setItem('_test', '1');
      sessionStorage.removeItem('_test');
      log('✓ sessionStorage: Working', 'pass');
    } catch (e) {
      log('✗ sessionStorage: ' + e.message, 'fail');
    }

    // Test 4: indexedDB existence (just checking if the variable exists)
    try {
      if (typeof indexedDB === 'undefined') {
        log('✗ indexedDB: undefined (blocked)', 'fail');
      } else if (indexedDB === null) {
        log('✗ indexedDB: null (blocked)', 'fail');
      } else {
        log('✓ indexedDB: Variable exists', 'pass');
      }
    } catch (e) {
      log('✗ indexedDB: ReferenceError - ' + e.message, 'fail');
    }

    // Test 5: Try to access indexedDB.open
    try {
      const req = indexedDB.open('_test_db', 1);
      req.onerror = () => log('✗ indexedDB.open: Error opening', 'fail');
      req.onsuccess = () => {
        log('✓ indexedDB.open: Working', 'pass');
        req.result.close();
        indexedDB.deleteDatabase('_test_db');
      };
      req.onblocked = () => log('⚠ indexedDB.open: Blocked', 'fail');
    } catch (e) {
      log('✗ indexedDB.open: ' + e.message, 'fail');
    }

    // Test 6: IDBDatabase class existence
    try {
      if (typeof IDBDatabase === 'undefined') {
        log('✗ IDBDatabase: undefined', 'fail');
      } else {
        log('✓ IDBDatabase: Class exists', 'pass');
      }
    } catch (e) {
      log('✗ IDBDatabase: ReferenceError - ' + e.message, 'fail');
    }

    // Test 7: IDBFactory class
    try {
      if (typeof IDBFactory === 'undefined') {
        log('✗ IDBFactory: undefined', 'fail');
      } else {
        log('✓ IDBFactory: Class exists', 'pass');
      }
    } catch (e) {
      log('✗ IDBFactory: ReferenceError - ' + e.message, 'fail');
    }

    // Test 8: Dynamic import
    async function testDynamicImport() {
      try {
        // Try to dynamically import a module
        const mod = await import('/assets/react-vendor-D1NxaRNd.js');
        log('✓ Dynamic import: Working (got ' + Object.keys(mod).length + ' exports)', 'pass');
      } catch (e) {
        log('✗ Dynamic import: ' + e.message, 'fail');
      }
    }
    testDynamicImport();

    // Test 9: Fetch
    fetch('/health')
      .then(r => r.json())
      .then(d => log('✓ Fetch: Working - ' + d.status, 'pass'))
      .catch(e => log('✗ Fetch: ' + e.message, 'fail'));

    // Test 10: Check navigator.storage
    try {
      if (navigator.storage?.estimate) {
        navigator.storage.estimate()
          .then(est => log('✓ navigator.storage: ' + Math.round(est.usage/1024) + 'KB used', 'pass'))
          .catch(e => log('✗ navigator.storage.estimate: ' + e.message, 'fail'));
      } else {
        log('⚠ navigator.storage: Not available', 'info');
      }
    } catch (e) {
      log('✗ navigator.storage: ' + e.message, 'fail');
    }

    // Test 11: Check service worker
    try {
      if ('serviceWorker' in navigator) {
        log('✓ ServiceWorker: Available', 'pass');
      } else {
        log('⚠ ServiceWorker: Not available', 'info');
      }
    } catch (e) {
      log('✗ ServiceWorker: ' + e.message, 'fail');
    }

    // Test 12: Web Crypto
    try {
      if (crypto.subtle) {
        log('✓ Web Crypto: Available', 'pass');
      } else {
        log('⚠ Web Crypto: crypto.subtle not available', 'info');
      }
    } catch (e) {
      log('✗ Web Crypto: ' + e.message, 'fail');
    }

    // Log user agent
    const pre = document.createElement('pre');
    pre.textContent = 'User Agent: ' + navigator.userAgent;
    results.appendChild(pre);
  </script>
</body>
</html>
