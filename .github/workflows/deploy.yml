name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run on main branch pushes (not PR merges that haven't completed)
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 72.62.83.202
          username: root
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            set -e
            cd /var/www/musclemap.me

            echo "üîÑ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "üì¶ Installing dependencies..."
            pnpm install --frozen-lockfile 2>/dev/null || pnpm install

            echo "üî® Building shared packages..."
            pnpm build:packages 2>/dev/null || true

            echo "üî® Building client package..."
            pnpm -C packages/client build 2>/dev/null || true

            echo "üî® Building frontend..."
            pnpm build

            echo "üî® Building API..."
            pnpm build:api 2>/dev/null || true

            echo "üîÑ Restarting services..."
            pm2 restart all --update-env 2>/dev/null || pm2 start ecosystem.config.js 2>/dev/null || true

            echo "‚úÖ Deployment complete!"

      - name: Verify Deployment
        run: |
          sleep 10
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://musclemap.me)
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Site is live (HTTP $HTTP_STATUS)"
          else
            echo "‚ö†Ô∏è Site returned HTTP $HTTP_STATUS"
            exit 1
          fi

      - name: Notify Success
        if: success()
        run: |
          echo "üöÄ Deployment successful!"
          echo "Commit: ${{ github.sha }}"
          echo "URL: https://musclemap.me"
